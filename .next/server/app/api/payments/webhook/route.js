(()=>{var e={};e.id=1004,e.ids=[1004],e.modules={20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},22037:e=>{"use strict";e.exports=require("os")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},76224:e=>{"use strict";e.exports=require("tty")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},56804:()=>{},68645:()=>{},83302:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>q,patchFetch:()=>k,requestAsyncStorage:()=>w,routeModule:()=>f,serverHooks:()=>x,staticGenerationAsyncStorage:()=>g});var a={};r.r(a),r.d(a,{POST:()=>y});var o=r(49303),s=r(88716),i=r(60670),n=r(87070),u=r(20728),c=r(6113),d=r.n(c),p=r(60836),l=r(64284);async function m(e){let t=await u.Z.message.create({data:e,include:{contact:!0}});return l.E()?.emit("newMessage",t),t}async function h(e){let t=await u.Z.settings.findUnique({where:{userId:e}});return t?.whatsappAccessToken&&t.whatsappPhoneNumberId?{token:t.whatsappAccessToken,phoneId:t.whatsappPhoneNumberId}:null}async function y(e){try{let t=process.env.RAZORPAY_WEBHOOK_SECRET,r=await e.text(),a=e.headers.get("x-razorpay-signature");if(!a)return console.warn("Webhook received without signature."),n.NextResponse.json({error:"Missing signature"},{status:400});if(d().createHmac("sha256",t).update(r).digest("hex")!==a)return console.error("Webhook received with invalid signature."),n.NextResponse.json({error:"Invalid signature"},{status:400});let o=JSON.parse(r);if("payment_link.paid"===o.event){let e=o.payload.payment_link.entity,t=e.notes,r=e.amount/100,a=o.payload.payment.entity.id;if(t?.quotation_id){let e=await u.Z.quotation.findUnique({where:{id:t.quotation_id},include:{contact:!0}});if(!e)return console.log(`Webhook: Quotation ID ${t.quotation_id} not found.`),n.NextResponse.json({success:!0,message:"Quotation not found."});await u.Z.payment.create({data:{quotationId:e.id,amount:r,status:"PAID",method:"razorpay",razorpayPaymentId:a}});let o=(await u.Z.payment.findMany({where:{quotationId:e.id,status:"PAID"}})).reduce((e,t)=>e+t.amount,0)>=e.total?"PAID":"PARTIALLY_PAID",s=await u.Z.quotation.update({where:{id:e.id},data:{status:o},include:{payments:!0}}),i=await h(e.userId);if(i){let t=`✅ Payment Received! We have received your payment of ₹${r.toLocaleString("en-IN")} for Quotation #${e.id.substring(0,6)}. Thank you!`,a=await (0,p.U3)(e.contact.phone,t,i),o=a?.messages?.[0]?.id;await m({from:"business",to:e.contact.phone,type:"text",text:t,contactId:e.contact.id,wamid:o,status:o?"sent":"failed"})}l.E()?.emit("quotation_update",s)}else if(t?.order_id){let e=await u.Z.order.findUnique({where:{id:t.order_id},include:{contact:!0}});if(!e)return console.log(`Webhook: Order ID ${t.order_id} not found.`),n.NextResponse.json({success:!0,message:"Order not found."});await u.Z.payment.create({data:{orderId:e.id,amount:r,status:"PAID",method:"razorpay",razorpayPaymentId:a}});let o=(await u.Z.payment.findMany({where:{orderId:e.id,status:"PAID"}})).reduce((e,t)=>e+t.amount,0)>=e.total?"PAID":"PARTIALLY_PAID",s=await u.Z.order.update({where:{id:e.id},data:{paymentStatus:o},include:{payments:!0,items:!0,contact:!0}}),i=await h(e.userId);if(i){let t=`✅ Payment Received! We have received your payment of ₹${r.toLocaleString("en-IN")} for Order #${e.id.substring(0,6)}. Thank you!`,a=await (0,p.U3)(e.contact.phone,t,i),o=a?.messages?.[0]?.id;await m({from:"business",to:e.contact.phone,type:"text",text:t,contactId:e.contact.id,wamid:o,status:o?"sent":"failed"})}l.E()?.emit("order_update",s)}}return n.NextResponse.json({success:!0})}catch(e){return console.error("❌ Razorpay webhook error:",e),n.NextResponse.json({error:"Webhook failed"},{status:500})}}let f=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/payments/webhook/route",pathname:"/api/payments/webhook",filename:"route",bundlePath:"app/api/payments/webhook/route"},resolvedPagePath:"C:\\vyaparconnect-crm\\src\\app\\api\\payments\\webhook\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:w,staticGenerationAsyncStorage:g,serverHooks:x}=f,q="/api/payments/webhook/route";function k(){return(0,i.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:g})}},20728:(e,t,r)=>{"use strict";r.d(t,{Z:()=>o});let a=require("@prisma/client"),o=globalThis.prisma||new a.PrismaClient},64284:(e,t,r)=>{"use strict";function a(){return globalThis.io}r.d(t,{E:()=>a}),r(83861)},60836:(e,t,r)=>{"use strict";r.d(t,{U3:()=>s,eG:()=>n,xN:()=>i});let a=e=>new Promise(t=>setTimeout(t,e));async function o(e,t,r){let o=`https://graph.facebook.com/v20.0/${r}/messages`,s={method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(e)};for(let e=1;e<=3;e++)try{let t=await fetch(o,s);if(t.ok)return await t.json();let r=await t.json().catch(()=>({}));if(console.error(`Attempt ${e}/3 failed with status ${t.status}:`,JSON.stringify(r)),t.status>=400&&t.status<500)return console.error("Client error, not retrying."),null;if(e<3){let t=1e3*Math.pow(2,e-1);console.log(`Retrying in ${t}ms...`),await a(t)}}catch(t){if(console.error(`Attempt ${e}/3 failed with network error:`,t),e<3){let t=1e3*Math.pow(2,e-1);console.log(`Retrying in ${t}ms...`),await a(t)}}return console.error("Failed to send message after 3 attempts."),null}async function s(e,t,r,a){let s={messaging_product:"whatsapp",recipient_type:"individual",to:e,type:"text",text:{body:t}};return a&&(s.context={message_id:a}),o(s,r.token,r.phoneId)}async function i(e,t,r,a,s){let i={link:t};r&&r.trim()&&(i.caption=r);let n={messaging_product:"whatsapp",recipient_type:"individual",to:e,type:"image",image:i};return s&&(n.context={message_id:s}),o(n,a.token,a.phoneId)}async function n(e,t,r,a,s,i){let n={messaging_product:"whatsapp",recipient_type:"individual",to:e,type:"document",document:{link:t,caption:r,filename:a}};return i&&(n.context={message_id:i}),o(n,s.token,s.phoneId)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,3861],()=>r(83302));module.exports=a})();