"use strict";(()=>{var e={};e.id=1004,e.ids=[1004],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},83302:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>v,patchFetch:()=>x,requestAsyncStorage:()=>f,routeModule:()=>w,serverHooks:()=>k,staticGenerationAsyncStorage:()=>g});var n={};a.r(n),a.d(n,{POST:()=>y});var o=a(49303),r=a(88716),i=a(60670),s=a(87070),d=a(20728),u=a(6113),c=a.n(u),p=a(60836),l=a(21178);async function m(e){let t=await d.Z.message.create({data:e,include:{contact:!0}});return await (0,l.F)("newMessage",t),t}async function h(e){let t=await d.Z.settings.findUnique({where:{userId:e}});return t?.whatsappAccessToken&&t.whatsappPhoneNumberId?{token:t.whatsappAccessToken,phoneId:t.whatsappPhoneNumberId}:null}async function y(e){try{let t=process.env.RAZORPAY_WEBHOOK_SECRET,a=await e.text(),n=e.headers.get("x-razorpay-signature");if(!n)return console.warn("Webhook received without signature."),s.NextResponse.json({error:"Missing signature"},{status:400});if(c().createHmac("sha256",t).update(a).digest("hex")!==n)return console.error("Webhook received with invalid signature."),s.NextResponse.json({error:"Invalid signature"},{status:400});let o=JSON.parse(a);if("payment_link.paid"===o.event){let e=o.payload.payment_link.entity,t=e.notes,a=e.amount/100,n=o.payload.payment.entity.id;if(t?.quotation_id){let e=await d.Z.quotation.findUnique({where:{id:t.quotation_id},include:{contact:!0}});if(!e)return console.log(`Webhook: Quotation ID ${t.quotation_id} not found.`),s.NextResponse.json({success:!0,message:"Quotation not found."});await d.Z.payment.create({data:{quotationId:e.id,amount:a,status:"PAID",method:"razorpay",razorpayPaymentId:n}});let o=(await d.Z.payment.findMany({where:{quotationId:e.id,status:"PAID"}})).reduce((e,t)=>e+t.amount,0)>=e.total?"PAID":"PARTIALLY_PAID",r=await d.Z.quotation.update({where:{id:e.id},data:{status:o},include:{payments:!0}}),i=await h(e.userId);if(i){let t=`✅ Payment Received! We have received your payment of ₹${a.toLocaleString("en-IN")} for Quotation #${e.id.substring(0,6)}. Thank you!`,n=await (0,p.U3)(e.contact.phone,t,i),o=n?.messages?.[0]?.id;await m({from:"business",to:e.contact.phone,type:"text",text:t,contactId:e.contact.id,wamid:o,status:o?"sent":"failed"})}await (0,l.F)("quotation_update",r)}else if(t?.order_id){let e=await d.Z.order.findUnique({where:{id:t.order_id},include:{contact:!0}});if(!e)return console.log(`Webhook: Order ID ${t.order_id} not found.`),s.NextResponse.json({success:!0,message:"Order not found."});await d.Z.payment.create({data:{orderId:e.id,amount:a,status:"PAID",method:"razorpay",razorpayPaymentId:n}});let o=(await d.Z.payment.findMany({where:{orderId:e.id,status:"PAID"}})).reduce((e,t)=>e+t.amount,0)>=e.total?"PAID":"PARTIALLY_PAID",r=await d.Z.order.update({where:{id:e.id},data:{paymentStatus:o},include:{payments:!0,items:!0,contact:!0}}),i=await h(e.userId);if(i){let t=`✅ Payment Received! We have received your payment of ₹${a.toLocaleString("en-IN")} for Order #${e.id.substring(0,6)}. Thank you!`,n=await (0,p.U3)(e.contact.phone,t,i),o=n?.messages?.[0]?.id;await m({from:"business",to:e.contact.phone,type:"text",text:t,contactId:e.contact.id,wamid:o,status:o?"sent":"failed"})}await (0,l.F)("order_update",r)}}return s.NextResponse.json({success:!0})}catch(e){return console.error("❌ Razorpay webhook error:",e),s.NextResponse.json({error:"Webhook failed"},{status:500})}}let w=new o.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/payments/webhook/route",pathname:"/api/payments/webhook",filename:"route",bundlePath:"app/api/payments/webhook/route"},resolvedPagePath:"C:\\vyaparconnect-crm\\src\\app\\api\\payments\\webhook\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:k}=w,v="/api/payments/webhook/route";function x(){return(0,i.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:g})}},20728:(e,t,a)=>{a.d(t,{Z:()=>o});let n=require("@prisma/client"),o=globalThis.prisma||new n.PrismaClient},21178:(e,t,a)=>{a.d(t,{F:()=>n});async function n(e,t){let a=process.env.SOCKET_SERVER_URL,n=process.env.SOCKET_EMITTER_SECRET;if(!a||!n){console.error("Socket emitter URL or secret is not configured on the server. Real-time events will not be sent.");return}try{fetch(`${a}/emit`,{method:"POST",headers:{"Content-Type":"application/json","x-emitter-secret":n},body:JSON.stringify({event:e,data:t})})}catch(e){console.error("Failed to emit socket event:",e)}}},60836:(e,t,a)=>{a.d(t,{U3:()=>r,eG:()=>s,xN:()=>i});let n=e=>new Promise(t=>setTimeout(t,e));async function o(e,t,a){let o=`https://graph.facebook.com/v20.0/${a}/messages`,r={method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(e)};for(let e=1;e<=3;e++)try{let t=await fetch(o,r);if(t.ok)return await t.json();let a=await t.json().catch(()=>({}));if(console.error(`Attempt ${e}/3 failed with status ${t.status}:`,JSON.stringify(a)),t.status>=400&&t.status<500)return console.error("Client error, not retrying."),null;if(e<3){let t=1e3*Math.pow(2,e-1);console.log(`Retrying in ${t}ms...`),await n(t)}}catch(t){if(console.error(`Attempt ${e}/3 failed with network error:`,t),e<3){let t=1e3*Math.pow(2,e-1);console.log(`Retrying in ${t}ms...`),await n(t)}}return console.error("Failed to send message after 3 attempts."),null}async function r(e,t,a,n){let r={messaging_product:"whatsapp",recipient_type:"individual",to:e,type:"text",text:{body:t}};return n&&(r.context={message_id:n}),o(r,a.token,a.phoneId)}async function i(e,t,a,n,r){let i={link:t};a&&a.trim()&&(i.caption=a);let s={messaging_product:"whatsapp",recipient_type:"individual",to:e,type:"image",image:i};return r&&(s.context={message_id:r}),o(s,n.token,n.phoneId)}async function s(e,t,a,n,r,i){let s={messaging_product:"whatsapp",recipient_type:"individual",to:e,type:"document",document:{link:t,caption:a,filename:n}};return i&&(s.context={message_id:i}),o(s,r.token,r.phoneId)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[8948,5972],()=>a(83302));module.exports=n})();