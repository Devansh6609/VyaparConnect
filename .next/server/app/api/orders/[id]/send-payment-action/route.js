"use strict";(()=>{var e={};e.id=1661,e.ids=[1661],e.modules={67096:e=>{e.exports=require("bcrypt")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78018:e=>{e.exports=require("puppeteer")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},63477:e=>{e.exports=require("querystring")},12781:e=>{e.exports=require("stream")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},35364:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>$,patchFetch:()=>I,requestAsyncStorage:()=>x,routeModule:()=>w,serverHooks:()=>v,staticGenerationAsyncStorage:()=>k});var a={};r.r(a),r.d(a,{POST:()=>b});var o=r(49303),i=r(88716),n=r(60670),s=r(87070),d=r(20728),l=r(21178),c=r(60836),p=r(41212),u=r.n(p),m=r(71597),g=r.n(m),h=r(95456);async function y(e,t){let r=await d.Z.message.create({data:{...e,status:"pending"},include:{contact:!0}});await (0,l.F)("newMessage",r);let a=await t(),o=a?.messages?.[0]?.id,i=o?"sent":"failed",n=await d.Z.message.update({where:{id:r.id},data:{wamid:o,status:i}});if(await (0,l.F)("message-status-update",{id:n.id,status:i,wamid:o}),!o)throw Error("Failed to send message via WhatsApp.")}async function f(e,t,r,a,o){let i=t.payments.reduce((e,t)=>e+t.amount,0),n=t.total-i;switch(e){case"send_bill_image":{let e=function(e,t){let r=e.items.reduce((e,t)=>e+t.price*Number(t.quantity||1),0),a=r*(e.discountPercentage||0)/100;return`
      <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; width: 600px; background-color: #f9f9f9; color: #333; }
            .container { border: 1px solid #eee; background-color: white; padding: 30px; border-radius: 8px; }
            .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; }
            .company-details { font-size: 12px; color: #555; }
            .bill-details { text-align: right; font-size: 12px; }
            .table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
            .table th, .table td { border-bottom: 1px solid #e2e8f0; padding: 10px; text-align: left; }
            .table th { background-color: #f7fafc; font-weight: bold; }
            .totals { float: right; width: 50%; margin-top: 20px; font-size: 14px; }
            .totals div { display: flex; justify-content: space-between; padding: 5px 0; }
            .grand-total { font-size: 18px; font-weight: bold; border-top: 2px solid #333; margin-top: 5px; }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <div>
                ${t?.companyLogoUrl?`<img src="${t.companyLogoUrl}" alt="logo" style="max-width: 150px; margin-bottom: 10px;"/>`:""}
                <div class="company-details">
                  <strong>${t?.companyName||"Your Company"}</strong><br/>
                  ${t?.companyAddress?.replace(/\n/g,"<br/>")||""}
                </div>
              </div>
              <div class="bill-details">
                <h2>INVOICE</h2>
                <strong>Bill to:</strong> ${e.customerName}<br/>
                <strong>Order ID:</strong> #${e.id.substring(0,6)}<br/>
                <strong>Date:</strong> ${new Date(e.createdAt).toLocaleDateString()}
              </div>
            </div>
            <table class="table">
              <thead><tr><th>Item</th><th style="text-align:center;">Qty</th><th style="text-align:right;">Price</th></tr></thead>
              <tbody>
                ${e.items.map(e=>`
                  <tr>
                    <td>${e.productName}</td>
                    <td style="text-align:center;">${e.quantity}</td>
                    <td style="text-align:right;">₹${e.price.toFixed(2)}</td>
                  </tr>`).join("")}
              </tbody>
            </table>
            <div class="totals">
              <div><span>Subtotal</span><span>₹${r.toFixed(2)}</span></div>
              ${e.discountPercentage?`<div><span>Discount (${e.discountPercentage}%)</span><span>- ₹${a.toFixed(2)}</span></div>`:""}
              ${e.deliveryCharges?`<div><span>Delivery</span><span>+ ₹${e.deliveryCharges.toFixed(2)}</span></div>`:""}
              <div class="grand-total"><span>Grand Total</span><span>₹${e.total.toFixed(2)}</span></div>
            </div>
          </div>
        </body>
      </html>`}(t,r),o=await g()({html:e,puppeteerArgs:{args:["--no-sandbox"]}}),i="ce388deb1931d0d58b9e876d99c2b152";if(!i)throw Error("Server configuration error: ImgBB API key is not set.");let n=new FormData;n.append("image",o.toString("base64"));let s=await fetch(`https://api.imgbb.com/1/upload?key=${i}`,{method:"POST",body:n}),d=await s.json();if(!s.ok)throw Error("Failed to upload bill image.");let l=d.data.url,p=`Hi ${t.customerName}, please find your order bill attached.`;await y({from:"business",to:t.contact.phone,type:"image",text:p,mediaUrl:l,contactId:t.contact.id},()=>(0,c.xN)(t.contact.phone,l,p,a));break}case"send_razorpay":{if(!r?.razorpayKeyId||!r?.razorpayKeySecret)throw Error("Razorpay API keys are not configured.");if(n<=0)throw Error("The bill is already paid in full.");let e=new(u())({key_id:r.razorpayKeyId,key_secret:r.razorpayKeySecret}),o=await e.paymentLink.create({amount:Math.round(100*n),currency:"INR",description:`Payment for Order #${t.id.substring(0,6)}`,customer:{name:t.customerName,contact:t.contactNumber.replace("+","")},notify:{sms:!0,email:!1},reminder_enable:!0,notes:{order_id:t.id},callback_url:"https://e3e2fbab318c.ngrok-free.app/orders",callback_method:"get"}),i=`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(o.short_url)}`,s=await fetch(i);if(!s.ok)throw Error("Failed to generate QR code image.");let d=await s.blob(),l="ce388deb1931d0d58b9e876d99c2b152";if(!l)throw Error("Server configuration error: ImgBB API key is not set.");let p=new FormData;p.append("image",d,"razorpay-qr.png");let m=await fetch(`https://api.imgbb.com/1/upload?key=${l}`,{method:"POST",body:p}),g=await m.json();if(!m.ok||!g.data?.url)throw console.error("ImgBB upload failed for QR code:",g),Error("Failed to upload QR code image.");let h=g.data.url,f=`Thank you for your order! Amount due: *₹${n.toFixed(2)}*. 

Please scan the QR code to pay or click the link below:
${o.short_url}`;await y({from:"business",to:t.contact.phone,type:"image",text:f,mediaUrl:h,contactId:t.contact.id},()=>(0,c.xN)(t.contact.phone,h,f,a));break}case"send_bank_details":{let e=r?.bankName&&r?.bankAccountNumber&&r?.bankIfscCode?`Bank Name: ${r.bankName}
Account No: ${r.bankAccountNumber}
IFSC Code: ${r.bankIfscCode}`:null;if(!e)throw Error("Bank details are not fully configured in settings.");if(n<=0)throw Error("The bill is already paid in full.");let o=`A friendly reminder for your payment. The amount due is *₹${n.toFixed(2)}*. 

You can pay via bank transfer to:

${e}`;await y({from:"business",to:t.contact.phone,type:"text",text:o,contactId:t.contact.id},()=>(0,c.U3)(t.contact.phone,o,a));break}case"send_qr_code":{if(!r?.upiQrCodeUrl)throw Error("UPI QR Code URL is not configured in settings.");if(n<=0)throw Error("The bill is already paid in full.");let e=`Please scan this QR code to pay the remaining balance of *₹${n.toFixed(2)}*.`;await y({from:"business",to:t.contact.phone,type:"image",text:e,mediaUrl:r.upiQrCodeUrl,contactId:t.contact.id},()=>(0,c.xN)(t.contact.phone,r.upiQrCodeUrl,e,a));break}default:throw Error("Invalid action specified.")}}async function b(e,t){let r=await (0,h.P)();if(!r?.user?.id)return s.NextResponse.json({error:"Not authenticated"},{status:401});let{id:a}=await t.params;try{let{action:t,amount:o}=await e.json(),i=await d.Z.order.findFirst({where:{id:a,userId:r.user.id},include:{contact:!0,items:!0,payments:!0}});if(!i)return s.NextResponse.json({error:"Order not found"},{status:404});let n=await d.Z.settings.findUnique({where:{userId:i.userId}}),l=n?.whatsappAccessToken&&n?.whatsappPhoneNumberId?{token:n.whatsappAccessToken,phoneId:n.whatsappPhoneNumberId}:null;if(!l)throw Error("WhatsApp API credentials are not configured.");return await f(t,i,n,l,o),s.NextResponse.json({success:!0})}catch(e){return console.error(`Failed to perform action for order ${a}:`,e),s.NextResponse.json({error:e.message||"Failed to perform action"},{status:500})}}let w=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/orders/[id]/send-payment-action/route",pathname:"/api/orders/[id]/send-payment-action",filename:"route",bundlePath:"app/api/orders/[id]/send-payment-action/route"},resolvedPagePath:"C:\\vyaparconnect-crm\\src\\app\\api\\orders\\[id]\\send-payment-action\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:x,staticGenerationAsyncStorage:k,serverHooks:v}=w,$="/api/orders/[id]/send-payment-action/route";function I(){return(0,n.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:k})}},95456:(e,t,r)=>{r.d(t,{L:()=>l,P:()=>c});var a=r(45609),o=r(53797),i=r(13539),n=r(20728),s=r(67096),d=r.n(s);let l={adapter:(0,i.N)(n.Z),providers:[(0,o.Z)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e.password)return null;let t=await n.Z.user.findUnique({where:{email:e.email}});return t&&t.password&&await d().compare(e.password,t.password)?{id:t.id,name:t.name,email:t.email}:null}})],session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET,callbacks:{session:async({token:e,session:t})=>(e&&t.user&&(t.user.id=e.id,t.user.name=e.name,t.user.email=e.email,t.user.hasCompletedOnboarding=e.hasCompletedOnboarding,t.user.primaryWorkflow=e.primaryWorkflow),t),async jwt({token:e,user:t}){let r=t?.id||e.sub;if(!r)return e;let a=await n.Z.user.findUnique({where:{id:r},select:{id:!0,name:!0,email:!0,hasCompletedOnboarding:!0,settings:{select:{primaryWorkflow:!0}}}});return a?{...e,id:a.id,name:a.name,email:a.email,hasCompletedOnboarding:a.hasCompletedOnboarding,primaryWorkflow:a.settings?.primaryWorkflow||"HYBRID"}:e}},pages:{signIn:"/login"}},c=()=>(0,a.getServerSession)(l)},20728:(e,t,r)=>{r.d(t,{Z:()=>o});let a=require("@prisma/client"),o=globalThis.prisma||new a.PrismaClient},21178:(e,t,r)=>{r.d(t,{F:()=>a});async function a(e,t){try{let r=process.env.PORT||"3000",a=`http://localhost:${r}/api/socket/emit`,o=process.env.SOCKET_EMITTER_SECRET;if(!o){console.error("SOCKET_EMITTER_SECRET is not defined. Cannot emit socket event.");return}fetch(a,{method:"POST",headers:{"Content-Type":"application/json","x-emitter-secret":o},body:JSON.stringify({event:e,data:t})}).catch(t=>{console.error(`Failed to emit socket event '${e}' to ${a}:`,t.message)})}catch(e){console.error("Error preparing socket event emission:",e)}}},60836:(e,t,r)=>{r.d(t,{U3:()=>i,eG:()=>s,xN:()=>n});let a=e=>new Promise(t=>setTimeout(t,e));async function o(e,t,r){let o=`https://graph.facebook.com/v20.0/${r}/messages`,i={method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(e)};for(let e=1;e<=3;e++)try{let t=await fetch(o,i);if(t.ok)return await t.json();let r=await t.json().catch(()=>({}));if(console.error(`Attempt ${e}/3 failed with status ${t.status}:`,JSON.stringify(r)),t.status>=400&&t.status<500)return console.error("Client error, not retrying."),null;if(e<3){let t=1e3*Math.pow(2,e-1);console.log(`Retrying in ${t}ms...`),await a(t)}}catch(t){if(console.error(`Attempt ${e}/3 failed with network error:`,t),e<3){let t=1e3*Math.pow(2,e-1);console.log(`Retrying in ${t}ms...`),await a(t)}}return console.error("Failed to send message after 3 attempts."),null}async function i(e,t,r,a){let i={messaging_product:"whatsapp",recipient_type:"individual",to:e,type:"text",text:{body:t}};return a&&(i.context={message_id:a}),o(i,r.token,r.phoneId)}async function n(e,t,r,a,i){let n={link:t};r&&r.trim()&&(n.caption=r);let s={messaging_product:"whatsapp",recipient_type:"individual",to:e,type:"image",image:n};return i&&(s.context={message_id:i}),o(s,a.token,a.phoneId)}async function s(e,t,r,a,i,n){let s={messaging_product:"whatsapp",recipient_type:"individual",to:e,type:"document",document:{link:t,caption:r,filename:a}};return n&&(s.context={message_id:n}),o(s,i.token,i.phoneId)}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,1184,9092,1597,1212],()=>r(35364));module.exports=a})();