"use strict";(()=>{var a={};a.id=6121,a.ids=[6121],a.modules={67096:a=>{a.exports=require("bcrypt")},72934:a=>{a.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:a=>{a.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:a=>{a.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78018:a=>{a.exports=require("puppeteer")},39491:a=>{a.exports=require("assert")},14300:a=>{a.exports=require("buffer")},6113:a=>{a.exports=require("crypto")},82361:a=>{a.exports=require("events")},57147:a=>{a.exports=require("fs")},13685:a=>{a.exports=require("http")},95687:a=>{a.exports=require("https")},22037:a=>{a.exports=require("os")},71017:a=>{a.exports=require("path")},63477:a=>{a.exports=require("querystring")},12781:a=>{a.exports=require("stream")},76224:a=>{a.exports=require("tty")},57310:a=>{a.exports=require("url")},73837:a=>{a.exports=require("util")},59796:a=>{a.exports=require("zlib")},97820:(a,e,t)=>{t.r(e),t.d(e,{originalPathname:()=>$,patchFetch:()=>q,requestAsyncStorage:()=>w,routeModule:()=>b,serverHooks:()=>k,staticGenerationAsyncStorage:()=>v});var r={};t.r(r),t.d(r,{POST:()=>y});var o=t(49303),i=t(88716),n=t(60670),s=t(87070),x=t(20728),d=t(21178),l=t(60836),c=t(95456);let p={contact:!0,items:{include:{product:!0}},payments:!0};async function u(a,e){let t=await x.Z.message.create({data:{...a,status:"pending"},include:{contact:!0}});await (0,d.F)("newMessage",t);let r=await e(),o=r?.messages?.[0]?.id,i=o?"sent":"failed",n=await x.Z.message.update({where:{id:t.id},data:{wamid:o,status:i}});if(await (0,d.F)("message-status-update",{id:n.id,status:i,wamid:o}),!o)throw Error("Failed to send message via WhatsApp.")}async function m(a,e,r){let{default:o}=await Promise.all([t.e(9092),t.e(1597)]).then(t.t.bind(t,71597,23)),i=`
\xa0 \xa0 \xa0 <html>
\xa0 \xa0 \xa0 \xa0 <head>
\xa0 \xa0 \xa0 \xa0 \xa0 <style>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 body { font-family: Arial, sans-serif; padding: 40px; width: 600px; background-color: #f9f9f9; color: #333; }
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 .container { border: 1px solid #eee; background-color: white; padding: 30px; border-radius: 8px; }
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 .address-section { display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 12px; color: #555; }
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 .company-details { font-size: 12px; color: #555; }
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 .bill-details { text-align: right; font-size: 12px; }
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 .table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 .table th, .table td { border-bottom: 1px solid #e2e8f0; padding: 10px; text-align: left; }
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 .table th { background-color: #f7fafc; font-weight: bold; }
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 .totals { float: right; width: 40%; margin-top: 20px; font-size: 14px; }
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 .totals div { display: flex; justify-content: space-between; padding: 5px 0; }
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 .grand-total { font-size: 18px; font-weight: bold; border-top: 2px solid #333; margin-top: 5px; }
\xa0 \xa0 \xa0 \xa0 \xa0 </style>
\xa0 \xa0 \xa0 \xa0 </head>
\xa0 \xa0 \xa0 \xa0 <body>
\xa0 \xa0 \xa0 \xa0 \xa0 <div class="container">
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <div class="header">
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <div>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 ${e?.companyLogoUrl?`<img src="${e.companyLogoUrl}" alt="logo" style="max-width: 150px; margin-bottom: 10px;"/>`:""}
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <div class="company-details">
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <strong>${e?.companyName||"Your Company"}</strong><br/>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 ${e?.companyAddress?.replace(/\n/g,"<br/>")||"Your Company Address"}
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 </div>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 </div>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <div class="bill-details">
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <h2>INVOICE</h2>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <strong>Bill to:</strong> ${a.customerName}<br/>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <strong>Quotation ID:</strong> #${a.id.substring(0,6)}<br/>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <strong>Date:</strong> ${new Date(a.updatedAt).toLocaleDateString()}
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 </div>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 </div>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0<div class="address-section">
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <div><strong>Billing Address:</strong><br/>${a.billingAddress?.replace(/\n/g,"<br/>")||""}</div>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <div><strong>Shipping Address:</strong><br/>${a.shippingAddress?.replace(/\n/g,"<br/>")||""}</div>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 </div>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <table class="table">
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <thead><tr><th>Product</th><th style="text-align:center;">Qty</th><th style="text-align:right;">Price</th><th style="text-align:right;">Amount</th></tr></thead>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <tbody>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 ${a.items.map(a=>`
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <tr>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <td>${a.product?.name||"N/A"}</td>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <td style="text-align:center;">${a.quantity}</td>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <td style="text-align:right;">₹${a.price.toFixed(2)}</td>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <td style="text-align:right;">₹${(a.quantity*a.price).toFixed(2)}</td>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 </tr>`).join("")}
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 </tbody>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 </table>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <div class="totals">
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <div><span>Subtotal</span><span>₹${a.subtotal.toFixed(2)}</span></div>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 ${a.discountPercentage?`<div><span>Discount (${a.discountPercentage}%)</span><span>- ₹${(a.subtotal*a.discountPercentage/100).toFixed(2)}</span></div>`:""}
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 ${a.taxRate?`<div><span>GST (${a.taxRate}%)</span><span>+ ₹${((a.subtotal-a.subtotal*(a.discountPercentage||0)/100)*a.taxRate/100).toFixed(2)}</span></div>`:""}
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 ${a.deliveryCharges?`<div><span>Delivery</span><span>+ ₹${a.deliveryCharges.toFixed(2)}</span></div>`:""}
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 <div class="grand-total"><span>Grand Total</span><span>₹${a.total.toFixed(2)}</span></div>
\xa0 \xa0 \xa0 \xa0 \xa0 \xa0 </div>
\xa0 \xa0 \xa0 \xa0 \xa0 </div>
\xa0 \xa0 \xa0 \xa0 </body>
\xa0 \xa0 \xa0 </html>`,n=await o({html:i,puppeteerArgs:{args:["--no-sandbox"]}}),s="ce388deb1931d0d58b9e876d99c2b152";if(!s)throw Error("Server configuration error: ImgBB API key is not set.");let x=new FormData;x.append("image",n.toString("base64"));let d=await fetch(`https://api.imgbb.com/1/upload?key=${s}`,{method:"POST",body:x}),c=await d.json();if(!d.ok)throw Error("Failed to upload bill image.");let p=c.data.url,m=`Hi ${a.customerName}, please find your final bill attached.`;await u({from:"business",to:a.contact.phone,type:"image",text:m,mediaUrl:p,contactId:a.contact.id},()=>(0,l.xN)(a.contact.phone,p,m,r))}async function g(a,e,r,o){let{default:i}=await Promise.all([t.e(9092),t.e(1212)]).then(t.t.bind(t,41212,23));if(!e?.razorpayKeyId||!e?.razorpayKeySecret)throw Error("Razorpay API keys are not configured in settings.");let n=new i({key_id:e.razorpayKeyId,key_secret:e.razorpayKeySecret}),s=r>0?r:a.total;if(s<=0)throw Error("Cannot create a payment link for a zero or negative amount.");let d=await n.paymentLink.create({amount:Math.round(100*s),currency:"INR",description:`Payment for Quotation #${a.id.substring(0,6)}`,customer:{name:a.customerName,contact:a.contactNumber.replace("+","")},notify:{sms:!0,email:!1},reminder_enable:!0,notes:{quotation_id:a.id},callback_url:"https://e3e2fbab318c.ngrok-free.app/chat",callback_method:"get"});await x.Z.quotation.update({where:{id:a.id},data:{paymentLinkId:d.id,paymentLinkUrl:d.short_url}});let c=`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(d.short_url)}`,p=await fetch(c);if(!p.ok)throw Error("Failed to generate QR code image.");let m=await p.blob(),g="ce388deb1931d0d58b9e876d99c2b152";if(!g)throw Error("Server configuration error: ImgBB API key is not set.");let h=new FormData;h.append("image",m,"razorpay-qr.png");let f=await fetch(`https://api.imgbb.com/1/upload?key=${g}`,{method:"POST",body:h}),y=await f.json();if(!f.ok||!y.data?.url)throw console.error("ImgBB upload failed for QR code:",y),Error("Failed to upload QR code image.");let b=y.data.url,w=`Your final bill is *₹${s.toFixed(2)}*. 
Please scan the QR code to pay or click the link below:
${d.short_url}`;await u({from:"business",to:a.contact.phone,type:"image",text:w,mediaUrl:b,contactId:a.contact.id},()=>(0,l.xN)(a.contact.phone,b,w,o))}async function h(a,e,t){let r=e?.bankName&&e?.bankAccountNumber&&e?.bankIfscCode?`Bank Name: ${e.bankName}
Account No: ${e.bankAccountNumber}
IFSC Code: ${e.bankIfscCode}`:null;if(!r)throw Error("Bank details are not fully configured in settings.");let o=a.payments.reduce((a,e)=>a+e.amount,0),i=a.total-o;if(i<=0)throw Error("The bill is already paid in full.");let n=`A friendly reminder to complete the payment for your order. The remaining amount due is *₹${i.toFixed(2)}*. 

You can pay via bank transfer to:

${r}`;await u({from:"business",to:a.contact.phone,type:"text",text:n,contactId:a.contact.id},()=>(0,l.U3)(a.contact.phone,n,t))}async function f(a,e,t){if(!e?.upiQrCodeUrl)throw Error("UPI QR Code URL is not configured in settings.");let r=a.payments.reduce((a,e)=>a+e.amount,0),o=a.total-r;if(o<=0)throw Error("The bill is already paid in full.");let i=`Please scan this QR code to pay the remaining balance of *₹${o.toFixed(2)}*.`;await u({from:"business",to:a.contact.phone,type:"image",text:i,mediaUrl:e.upiQrCodeUrl,contactId:a.contact.id},()=>(0,l.xN)(a.contact.phone,e.upiQrCodeUrl,i,t))}async function y(a,e){let t=await (0,c.P)();if(!t?.user)return s.NextResponse.json({error:"Not authenticated"},{status:401});let{id:r}=await e.params;try{let{action:e,amount:o}=await a.json(),i=await x.Z.quotation.findUnique({where:{id:r},include:p});if(!i||!i.contact)return s.NextResponse.json({error:"Quotation not found"},{status:404});if(i.userId!==t.user.id)return s.NextResponse.json({error:"Forbidden"},{status:403});let n=await x.Z.user.findUnique({where:{id:i.userId},include:{settings:!0}});if(!n)return s.NextResponse.json({error:"Quotation owner not found."},{status:404});let d=n.settings,l=d?.whatsappAccessToken&&d?.whatsappPhoneNumberId?{token:d.whatsappAccessToken,phoneId:d.whatsappPhoneNumberId}:null;if(!l)throw Error("WhatsApp API credentials are not configured in settings.");switch(e){case"send_final_bill":await m(i,d,l);break;case"send_razorpay":await g(i,d,o,l);break;case"send_bank_details":await h(i,d,l);break;case"send_qr_code":await f(i,d,l);break;default:return s.NextResponse.json({error:"Invalid action specified"},{status:400})}return s.NextResponse.json({success:!0})}catch(a){return console.error(`Failed to perform action for quotation ${r}:`,a),s.NextResponse.json({error:a.message||"Failed to perform action"},{status:500})}}let b=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/quotations/[id]/send-bill-action/route",pathname:"/api/quotations/[id]/send-bill-action",filename:"route",bundlePath:"app/api/quotations/[id]/send-bill-action/route"},resolvedPagePath:"C:\\vyaparconnect-crm\\src\\app\\api\\quotations\\[id]\\send-bill-action\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:w,staticGenerationAsyncStorage:v,serverHooks:k}=b,$="/api/quotations/[id]/send-bill-action/route";function q(){return(0,n.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:v})}},95456:(a,e,t)=>{t.d(e,{L:()=>d,P:()=>l});var r=t(45609),o=t(53797),i=t(13539),n=t(20728),s=t(67096),x=t.n(s);let d={adapter:(0,i.N)(n.Z),providers:[(0,o.Z)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(a){if(!a?.email||!a.password)return null;let e=await n.Z.user.findUnique({where:{email:a.email}});return e&&e.password&&await x().compare(a.password,e.password)?{id:e.id,name:e.name,email:e.email}:null}})],session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET,callbacks:{session:async({token:a,session:e})=>(a&&e.user&&(e.user.id=a.id,e.user.name=a.name,e.user.email=a.email,e.user.hasCompletedOnboarding=a.hasCompletedOnboarding,e.user.primaryWorkflow=a.primaryWorkflow),e),async jwt({token:a,user:e}){let t=e?.id||a.sub;if(!t)return a;let r=await n.Z.user.findUnique({where:{id:t},select:{id:!0,name:!0,email:!0,hasCompletedOnboarding:!0,settings:{select:{primaryWorkflow:!0}}}});return r?{...a,id:r.id,name:r.name,email:r.email,hasCompletedOnboarding:r.hasCompletedOnboarding,primaryWorkflow:r.settings?.primaryWorkflow||"HYBRID"}:a}},pages:{signIn:"/login"}},l=()=>(0,r.getServerSession)(d)},20728:(a,e,t)=>{t.d(e,{Z:()=>o});let r=require("@prisma/client"),o=globalThis.prisma||new r.PrismaClient},21178:(a,e,t)=>{t.d(e,{F:()=>r});async function r(a,e){try{let t=process.env.PORT||"3000",r=`http://localhost:${t}/api/socket/emit`,o=process.env.SOCKET_EMITTER_SECRET;if(!o){console.error("SOCKET_EMITTER_SECRET is not defined. Cannot emit socket event.");return}fetch(r,{method:"POST",headers:{"Content-Type":"application/json","x-emitter-secret":o},body:JSON.stringify({event:a,data:e})}).catch(e=>{console.error(`Failed to emit socket event '${a}' to ${r}:`,e.message)})}catch(a){console.error("Error preparing socket event emission:",a)}}},60836:(a,e,t)=>{t.d(e,{U3:()=>i,eG:()=>s,xN:()=>n});let r=a=>new Promise(e=>setTimeout(e,a));async function o(a,e,t){let o=`https://graph.facebook.com/v20.0/${t}/messages`,i={method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(a)};for(let a=1;a<=3;a++)try{let e=await fetch(o,i);if(e.ok)return await e.json();let t=await e.json().catch(()=>({}));if(console.error(`Attempt ${a}/3 failed with status ${e.status}:`,JSON.stringify(t)),e.status>=400&&e.status<500)return console.error("Client error, not retrying."),null;if(a<3){let e=1e3*Math.pow(2,a-1);console.log(`Retrying in ${e}ms...`),await r(e)}}catch(e){if(console.error(`Attempt ${a}/3 failed with network error:`,e),a<3){let e=1e3*Math.pow(2,a-1);console.log(`Retrying in ${e}ms...`),await r(e)}}return console.error("Failed to send message after 3 attempts."),null}async function i(a,e,t,r){let i={messaging_product:"whatsapp",recipient_type:"individual",to:a,type:"text",text:{body:e}};return r&&(i.context={message_id:r}),o(i,t.token,t.phoneId)}async function n(a,e,t,r,i){let n={link:e};t&&t.trim()&&(n.caption=t);let s={messaging_product:"whatsapp",recipient_type:"individual",to:a,type:"image",image:n};return i&&(s.context={message_id:i}),o(s,r.token,r.phoneId)}async function s(a,e,t,r,i,n){let s={messaging_product:"whatsapp",recipient_type:"individual",to:a,type:"document",document:{link:e,caption:t,filename:r}};return n&&(s.context={message_id:n}),o(s,i.token,i.phoneId)}}};var e=require("../../../../../webpack-runtime.js");e.C(a);var t=a=>e(e.s=a),r=e.X(0,[8948,5972,1184],()=>t(97820));module.exports=r})();