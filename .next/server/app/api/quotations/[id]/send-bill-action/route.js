(()=>{var e={};e.id=6121,e.ids=[6121],e.modules={67096:e=>{"use strict";e.exports=require("bcrypt")},72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},77489:e=>{"use strict";e.exports=require("node-html-to-image")},39491:e=>{"use strict";e.exports=require("assert")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},22037:e=>{"use strict";e.exports=require("os")},71017:e=>{"use strict";e.exports=require("path")},63477:e=>{"use strict";e.exports=require("querystring")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},76224:e=>{"use strict";e.exports=require("tty")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},56804:()=>{},68645:()=>{},97820:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>A,patchFetch:()=>P,requestAsyncStorage:()=>$,routeModule:()=>q,serverHooks:()=>N,staticGenerationAsyncStorage:()=>I});var a={};r.r(a),r.d(a,{POST:()=>k});var i=r(49303),o=r(88716),s=r(60670),n=r(87070),d=r(20728),l=r(64284),c=r(60836),p=r(41212),u=r.n(p),m=r(77489),g=r.n(m),h=r(95456);let f={contact:!0,items:{include:{product:!0}},payments:!0};async function y(e,t){let r=await d.Z.message.create({data:{...e,status:"pending"},include:{contact:!0}});l.E()?.emit("newMessage",r);let a=await t(),i=a?.messages?.[0]?.id,o=i?"sent":"failed",s=await d.Z.message.update({where:{id:r.id},data:{wamid:i,status:o}});if(l.E()?.emit("message-status-update",{id:s.id,status:o,wamid:i}),!i)throw Error("Failed to send message via WhatsApp.")}async function b(e,t,r){let a=`
      <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; width: 600px; background-color: #f9f9f9; color: #333; }
            .container { border: 1px solid #eee; background-color: white; padding: 30px; border-radius: 8px; }
            .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
            .address-section { display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 12px; color: #555; }
            .company-details { font-size: 12px; color: #555; }
            .bill-details { text-align: right; font-size: 12px; }
            .table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
            .table th, .table td { border-bottom: 1px solid #e2e8f0; padding: 10px; text-align: left; }
            .table th { background-color: #f7fafc; font-weight: bold; }
            .totals { float: right; width: 40%; margin-top: 20px; font-size: 14px; }
            .totals div { display: flex; justify-content: space-between; padding: 5px 0; }
            .grand-total { font-size: 18px; font-weight: bold; border-top: 2px solid #333; margin-top: 5px; }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <div>
                ${t?.companyLogoUrl?`<img src="${t.companyLogoUrl}" alt="logo" style="max-width: 150px; margin-bottom: 10px;"/>`:""}
                <div class="company-details">
                  <strong>${t?.companyName||"Your Company"}</strong><br/>
                  ${t?.companyAddress?.replace(/\n/g,"<br/>")||"Your Company Address"}
                </div>
              </div>
              <div class="bill-details">
                <h2>INVOICE</h2>
                <strong>Bill to:</strong> ${e.customerName}<br/>
                <strong>Quotation ID:</strong> #${e.id.substring(0,6)}<br/>
                <strong>Date:</strong> ${new Date(e.updatedAt).toLocaleDateString()}
              </div>
            </div>
             <div class="address-section">
               <div><strong>Billing Address:</strong><br/>${e.billingAddress?.replace(/\n/g,"<br/>")||""}</div>
               <div><strong>Shipping Address:</strong><br/>${e.shippingAddress?.replace(/\n/g,"<br/>")||""}</div>
            </div>
            <table class="table">
              <thead><tr><th>Product</th><th style="text-align:center;">Qty</th><th style="text-align:right;">Price</th><th style="text-align:right;">Amount</th></tr></thead>
              <tbody>
                ${e.items.map(e=>`
                  <tr>
                    <td>${e.product?.name||"N/A"}</td>
                    <td style="text-align:center;">${e.quantity}</td>
                    <td style="text-align:right;">₹${e.price.toFixed(2)}</td>
                    <td style="text-align:right;">₹${(e.quantity*e.price).toFixed(2)}</td>
                  </tr>`).join("")}
              </tbody>
            </table>
            <div class="totals">
              <div><span>Subtotal</span><span>₹${e.subtotal.toFixed(2)}</span></div>
              ${e.discountPercentage?`<div><span>Discount (${e.discountPercentage}%)</span><span>- ₹${(e.subtotal*e.discountPercentage/100).toFixed(2)}</span></div>`:""}
              ${e.taxRate?`<div><span>GST (${e.taxRate}%)</span><span>+ ₹${((e.subtotal-e.subtotal*(e.discountPercentage||0)/100)*e.taxRate/100).toFixed(2)}</span></div>`:""}
              ${e.deliveryCharges?`<div><span>Delivery</span><span>+ ₹${e.deliveryCharges.toFixed(2)}</span></div>`:""}
              <div class="grand-total"><span>Grand Total</span><span>₹${e.total.toFixed(2)}</span></div>
            </div>
          </div>
        </body>
      </html>`,i=await g()({html:a,puppeteerArgs:{args:["--no-sandbox"]}}),o="ce388deb1931d0d58b9e876d99c2b152";if(!o)throw Error("Server configuration error: ImgBB API key is not set.");let s=new FormData;s.append("image",i.toString("base64"));let n=await fetch(`https://api.imgbb.com/1/upload?key=${o}`,{method:"POST",body:s}),d=await n.json();if(!n.ok)throw Error("Failed to upload bill image.");let l=d.data.url,p=`Hi ${e.customerName}, please find your final bill attached.`;await y({from:"business",to:e.contact.phone,type:"image",text:p,mediaUrl:l,contactId:e.contact.id},()=>(0,c.xN)(e.contact.phone,l,p,r))}async function x(e,t,r,a){if(!t?.razorpayKeyId||!t?.razorpayKeySecret)throw Error("Razorpay API keys are not configured in settings.");let i=new(u())({key_id:t.razorpayKeyId,key_secret:t.razorpayKeySecret}),o=r>0?r:e.total;if(o<=0)throw Error("Cannot create a payment link for a zero or negative amount.");let s=await i.paymentLink.create({amount:Math.round(100*o),currency:"INR",description:`Payment for Quotation #${e.id.substring(0,6)}`,customer:{name:e.customerName,contact:e.contactNumber.replace("+","")},notify:{sms:!0,email:!1},reminder_enable:!0,notes:{quotation_id:e.id},callback_url:"https://e3e2fbab318c.ngrok-free.app/chat",callback_method:"get"});await d.Z.quotation.update({where:{id:e.id},data:{paymentLinkId:s.id,paymentLinkUrl:s.short_url}});let n=`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(s.short_url)}`,l=await fetch(n);if(!l.ok)throw Error("Failed to generate QR code image.");let p=await l.blob(),m="ce388deb1931d0d58b9e876d99c2b152";if(!m)throw Error("Server configuration error: ImgBB API key is not set.");let g=new FormData;g.append("image",p,"razorpay-qr.png");let h=await fetch(`https://api.imgbb.com/1/upload?key=${m}`,{method:"POST",body:g}),f=await h.json();if(!h.ok||!f.data?.url)throw console.error("ImgBB upload failed for QR code:",f),Error("Failed to upload QR code image.");let b=f.data.url,x=`Your final bill is *₹${o.toFixed(2)}*. 
Please scan the QR code to pay or click the link below:
${s.short_url}`;await y({from:"business",to:e.contact.phone,type:"image",text:x,mediaUrl:b,contactId:e.contact.id},()=>(0,c.xN)(e.contact.phone,b,x,a))}async function w(e,t,r){let a=t?.bankName&&t?.bankAccountNumber&&t?.bankIfscCode?`Bank Name: ${t.bankName}
Account No: ${t.bankAccountNumber}
IFSC Code: ${t.bankIfscCode}`:null;if(!a)throw Error("Bank details are not fully configured in settings.");let i=e.payments.reduce((e,t)=>e+t.amount,0),o=e.total-i;if(o<=0)throw Error("The bill is already paid in full.");let s=`A friendly reminder to complete the payment for your order. The remaining amount due is *₹${o.toFixed(2)}*. 

You can pay via bank transfer to:

${a}`;await y({from:"business",to:e.contact.phone,type:"text",text:s,contactId:e.contact.id},()=>(0,c.U3)(e.contact.phone,s,r))}async function v(e,t,r){if(!t?.upiQrCodeUrl)throw Error("UPI QR Code URL is not configured in settings.");let a=e.payments.reduce((e,t)=>e+t.amount,0),i=e.total-a;if(i<=0)throw Error("The bill is already paid in full.");let o=`Please scan this QR code to pay the remaining balance of *₹${i.toFixed(2)}*.`;await y({from:"business",to:e.contact.phone,type:"image",text:o,mediaUrl:t.upiQrCodeUrl,contactId:e.contact.id},()=>(0,c.xN)(e.contact.phone,t.upiQrCodeUrl,o,r))}async function k(e,t){let r=await (0,h.P)();if(!r?.user)return n.NextResponse.json({error:"Not authenticated"},{status:401});let{id:a}=await t.params;try{let{action:t,amount:i}=await e.json(),o=await d.Z.quotation.findUnique({where:{id:a},include:f});if(!o||!o.contact)return n.NextResponse.json({error:"Quotation not found"},{status:404});if(o.userId!==r.user.id)return n.NextResponse.json({error:"Forbidden"},{status:403});let s=await d.Z.user.findUnique({where:{id:o.userId},include:{settings:!0}});if(!s)return n.NextResponse.json({error:"Quotation owner not found."},{status:404});let l=s.settings,c=l?.whatsappAccessToken&&l?.whatsappPhoneNumberId?{token:l.whatsappAccessToken,phoneId:l.whatsappPhoneNumberId}:null;if(!c)throw Error("WhatsApp API credentials are not configured in settings.");switch(t){case"send_final_bill":await b(o,l,c);break;case"send_razorpay":await x(o,l,i,c);break;case"send_bank_details":await w(o,l,c);break;case"send_qr_code":await v(o,l,c);break;default:return n.NextResponse.json({error:"Invalid action specified"},{status:400})}return n.NextResponse.json({success:!0})}catch(e){return console.error(`Failed to perform action for quotation ${a}:`,e),n.NextResponse.json({error:e.message||"Failed to perform action"},{status:500})}}let q=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/quotations/[id]/send-bill-action/route",pathname:"/api/quotations/[id]/send-bill-action",filename:"route",bundlePath:"app/api/quotations/[id]/send-bill-action/route"},resolvedPagePath:"C:\\vyaparconnect-crm\\src\\app\\api\\quotations\\[id]\\send-bill-action\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:$,staticGenerationAsyncStorage:I,serverHooks:N}=q,A="/api/quotations/[id]/send-bill-action/route";function P(){return(0,s.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:I})}},95456:(e,t,r)=>{"use strict";r.d(t,{L:()=>l,P:()=>c});var a=r(45609),i=r(53797),o=r(13539),s=r(20728),n=r(67096),d=r.n(n);let l={adapter:(0,o.N)(s.Z),providers:[(0,i.Z)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e.password)return null;let t=await s.Z.user.findUnique({where:{email:e.email}});return t&&t.password&&await d().compare(e.password,t.password)?{id:t.id,name:t.name,email:t.email}:null}})],session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET,callbacks:{session:async({token:e,session:t})=>(e&&t.user&&(t.user.id=e.id,t.user.name=e.name,t.user.email=e.email,t.user.hasCompletedOnboarding=e.hasCompletedOnboarding,t.user.primaryWorkflow=e.primaryWorkflow),t),async jwt({token:e,user:t}){if(t&&(e.id=t.id),!e.id)return e;let r=await s.Z.user.findUnique({where:{id:e.id},include:{settings:!0}});return r?{...e,id:r.id,name:r.name,email:r.email,hasCompletedOnboarding:r.hasCompletedOnboarding,primaryWorkflow:r.settings?.primaryWorkflow||"HYBRID"}:(e.id=void 0,e)}},pages:{signIn:"/login"}},c=()=>(0,a.getServerSession)(l)},20728:(e,t,r)=>{"use strict";r.d(t,{Z:()=>i});let a=require("@prisma/client"),i=globalThis.prisma||new a.PrismaClient},64284:(e,t,r)=>{"use strict";function a(){return globalThis.io}r.d(t,{E:()=>a}),r(83861)},60836:(e,t,r)=>{"use strict";r.d(t,{U3:()=>o,eG:()=>n,xN:()=>s});let a=e=>new Promise(t=>setTimeout(t,e));async function i(e,t,r){let i=`https://graph.facebook.com/v20.0/${r}/messages`,o={method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(e)};for(let e=1;e<=3;e++)try{let t=await fetch(i,o);if(t.ok)return await t.json();let r=await t.json().catch(()=>({}));if(console.error(`Attempt ${e}/3 failed with status ${t.status}:`,JSON.stringify(r)),t.status>=400&&t.status<500)return console.error("Client error, not retrying."),null;if(e<3){let t=1e3*Math.pow(2,e-1);console.log(`Retrying in ${t}ms...`),await a(t)}}catch(t){if(console.error(`Attempt ${e}/3 failed with network error:`,t),e<3){let t=1e3*Math.pow(2,e-1);console.log(`Retrying in ${t}ms...`),await a(t)}}return console.error("Failed to send message after 3 attempts."),null}async function o(e,t,r,a){let o={messaging_product:"whatsapp",recipient_type:"individual",to:e,type:"text",text:{body:t}};return a&&(o.context={message_id:a}),i(o,r.token,r.phoneId)}async function s(e,t,r,a,o){let s={link:t};r&&r.trim()&&(s.caption=r);let n={messaging_product:"whatsapp",recipient_type:"individual",to:e,type:"image",image:s};return o&&(n.context={message_id:o}),i(n,a.token,a.phoneId)}async function n(e,t,r,a,o,s){let n={messaging_product:"whatsapp",recipient_type:"individual",to:e,type:"document",document:{link:t,caption:r,filename:a}};return s&&(n.context={message_id:s}),i(n,o.token,o.phoneId)}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,1184,3861,1212],()=>r(97820));module.exports=a})();