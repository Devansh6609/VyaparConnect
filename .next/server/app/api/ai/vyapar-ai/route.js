(()=>{var e={};e.id=88,e.ids=[88],e.modules={67096:e=>{"use strict";e.exports=require("bcrypt")},72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{"use strict";e.exports=require("assert")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},73292:e=>{"use strict";e.exports=require("fs/promises")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},15673:e=>{"use strict";e.exports=require("node:events")},97742:e=>{"use strict";e.exports=require("node:process")},84492:e=>{"use strict";e.exports=require("node:stream")},47261:e=>{"use strict";e.exports=require("node:util")},22037:e=>{"use strict";e.exports=require("os")},71017:e=>{"use strict";e.exports=require("path")},85477:e=>{"use strict";e.exports=require("punycode")},63477:e=>{"use strict";e.exports=require("querystring")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},76224:e=>{"use strict";e.exports=require("tty")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},56114:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>E,patchFetch:()=>j,requestAsyncStorage:()=>C,routeModule:()=>A,serverHooks:()=>P,staticGenerationAsyncStorage:()=>S});var s={};r.r(s),r.d(s,{POST:()=>R});var a=r(49303),i=r(88716),o=r(60670),n=r(87070),u=r(73169),c=r(95456),p=r(20728),d=r(41211),l=r(16727),m=r(55606),f=r(79109);function h(e){let t=(0,f.Q)(e);return t.setDate(1),t.setHours(0,0,0,0),t}var g=r(44549),y=r(26053);let w={name:"getBusinessData",description:"Fetches business data (orders, items, customers) with optional filters for time period, customer tags, and payment status to answer analytical questions.",parameters:{type:u.Dy.OBJECT,properties:{timePeriod:{type:u.Dy.STRING,description:"The time period for the data. Can be 'today', 'last_7_days', 'this_month', 'last_month', 'this_year', or 'all_time'. Defaults to 'all_time' if not specified."},customerTags:{type:u.Dy.ARRAY,description:"An array of customer tag names to filter the data by, e.g., ['VIP', 'Wholesale'].",items:{type:u.Dy.STRING}},paymentStatus:{type:u.Dy.STRING,description:"Filter orders by a specific payment status. Can be 'UNPAID', 'PARTIALLY_PAID', or 'PAID'."}}}},x={name:"getProductDetails",description:"Retrieves details for a specific product, such as its current stock quantity and price.",parameters:{type:u.Dy.OBJECT,properties:{productName:{type:u.Dy.STRING,description:"The name of the product to query."}},required:["productName"]}},q={name:"addTagToContact",description:"Adds a new or existing tag to a specified customer.",parameters:{type:u.Dy.OBJECT,properties:{customerName:{type:u.Dy.STRING,description:"The name of the customer to add the tag to."},tagName:{type:u.Dy.STRING,description:"The name of the tag to add, e.g., 'Wholesale' or 'VIP'."}},required:["customerName","tagName"]}},N={name:"exportCustomerData",description:"Exports a customer's orders, payments, or quotations to a CSV file. Use this when the user asks to download, export, or get a file of a customer's data.",parameters:{type:u.Dy.OBJECT,properties:{customerName:{type:u.Dy.STRING,description:"The name of the customer whose data should be exported."},dataType:{type:u.Dy.STRING,description:"The type of data to export. Must be one of: 'orders', 'payments', or 'quotations'."}},required:["customerName","dataType"]}},T={name:"navigateTo",description:'Navigates the user to a specific page within the VyaparConnect application. Use this when the user asks to "go to settings", "open chats", "show me my orders", etc.',parameters:{type:u.Dy.OBJECT,properties:{page:{type:u.Dy.STRING,description:"The page to navigate to. Must be one of '/', '/chat', '/orders', '/quotations', '/broadcasts', '/groups', '/settings', '/profile'."}},required:["page"]}},v={name:"createBroadcast",description:'Initiates creating a new broadcast message to customers with specific tags. Use this when the user asks to "send a message to all VIPs", "create a new broadcast", etc.',parameters:{type:u.Dy.OBJECT,properties:{targetTags:{type:u.Dy.ARRAY,description:"An array of customer tag names to target with the broadcast.",items:{type:u.Dy.STRING}},message:{type:u.Dy.STRING,description:"The content of the message to be broadcast."}},required:["targetTags","message"]}},b={name:"updateProductDetails",description:"Updates the details of an existing product in the catalog, such as its price, stock quantity, or description.",parameters:{type:u.Dy.OBJECT,properties:{productName:{type:u.Dy.STRING,description:"The name of the product to update."},newPrice:{type:u.Dy.NUMBER,description:"The new price for the product."},newStockQuantity:{type:u.Dy.INTEGER,description:"The new stock quantity for the product."},newDescription:{type:u.Dy.STRING,description:"The new description for the product."}},required:["productName"]}},D=["#3b82f6","#22c55e","#eab308","#f97316","#ef4444","#8b5cf6","#d946ef","#64748b"],I=()=>D[Math.floor(Math.random()*D.length)];async function R(e){let t=await (0,c.P)();if(!t?.user)return n.NextResponse.json({error:"Not authenticated"},{status:401});let r=t.user.id;try{let t=await p.Z.settings.findUnique({where:{userId:r},select:{geminiApiKey:!0}});if(!t?.geminiApiKey)return n.NextResponse.json({error:"Gemini API key not configured."},{status:400});let s=(0,d.p)(t.geminiApiKey),{history:a}=await e.json();if(!a||0===a.length)return n.NextResponse.json({error:"Missing conversation history"},{status:400});let i=new u.fA({apiKey:s}),o=a.map(e=>({role:"assistant"===e.role?"model":"user",parts:[{text:e.content}]})),c=await i.models.generateContent({model:"gemini-2.5-flash",contents:o,config:{systemInstruction:"You are VyaparAI, an assistant for a business owner. Your goal is to answer questions about their business by using the provided tools to access data. You can also perform actions like navigating pages, managing products and customers, or creating broadcasts. Be helpful and concise. All monetary values should be presented in Indian Rupees (INR) with the symbol '₹'.",tools:[{functionDeclarations:[w,x,b,q,N,T,v]}]}}),D=c.functionCalls;if(D&&D.length>0){let e=D[0],t={success:!0};if(o.push({role:"model",parts:[{functionCall:e}]}),"addTagToContact"===e.name){let{customerName:s,tagName:a}=e.args,i=await p.Z.contact.findFirst({where:{name:{equals:s,mode:"insensitive"},userId:r}});if(i){let e=await p.Z.tag.findFirst({where:{name:a,userId:r}});if(!e)try{e=await p.Z.tag.create({data:{name:a,color:I(),userId:r}})}catch(t){if("P2002"===t.code)e=await p.Z.tag.findFirst({where:{name:a,userId:r}});else throw t}e?(await p.Z.contact.update({where:{id:i.id},data:{tags:{connect:{id:e.id}}}}),t={success:!0,message:`Tag '${a}' was added to ${s}.`}):t={success:!1,error:`Could not create or find tag '${a}'.`}}else t={success:!1,error:`Customer '${s}' not found.`}}else if("getProductDetails"===e.name){let{productName:s}=e.args,a=await p.Z.product.findFirst({where:{name:{equals:s,mode:"insensitive"},userId:r},select:{name:!0,price:!0,stockQuantity:!0,description:!0}});t=a?{success:!0,product:a}:{success:!1,error:`Product '${s}' not found.`}}else if("updateProductDetails"===e.name){let{productName:s,newPrice:a,newStockQuantity:i,newDescription:o}=e.args,n=await p.Z.product.findFirst({where:{name:{equals:s,mode:"insensitive"},userId:r}});if(n){let e={};void 0!==a&&(e.price=a),void 0!==i&&(e.stockQuantity=i),void 0!==o&&(e.description=o),Object.keys(e).length>0?(await p.Z.product.update({where:{id:n.id},data:e}),t={success:!0,message:`Successfully updated ${s}.`}):t={success:!1,error:`No update information was provided for ${s}.`}}else t={success:!1,error:`Product '${s}' not found.`}}else if("getBusinessData"===e.name){let{timePeriod:s,customerTags:a,paymentStatus:i}=e.args,o=new Date,n={userId:r};if(s){let e;if("today"===s&&(e=(0,l.b)(o)),"last_7_days"===s&&(e=(0,l.b)((0,m.E)(o,-7))),"this_month"===s&&(e=h(o)),"last_month"===s){let t=function(e,t){let r=(0,f.Q)(e);if(isNaN(-1))return(0,g.L)(e,NaN);let s=r.getDate(),a=(0,g.L)(e,r.getTime());return(a.setMonth(r.getMonth()+t+1,0),s>=a.getDate())?a:(r.setFullYear(a.getFullYear(),a.getMonth(),s),r)}(o,-1);e=h(t),n.createdAt.lte=function(e){let t=(0,f.Q)(e),r=t.getMonth();return t.setFullYear(t.getFullYear(),r+1,0),t.setHours(23,59,59,999),t}(t)}"this_year"===s&&(e=(0,y.e)(o)),e&&(n.createdAt={gte:e})}a&&a.length>0&&(n.contact={tags:{some:{name:{in:a,mode:"insensitive"}}}}),i&&(n.paymentStatus=i);let u=await p.Z.order.findMany({where:n,select:{customerName:!0,total:!0,status:!0,paymentStatus:!0,createdAt:!0,items:{select:{productName:!0,quantity:!0,price:!0}}}});t=u&&0!==u.length?{success:!0,data:u}:{success:!1,error:"I couldn't find any order data for the specified criteria."}}o.push({role:"user",parts:[{functionResponse:{name:e.name,response:t}}]});let s=await i.models.generateContent({model:"gemini-2.5-flash",contents:o,config:{systemInstruction:"You are VyaparAI. You have just executed a tool and received a result. Formulate a natural, user-friendly response based on the tool's output. All monetary values should be presented in Indian Rupees (INR) with the symbol '₹'."}});return n.NextResponse.json({text:s.text})}return n.NextResponse.json({text:c.text})}catch(e){if(console.error("Vyapar AI error:",e),e.message&&e.message.includes("GoogleGenerativeAI"))return n.NextResponse.json({error:"The AI service is currently unavailable or experiencing issues."},{status:503});return n.NextResponse.json({error:e.message||"Failed to get AI response."},{status:500})}}let A=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/ai/vyapar-ai/route",pathname:"/api/ai/vyapar-ai",filename:"route",bundlePath:"app/api/ai/vyapar-ai/route"},resolvedPagePath:"C:\\vyaparconnect-crm\\src\\app\\api\\ai\\vyapar-ai\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:C,staticGenerationAsyncStorage:S,serverHooks:P}=A,E="/api/ai/vyapar-ai/route";function j(){return(0,o.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:S})}},95456:(e,t,r)=>{"use strict";r.d(t,{L:()=>c,P:()=>p});var s=r(45609),a=r(53797),i=r(13539),o=r(20728),n=r(67096),u=r.n(n);let c={adapter:(0,i.N)(o.Z),providers:[(0,a.Z)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e.password)return null;let t=await o.Z.user.findUnique({where:{email:e.email}});return t&&t.password&&await u().compare(e.password,t.password)?{id:t.id,name:t.name,email:t.email}:null}})],session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET,callbacks:{session:async({token:e,session:t})=>(e&&t.user&&(t.user.id=e.id,t.user.name=e.name,t.user.email=e.email,t.user.hasCompletedOnboarding=e.hasCompletedOnboarding,t.user.primaryWorkflow=e.primaryWorkflow),t),async jwt({token:e,user:t}){if(t&&(e.id=t.id),!e.id)return e;let r=await o.Z.user.findUnique({where:{id:e.id},include:{settings:!0}});return r?{...e,id:r.id,name:r.name,email:r.email,hasCompletedOnboarding:r.hasCompletedOnboarding,primaryWorkflow:r.settings?.primaryWorkflow||"HYBRID"}:(e.id=void 0,e)}},pages:{signIn:"/login"}},p=()=>(0,s.getServerSession)(c)},41211:(e,t,r)=>{"use strict";r.d(t,{H:()=>n,p:()=>u});var s=r(6113);let a="aes-256-gcm",i=Buffer.from(process.env.ENCRYPTION_KEY||"","hex");function o(){if(32!==i.length)throw Error("Invalid ENCRYPTION_KEY environment variable. It must be a 64-character hex string.")}function n(e){o();let t=(0,s.randomBytes)(16),r=(0,s.createCipheriv)(a,i,t),n=Buffer.concat([r.update(e,"utf8"),r.final()]),u=r.getAuthTag();return`${t.toString("hex")}:${u.toString("hex")}:${n.toString("hex")}`}function u(e){o();let t=e.split(":");if(3!==t.length)throw Error("Invalid encrypted text format.");let r=Buffer.from(t[0],"hex"),n=Buffer.from(t[1],"hex"),u=Buffer.from(t[2],"hex"),c=(0,s.createDecipheriv)(a,i,r);return c.setAuthTag(n),Buffer.concat([c.update(u),c.final()]).toString("utf8")}},20728:(e,t,r)=>{"use strict";r.d(t,{Z:()=>a});let s=require("@prisma/client"),a=globalThis.prisma||new s.PrismaClient},55606:(e,t,r)=>{"use strict";r.d(t,{E:()=>i});var s=r(79109),a=r(44549);function i(e,t){let r=(0,s.Q)(e);return isNaN(t)?(0,a.L)(e,NaN):(t&&r.setDate(r.getDate()+t),r)}},44549:(e,t,r)=>{"use strict";function s(e,t){return e instanceof Date?new e.constructor(t):new Date(t)}r.d(t,{L:()=>s})},16727:(e,t,r)=>{"use strict";r.d(t,{b:()=>a});var s=r(79109);function a(e){let t=(0,s.Q)(e);return t.setHours(0,0,0,0),t}},26053:(e,t,r)=>{"use strict";r.d(t,{e:()=>i});var s=r(79109),a=r(44549);function i(e){let t=(0,s.Q)(e),r=(0,a.L)(e,0);return r.setFullYear(t.getFullYear(),0,1),r.setHours(0,0,0,0),r}},79109:(e,t,r)=>{"use strict";function s(e){let t=Object.prototype.toString.call(e);return e instanceof Date||"object"==typeof e&&"[object Date]"===t?new e.constructor(+e):new Date("number"==typeof e||"[object Number]"===t||"string"==typeof e||"[object String]"===t?e:NaN)}r.d(t,{Q:()=>s})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,1184,9092,3169],()=>r(56114));module.exports=s})();