"use strict";(()=>{var e={};e.id=5162,e.ids=[5162],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},30547:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>b,patchFetch:()=>x,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>y,staticGenerationAsyncStorage:()=>w});var a={};r.r(a),r.d(a,{GET:()=>m,POST:()=>h});var o=r(49303),n=r(88716),s=r(60670),i=r(87070),c=r(20728),u=r(21178),p=r(12683);async function d(e,t){let r=`https://graph.facebook.com/v20.0/${e}`;try{let a=await fetch(r,{headers:{Authorization:`Bearer ${t}`}});if(!a.ok)return console.error(`Failed to fetch media URL for ID ${e}:`,await a.json()),null;return(await a.json()).url||null}catch(t){return console.error(`Error fetching media URL for ID ${e}:`,t),null}}async function l(e,t,r,a="image.jpg"){if(!r)return console.error("User-specific ImgBB API key is missing."),null;try{let o=await fetch(e,{headers:{Authorization:`Bearer ${t}`}});if(!o.ok)return console.error("Failed to download media from WhatsApp."),null;let n=await o.arrayBuffer(),s=new Blob([n]),i=new FormData;i.append("image",s,a);let c=await fetch(`https://api.imgbb.com/1/upload?key=${r}`,{method:"POST",body:i}),u=await c.json();if(c.ok&&u.data?.url)return u.data.url;return console.error("ImgBB upload failed:",u.error?.message||"Unknown error"),null}catch(e){return console.error("Error in downloadAndUploadMedia:",e),null}}async function m(e){let{searchParams:t}=new URL(e.url),r=t.get("hub.mode"),a=t.get("hub.verify_token"),o=t.get("hub.challenge"),n=process.env.WHATSAPP_VERIFY_TOKEN;return n?"subscribe"===r&&a===n?(console.log("✅ WhatsApp Webhook Verified successfully using global token."),new i.NextResponse(o??"",{status:200})):(console.error("❌ WhatsApp Webhook Verification Failed. The token received did not match the expected token."),new i.NextResponse("Forbidden",{status:403})):(console.error("❌ FATAL: WHATSAPP_VERIFY_TOKEN is not set in environment variables. Webhook verification will fail."),new i.NextResponse("Forbidden",{status:403}))}async function h(e){try{let t=await e.json();if(!t.object||!t.entry?.[0]?.changes?.[0]?.value)return i.NextResponse.json({status:"not a whatsapp webhook"});let r=t.entry[0].changes[0].value,a=r.metadata?.phone_number_id;if(!a)return console.warn("Webhook received without phone_number_id. Cannot process."),i.NextResponse.json({success:!0,message:"ignored (no phone id)"});let o=await c.Z.settings.findFirst({where:{whatsappPhoneNumberId:a}});if(!o||!o.userId)return console.error(`No user configured for WhatsApp Phone Number ID: ${a}`),i.NextResponse.json({success:!0,message:"ignored (unregistered phone id)"});if(r.statuses){let e;let t=r.statuses[0],a=t.id,o=t.status;return"delivered"===o&&(e="delivered"),"read"===o&&(e="read"),e&&(await c.Z.message.updateMany({where:{wamid:a},data:{status:e}})).count>0&&(await (0,u.F)("message-status-update",{wamid:a,status:e}),console.log(`✅ Message ${a} status updated to ${e}`)),i.NextResponse.json({success:!0})}if(!r.messages||!o.whatsappAccessToken)return i.NextResponse.json({status:"not a message or token missing"});let n=r.messages[0],s=n.from,m=s.endsWith("@g.us"),h={from:"customer",to:a,type:n.type,text:null,mediaUrl:null,fileName:null,wamid:n.id,status:"received"};if(!m){let e=r.contacts?.[0]?.profile?.name||s,t=await c.Z.contact.findUnique({where:{phone:s}});t||(t=await c.Z.contact.create({data:{phone:s,name:e,userId:o.userId,stage:"NEW_LEAD"}}),await (0,u.F)("new_lead",t)),h.contactId=t.id,await c.Z.contact.update({where:{id:t.id},data:{unreadCount:{increment:1},updatedAt:new Date}})}if(n.context&&n.context.id){let e=await c.Z.message.findFirst({where:{wamid:n.context.id},include:{product:{include:{images:!0}}}});if(e){h.replyToId=e.id;let t=e.text||e.fileName||("image"===e.type?"\uD83D\uDCF7 Image":"document"===e.type?"\uD83D\uDCC4 Document":e.product?.name?`📦 ${e.product.name}`:"an attachment");h.replyToText=t,"image"===e.type&&e.mediaUrl?h.replyToMediaUrl=e.mediaUrl:"product"===e.type&&e.product?.images?.[0]?.url&&(h.replyToMediaUrl=e.product.images[0].url)}}let f=async e=>{if(e.id&&o.imgbbApiKey){let t=(0,p.p)(o.imgbbApiKey,o.userId),r=await d(e.id,o.whatsappAccessToken);r&&(h.mediaUrl=await l(r,o.whatsappAccessToken,t,e.filename))}h.text=e.caption||"",h.fileName=e.filename};switch(n.type){case"text":h.text=n.text.body;break;case"image":await f({id:n.image?.id,caption:n.image?.caption});break;case"document":await f({id:n.document?.id,caption:n.document?.caption,filename:n.document?.filename||"document"});break;default:h.type="unsupported",h.text=`Received an unsupported message type: ${n.type}`}let g=await c.Z.message.create({data:h,include:{contact:!0}});return await (0,u.F)(m?"newGroupMessage":"newMessage",g),i.NextResponse.json({success:!0})}catch(e){return console.error("❌ WhatsApp Webhook Error:",e),new i.NextResponse("Internal Server Error",{status:500})}}let f=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/webhooks/whatsapp/route",pathname:"/api/webhooks/whatsapp",filename:"route",bundlePath:"app/api/webhooks/whatsapp/route"},resolvedPagePath:"C:\\vyaparconnect-crm\\src\\app\\api\\webhooks\\whatsapp\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:w,serverHooks:y}=f,b="/api/webhooks/whatsapp/route";function x(){return(0,s.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:w})}},12683:(e,t,r)=>{r.d(t,{p:()=>c,H:()=>i});var a=r(6113);let o=require("node:buffer"),n="aes-256-gcm";function s(e){if(!e)throw Error("A user ID must be provided for cryptographic operations.");return(0,a.pbkdf2Sync)(e,"a-static-salt-for-vyaparconnect-app",1e5,32,"sha512")}function i(e,t){let r=s(t),i=(0,a.randomBytes)(16),c=(0,a.createCipheriv)(n,r,i),u=o.Buffer.concat([c.update(e,"utf8"),c.final()]),p=c.getAuthTag();return`${i.toString("hex")}:${p.toString("hex")}:${u.toString("hex")}`}function c(e,t){let r=s(t),i=e.split(":");if(3!==i.length)throw Error("Invalid encrypted text format.");let c=o.Buffer.from(i[0],"hex"),u=o.Buffer.from(i[1],"hex"),p=o.Buffer.from(i[2],"hex"),d=(0,a.createDecipheriv)(n,r,c);return d.setAuthTag(u),o.Buffer.concat([d.update(p),d.final()]).toString("utf8")}},20728:(e,t,r)=>{r.d(t,{Z:()=>o});let a=require("@prisma/client"),o=globalThis.prisma||new a.PrismaClient},21178:(e,t,r)=>{r.d(t,{F:()=>a});async function a(e,t){try{let r="https://e3e2fbab318c.ngrok-free.app/api/socket/emit",a=process.env.SOCKET_EMITTER_SECRET;if(!a){console.error("SOCKET_EMITTER_SECRET is not defined. Cannot emit socket event.");return}fetch(r,{method:"POST",headers:{"Content-Type":"application/json","x-emitter-secret":a},body:JSON.stringify({event:e,data:t})}).catch(t=>{console.error(`Failed to emit socket event '${e}' to ${r}:`,t.message)})}catch(e){console.error("Error preparing socket event emission:",e)}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972],()=>r(30547));module.exports=a})();