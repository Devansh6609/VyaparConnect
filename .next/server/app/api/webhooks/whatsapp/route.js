"use strict";(()=>{var e={};e.id=5162,e.ids=[5162],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},30547:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>b,patchFetch:()=>k,requestAsyncStorage:()=>w,routeModule:()=>f,serverHooks:()=>y,staticGenerationAsyncStorage:()=>g});var r={};a.r(r),a.d(r,{GET:()=>m,POST:()=>h});var o=a(49303),s=a(88716),n=a(60670),i=a(87070),u=a(20728),c=a(21178),d=a(41211);async function p(e,t){let a=`https://graph.facebook.com/v20.0/${e}`;try{let r=await fetch(a,{headers:{Authorization:`Bearer ${t}`}});if(!r.ok)return console.error(`Failed to fetch media URL for ID ${e}:`,await r.json()),null;return(await r.json()).url||null}catch(t){return console.error(`Error fetching media URL for ID ${e}:`,t),null}}async function l(e,t,a,r){if(!a)return console.error("User-specific ImgBB API key is missing."),null;try{let o=await fetch(e,{headers:{Authorization:`Bearer ${t}`}});if(!o.ok)return console.error("Failed to download media from WhatsApp.",await o.text()),null;let s=await o.arrayBuffer(),n=o.headers.get("Content-Type")||"application/octet-stream",i=new Blob([s],{type:n}),u=new FormData,c=n.split("/")[1]||"bin",d=r||`media.${c}`;u.append("image",i,d);let p=await fetch(`https://api.imgbb.com/1/upload?key=${a}`,{method:"POST",body:u}),l=await p.json();if(p.ok&&l.data?.url)return l.data.url;return console.error("ImgBB upload failed:",l.error?.message||"Unknown error"),null}catch(e){return console.error("Error in downloadAndUploadMedia:",e),null}}async function m(e){let{searchParams:t}=new URL(e.url),a=t.get("hub.mode"),r=t.get("hub.verify_token"),o=t.get("hub.challenge"),s=t.get("uid");if(!s)return console.error("❌ WhatsApp Webhook Verification Failed: Missing user ID (uid) in callback URL."),new i.NextResponse("Forbidden: Missing user identifier",{status:403});try{let e=await u.Z.settings.findUnique({where:{userId:s},select:{whatsappVerifyToken:!0}});if("subscribe"===a&&e&&r===e.whatsappVerifyToken)return console.log(`✅ WhatsApp Webhook Verified for user ${s}.`),new i.NextResponse(o??"",{status:200});return console.error(`❌ WhatsApp Webhook Verification Failed for user ${s}. Token mismatch or user not found.`),new i.NextResponse("Forbidden",{status:403})}catch(e){return console.error(`Error during webhook verification for user ${s}:`,e),new i.NextResponse("Internal Server Error",{status:500})}}async function h(e){try{let t=await e.json();if(!t.object||!t.entry?.[0]?.changes?.[0]?.value)return i.NextResponse.json({status:"not a whatsapp webhook"});let a=t.entry[0].changes[0].value,r=a.metadata?.phone_number_id;if(!r)return console.warn("Webhook received without phone_number_id. Cannot process."),i.NextResponse.json({success:!0,message:"ignored (no phone id)"});let o=await u.Z.settings.findFirst({where:{whatsappPhoneNumberId:r}});if(!o||!o.userId)return console.error(`No user configured for WhatsApp Phone Number ID: ${r}`),i.NextResponse.json({success:!0,message:"ignored (unregistered phone id)"});if(a.statuses){let e;let t=a.statuses[0],r=t.id,o=t.status;return"delivered"===o&&(e="delivered"),"read"===o&&(e="read"),e&&(await u.Z.message.updateMany({where:{wamid:r},data:{status:e}})).count>0&&(await (0,c.F)("message-status-update",{wamid:r,status:e}),console.log(`✅ Message ${r} status updated to ${e}`)),i.NextResponse.json({success:!0})}if(!a.messages||!o.whatsappAccessToken)return i.NextResponse.json({status:"not a message or token missing"});let s=(0,d.p)(o.whatsappAccessToken,o.userId),n=a.messages[0],m=n.from,h=m.endsWith("@g.us"),f={from:"customer",to:r,type:n.type,text:null,mediaUrl:null,fileName:null,wamid:n.id,status:"received"};if(!h){let e=a.contacts?.[0]?.profile?.name||m,t=await u.Z.contact.findFirst({where:{phone:m,userId:o.userId}});t||(t=await u.Z.contact.create({data:{phone:m,name:e,userId:o.userId,stage:"NEW_LEAD"}}),await (0,c.F)("new_lead",t)),f.contactId=t.id,await u.Z.contact.update({where:{id:t.id},data:{unreadCount:{increment:1},updatedAt:new Date}})}if(n.context&&n.context.id){let e=await u.Z.message.findFirst({where:{wamid:n.context.id},include:{product:{include:{images:!0}}}});if(e){f.replyToId=e.id;let t=e.text||e.fileName||("image"===e.type?"\uD83D\uDCF7 Image":"document"===e.type?"\uD83D\uDCC4 Document":e.product?.name?`📦 ${e.product.name}`:"an attachment");f.replyToText=t,"image"===e.type&&e.mediaUrl?f.replyToMediaUrl=e.mediaUrl:"product"===e.type&&e.product?.images?.[0]?.url&&(f.replyToMediaUrl=e.product.images[0].url)}}let w=async e=>{if(e.id&&o.imgbbApiKey){let t=(0,d.p)(o.imgbbApiKey,o.userId),a=await p(e.id,s);a&&(f.mediaUrl=await l(a,s,t,e.filename))}if(f.text=e.caption||"",f.fileName=e.filename,!f.mediaUrl){let e=f.text?`${f.text}

`:"";f.text=`${e}[System: Failed to process attached media. Please check your media hosting (ImgBB) API key in settings.]`,f.type="text"}};switch(n.type){case"text":f.text=n.text.body;break;case"image":await w({id:n.image?.id,caption:n.image?.caption,filename:null});break;case"document":await w({id:n.document?.id,caption:n.document?.caption,filename:n.document?.filename||"document"});break;default:f.type="unsupported",f.text=`Received an unsupported message type: ${n.type}`}let g=await u.Z.message.create({data:f,include:{contact:!0}});return await (0,c.F)(h?"newGroupMessage":"newMessage",g),i.NextResponse.json({success:!0})}catch(e){return console.error("❌ WhatsApp Webhook Error:",e),new i.NextResponse("Internal Server Error",{status:500})}}let f=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/webhooks/whatsapp/route",pathname:"/api/webhooks/whatsapp",filename:"route",bundlePath:"app/api/webhooks/whatsapp/route"},resolvedPagePath:"C:\\vyaparconnect-crm\\src\\app\\api\\webhooks\\whatsapp\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:w,staticGenerationAsyncStorage:g,serverHooks:y}=f,b="/api/webhooks/whatsapp/route";function k(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:g})}},41211:(e,t,a)=>{function r(e,t){return e}function o(e,t){return e&&e.includes(":")&&3===e.split(":").length?(console.warn("Attempted to use a legacy encrypted key which is no longer supported. Please re-save your API keys in the settings."),""):e}a.d(t,{H:()=>r,p:()=>o})},20728:(e,t,a)=>{a.d(t,{Z:()=>o});let r=require("@prisma/client"),o=globalThis.prisma||new r.PrismaClient},21178:(e,t,a)=>{a.d(t,{F:()=>r});async function r(e,t){try{let a=process.env.PORT||"3000",r=`http://localhost:${a}/api/socket/emit`,o=process.env.SOCKET_EMITTER_SECRET;if(!o){console.error("SOCKET_EMITTER_SECRET is not defined. Cannot emit socket event.");return}fetch(r,{method:"POST",headers:{"Content-Type":"application/json","x-emitter-secret":o},body:JSON.stringify({event:e,data:t})}).catch(t=>{console.error(`Failed to emit socket event '${e}' to ${r}:`,t.message)})}catch(e){console.error("Error preparing socket event emission:",e)}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972],()=>a(30547));module.exports=r})();