(()=>{var e={};e.id=5162,e.ids=[5162],e.modules={20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},22037:e=>{"use strict";e.exports=require("os")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},76224:e=>{"use strict";e.exports=require("tty")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},56804:()=>{},68645:()=>{},30547:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>b,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>x,staticGenerationAsyncStorage:()=>w});var s={};r.r(s),r.d(s,{GET:()=>m,POST:()=>h});var a=r(49303),o=r(88716),i=r(60670),n=r(87070),u=r(20728),c=r(64284),p=r(41211);async function d(e,t){let r=`https://graph.facebook.com/v20.0/${e}`;try{let s=await fetch(r,{headers:{Authorization:`Bearer ${t}`}});if(!s.ok)return console.error(`Failed to fetch media URL for ID ${e}:`,await s.json()),null;return(await s.json()).url||null}catch(t){return console.error(`Error fetching media URL for ID ${e}:`,t),null}}async function l(e,t,r,s="image.jpg"){if(!r)return console.error("User-specific ImgBB API key is missing."),null;try{let a=await fetch(e,{headers:{Authorization:`Bearer ${t}`}});if(!a.ok)return console.error("Failed to download media from WhatsApp."),null;let o=await a.arrayBuffer(),i=new Blob([o]),n=new FormData;n.append("image",i,s);let u=await fetch(`https://api.imgbb.com/1/upload?key=${r}`,{method:"POST",body:n}),c=await u.json();if(u.ok&&c.data?.url)return c.data.url;return console.error("ImgBB upload failed:",c.error?.message||"Unknown error"),null}catch(e){return console.error("Error in downloadAndUploadMedia:",e),null}}async function m(e){let{searchParams:t}=new URL(e.url),r=t.get("hub.mode"),s=t.get("hub.verify_token"),a=t.get("hub.challenge");if("subscribe"===r&&s){let e=await u.Z.settings.findFirst({where:{whatsappVerifyToken:s}});if(e)return console.log(`✅ WhatsApp Webhook Verified for user ${e.userId}`),new n.NextResponse(a??"",{status:200})}return console.error("❌ WhatsApp Webhook Verification Failed. Mode or token incorrect."),new n.NextResponse("Forbidden",{status:403})}async function h(e){try{let t=await e.json();if(!t.object||!t.entry?.[0]?.changes?.[0]?.value)return n.NextResponse.json({status:"not a whatsapp webhook"});let r=t.entry[0].changes[0].value,s=r.metadata?.phone_number_id;if(!s)return console.warn("Webhook received without phone_number_id. Cannot process."),n.NextResponse.json({success:!0,message:"ignored (no phone id)"});let a=await u.Z.settings.findFirst({where:{whatsappPhoneNumberId:s}});if(!a||!a.userId)return console.error(`No user configured for WhatsApp Phone Number ID: ${s}`),n.NextResponse.json({success:!0,message:"ignored (unregistered phone id)"});let o=(0,c.E)();if(r.statuses){let e;let t=r.statuses[0],s=t.id,a=t.status;return"delivered"===a&&(e="delivered"),"read"===a&&(e="read"),e&&(await u.Z.message.updateMany({where:{wamid:s},data:{status:e}})).count>0&&(o?.emit("message-status-update",{wamid:s,status:e}),console.log(`✅ Message ${s} status updated to ${e}`)),n.NextResponse.json({success:!0})}if(!r.messages||!a.whatsappAccessToken)return n.NextResponse.json({status:"not a message or token missing"});let i=r.messages[0],m=i.from,h=m.endsWith("@g.us"),f={from:"customer",to:s,type:i.type,text:null,mediaUrl:null,fileName:null,wamid:i.id,status:"received"};if(!h){let e=r.contacts?.[0]?.profile?.name||m,t=await u.Z.contact.findUnique({where:{phone:m}});t||(t=await u.Z.contact.create({data:{phone:m,name:e,userId:a.userId,stage:"NEW_LEAD"}}),o?.emit("new_lead",t)),f.contactId=t.id,await u.Z.contact.update({where:{id:t.id},data:{unreadCount:{increment:1},updatedAt:new Date}})}if(i.context&&i.context.id){let e=await u.Z.message.findFirst({where:{wamid:i.context.id},include:{product:{include:{images:!0}}}});if(e){f.replyToId=e.id;let t=e.text||e.fileName||("image"===e.type?"\uD83D\uDCF7 Image":"document"===e.type?"\uD83D\uDCC4 Document":e.product?.name?`📦 ${e.product.name}`:"an attachment");f.replyToText=t,"image"===e.type&&e.mediaUrl?f.replyToMediaUrl=e.mediaUrl:"product"===e.type&&e.product?.images?.[0]?.url&&(f.replyToMediaUrl=e.product.images[0].url)}}let g=async e=>{if(e.id&&a.imgbbApiKey){let t=(0,p.p)(a.imgbbApiKey),r=await d(e.id,a.whatsappAccessToken);r&&(f.mediaUrl=await l(r,a.whatsappAccessToken,t,e.filename))}f.text=e.caption||"",f.fileName=e.filename};switch(i.type){case"text":f.text=i.text.body;break;case"image":await g({id:i.image?.id,caption:i.image?.caption});break;case"document":await g({id:i.document?.id,caption:i.document?.caption,filename:i.document?.filename||"document"});break;default:f.type="unsupported",f.text=`Received an unsupported message type: ${i.type}`}let w=await u.Z.message.create({data:f,include:{contact:!0}});return o?.emit(h?"newGroupMessage":"newMessage",w),n.NextResponse.json({success:!0})}catch(e){return console.error("❌ WhatsApp Webhook Error:",e),new n.NextResponse("Internal Server Error",{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/webhooks/whatsapp/route",pathname:"/api/webhooks/whatsapp",filename:"route",bundlePath:"app/api/webhooks/whatsapp/route"},resolvedPagePath:"C:\\vyaparconnect-crm\\src\\app\\api\\webhooks\\whatsapp\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:w,serverHooks:x}=f,b="/api/webhooks/whatsapp/route";function y(){return(0,i.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:w})}},41211:(e,t,r)=>{"use strict";r.d(t,{H:()=>n,p:()=>u});var s=r(6113);let a="aes-256-gcm",o=Buffer.from(process.env.ENCRYPTION_KEY||"","hex");function i(){if(32!==o.length)throw Error("Invalid ENCRYPTION_KEY environment variable. It must be a 64-character hex string.")}function n(e){i();let t=(0,s.randomBytes)(16),r=(0,s.createCipheriv)(a,o,t),n=Buffer.concat([r.update(e,"utf8"),r.final()]),u=r.getAuthTag();return`${t.toString("hex")}:${u.toString("hex")}:${n.toString("hex")}`}function u(e){i();let t=e.split(":");if(3!==t.length)throw Error("Invalid encrypted text format.");let r=Buffer.from(t[0],"hex"),n=Buffer.from(t[1],"hex"),u=Buffer.from(t[2],"hex"),c=(0,s.createDecipheriv)(a,o,r);return c.setAuthTag(n),Buffer.concat([c.update(u),c.final()]).toString("utf8")}},20728:(e,t,r)=>{"use strict";r.d(t,{Z:()=>a});let s=require("@prisma/client"),a=globalThis.prisma||new s.PrismaClient},64284:(e,t,r)=>{"use strict";function s(){return globalThis.io}r.d(t,{E:()=>s}),r(83861)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,3861],()=>r(30547));module.exports=s})();