"use strict";(()=>{var e={};e.id=9824,e.ids=[9824],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},80132:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>g,patchFetch:()=>x,requestAsyncStorage:()=>l,routeModule:()=>h,serverHooks:()=>w,staticGenerationAsyncStorage:()=>f});var s={};a.r(s),a.d(s,{POST:()=>m});var n=a(49303),r=a(88716),i=a(60670),o=a(87070),p=a(20728);let d=process.env.WHATSAPP_TOKEN,u=process.env.WHATSAPP_PHONE_NUMBER_ID,c="https://graph.facebook.com/v20.0";async function m(e){try{let{to:t,type:a="text",text:s,documentUrl:n,filename:r,caption:i}=await e.json();if(!t)return o.NextResponse.json({error:"missing `to`"},{status:400});if("text"===a){let e=await fetch(`${c}/${u}/messages`,{method:"POST",headers:{Authorization:`Bearer ${d}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:t,text:{body:s}})}),a=await e.json(),n=a?.messages?.[0]?.id,r=await p.Z.contact.findUnique({where:{phone:t}})||await p.Z.contact.create({data:{phone:t,name:t,userId:(await p.Z.user.findFirst()).id}});return await p.Z.message.create({data:{from:"business",to:t,text:s,mediaUrl:null,type:"text",contactId:r.id,wamid:n,status:n?"sent":"failed"}}),o.NextResponse.json(a)}if("document"===a&&n){let e=await fetch(`${c}/${u}/media`,{method:"POST",headers:{Authorization:`Bearer ${d}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",file:n})}),a=(await e.json()).id,s=await fetch(`${c}/${u}/messages`,{method:"POST",headers:{Authorization:`Bearer ${d}`,"Content-Type":"application/json"},body:JSON.stringify({messaging_product:"whatsapp",to:t,type:"document",document:{id:a,filename:r||"file.pdf",caption:i||""}})}),m=await s.json(),h=m?.messages?.[0]?.id,l=await p.Z.contact.findUnique({where:{phone:t}})||await p.Z.contact.create({data:{phone:t,name:t,userId:(await p.Z.user.findFirst()).id}});return await p.Z.message.create({data:{from:"business",to:t,text:i||null,mediaUrl:n,type:"document",contactId:l.id,wamid:h,status:h?"sent":"failed"}}),o.NextResponse.json(m)}return o.NextResponse.json({error:"unsupported type"},{status:400})}catch(e){return console.error("Send message error:",e),o.NextResponse.json({error:"failed to send"},{status:500})}}let h=new n.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/whatsapp/send/route",pathname:"/api/whatsapp/send",filename:"route",bundlePath:"app/api/whatsapp/send/route"},resolvedPagePath:"C:\\vyaparconnect-crm\\src\\app\\api\\whatsapp\\send\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:l,staticGenerationAsyncStorage:f,serverHooks:w}=h,g="/api/whatsapp/send/route";function x(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:f})}},20728:(e,t,a)=>{a.d(t,{Z:()=>n});let s=require("@prisma/client"),n=globalThis.prisma||new s.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[8948,5972],()=>a(80132));module.exports=s})();