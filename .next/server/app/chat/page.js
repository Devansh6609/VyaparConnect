(()=>{var e={};e.id=1929,e.ids=[1929],e.modules={47849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},55403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},94749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},22037:e=>{"use strict";e.exports=require("os")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},76224:e=>{"use strict";e.exports=require("tty")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},56804:()=>{},68645:()=>{},27269:(e,t,a)=>{"use strict";a.r(t),a.d(t,{GlobalError:()=>d.a,__next_app__:()=>m,originalPathname:()=>u,pages:()=>c,routeModule:()=>x,tree:()=>o}),a(34356),a(95499),a(72110),a(35866);var s=a(23191),r=a(88716),l=a(37922),d=a.n(l),i=a(95231),n={};for(let e in i)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(n[e]=()=>i[e]);a.d(t,n);let o=["",{children:["chat",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(a.bind(a,34356)),"C:\\vyaparconnect-crm\\src\\app\\chat\\page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(a.bind(a,95499)),"C:\\vyaparconnect-crm\\src\\app\\layout.tsx"],loading:[()=>Promise.resolve().then(a.bind(a,72110)),"C:\\vyaparconnect-crm\\src\\app\\loading.tsx"],"not-found":[()=>Promise.resolve().then(a.t.bind(a,35866,23)),"next/dist/client/components/not-found-error"]}],c=["C:\\vyaparconnect-crm\\src\\app\\chat\\page.tsx"],u="/chat/page",m={require:a,loadChunk:()=>Promise.resolve()},x=new s.AppPageRouteModule({definition:{kind:r.x.APP_PAGE,page:"/chat/page",pathname:"/chat",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:o}})},9432:(e,t,a)=>{Promise.resolve().then(a.bind(a,34376))},83855:(e,t,a)=>{"use strict";a.d(t,{Z:()=>s});let s=(0,a(62881).Z)("plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},31215:(e,t,a)=>{"use strict";a.d(t,{Z:()=>s});let s=(0,a(62881).Z)("save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]])},34376:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>eX});var s=a(10326),r=a(17577),l=a(35047),d=a(46469),i=a(37978),n=a(17334);let o=()=>(0,s.jsxs)("div",{className:"flex items-center p-3",children:[s.jsx(n.Z,{className:"h-10 w-10 rounded-full"}),(0,s.jsxs)("div",{className:"ml-3 flex-1",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[s.jsx(n.Z,{className:"h-4 w-2/4"}),s.jsx(n.Z,{className:"h-3 w-1/4"})]}),s.jsx("div",{className:"mt-2",children:s.jsx(n.Z,{className:"h-3 w-3/4"})})]})]}),c=()=>s.jsx("div",{className:"pt-2",children:[...Array(8)].map((e,t)=>s.jsx(o,{},t))});var u=a(78539),m=a(55795),x=a(9086);let g={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.07,delayChildren:.1}}},h={hidden:{y:20,opacity:0},visible:{y:0,opacity:1},exit:{opacity:0,x:-30,transition:{duration:.2}}},y=({socket:e,activeContactId:t,onSelectChat:a})=>{let[l,n]=(0,r.useState)([]),[o,y]=(0,r.useState)(!0),[p,b]=(0,r.useState)(""),[f,j]=(0,r.useState)(null),[k,v]=(0,r.useState)(!0),[N,w]=(0,r.useState)(!1),[D,C]=(0,r.useState)([]),[E,S]=(0,r.useState)([]),A=(0,r.useRef)(null),P=(0,r.useRef)(null),T=(0,r.useCallback)(async(e=null,t=[])=>{y(!0);try{let a=t.length>0?`&tags=${t.join(",")}`:"",s=`/api/contacts?limit=20${e?`&cursor=${e}`:""}${a}`,r=await fetch(s);if(r.ok){let{contacts:t,nextCursor:a}=await r.json();e?n(e=>[...e,...t]):n(t),j(a),v(!!a)}}catch(e){console.error("Failed to fetch chats",e)}finally{y(!1)}},[]);(0,r.useEffect)(()=>{T(null,E)},[E,T]);let _=(0,r.useCallback)(e=>{!o&&(P.current&&P.current.disconnect(),P.current=new IntersectionObserver(e=>{e[0].isIntersecting&&k&&f&&T(f,E)}),e&&P.current.observe(e))},[o,k,f,T,E]);(0,r.useEffect)(()=>{(async()=>{let e=await fetch("/api/tags");e.ok&&C(await e.json())})();let e=e=>{A.current&&!A.current.contains(e.target)&&w(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),(0,r.useEffect)(()=>{if(e){let a=e=>{n(a=>{let s=e.contactId;if(!s)return a;let r=s===t,l=!1,d=a.map(t=>t.id===s?(l=!0,{...t,lastMessage:e.text||("text"!==e.type?`Sent a ${e.type}`:""),lastMessageAt:e.createdAt,unreadCount:r?0:(t.unreadCount||0)+("customer"===e.from?1:0)}):t);return l?d.sort((e,t)=>new Date(t.lastMessageAt||0).getTime()-new Date(e.lastMessageAt||0).getTime()):(Promise.resolve().then(()=>T(null,E)),a)})};return e.on("newMessage",a),()=>{e.off("newMessage",a)}}},[e,t,T,E]);let I=e=>{S(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},F=l.filter(e=>e.name.toLowerCase().includes(p.toLowerCase()));return(0,s.jsxs)("div",{className:"w-80 border-r flex flex-col h-full bg-white dark:bg-[var(--sidebar-background)] border-gray-200 dark:border-[var(--card-border)]",children:[(0,s.jsxs)("div",{className:"p-4 border-b border-gray-200 dark:border-[var(--card-border)]",children:[s.jsx("h2",{className:"text-xl font-bold text-gray-800 dark:text-gray-100",children:"Chats"}),(0,s.jsxs)("div",{className:"flex items-center space-x-2 mt-3",children:[s.jsx("input",{type:"text",placeholder:"Search chats...",value:p,onChange:e=>b(e.target.value),className:"w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-[var(--incoming-bubble-bg)] border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100"}),(0,s.jsxs)("div",{className:"relative",ref:A,children:[s.jsx("button",{onClick:()=>w(e=>!e),className:`p-2 border rounded-md ${E.length>0?"bg-blue-100 text-blue-600 dark:bg-blue-900/50":"bg-gray-50 dark:bg-[var(--incoming-bubble-bg)]"}`,children:s.jsx(u.Z,{name:"SlidersHorizontal",size:20})}),N&&(0,s.jsxs)("div",{className:"absolute top-full right-0 mt-2 w-48 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-md shadow-lg z-20",children:[s.jsx("div",{className:"p-2 text-sm font-semibold border-b dark:border-gray-700",children:"Filter by Tag"}),s.jsx("div",{className:"p-2 max-h-48 overflow-y-auto",children:D.map(e=>(0,s.jsxs)("label",{className:"flex items-center space-x-2 p-1.5 rounded hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",children:[s.jsx("input",{type:"checkbox",checked:E.includes(e.id),onChange:()=>I(e.id),className:"h-4 w-4 text-blue-600 rounded"}),s.jsx("span",{children:e.name})]},e.id))}),E.length>0&&s.jsx("div",{className:"p-2 border-t dark:border-gray-700",children:s.jsx("button",{onClick:()=>S([]),className:"w-full text-center text-xs text-red-500 hover:underline",children:"Clear Filters"})})]})]})]})]}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:o&&0===l.length?s.jsx(c,{}):(0,s.jsxs)(m.E.ul,{variants:g,initial:"hidden",animate:"visible",children:[s.jsx(x.M,{children:F.map((e,r)=>s.jsx(m.E.li,{variants:h,exit:"exit",transition:{type:"spring",stiffness:400,damping:40},ref:r===F.length-1?_:null,onClick:()=>a(e),className:`p-3 cursor-pointer border-b border-gray-200 dark:border-[var(--card-border)] hover:bg-gray-50 dark:hover:bg-[var(--input-background)] transition-colors ${t===e.id?"bg-blue-50 dark:bg-[var(--incoming-bubble-bg)]":""}`,children:(0,s.jsxs)("div",{className:"flex items-start",children:[s.jsx(i.Z,{initials:(e.name||"?").charAt(0).toUpperCase()}),(0,s.jsxs)("div",{className:"ml-3 flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[s.jsx("p",{className:"font-semibold text-sm truncate text-gray-800 dark:text-gray-100",children:e.name}),s.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 flex-shrink-0 ml-2",children:e.lastMessageAt&&(0,d.Q)(new Date(e.lastMessageAt),{addSuffix:!0})})]}),(0,s.jsxs)("div",{className:"flex justify-between items-start mt-1",children:[s.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-300 truncate pr-2",children:e.lastMessage||"No messages yet"}),e.unreadCount&&e.unreadCount>0&&s.jsx("span",{className:"bg-green-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center flex-shrink-0",children:e.unreadCount})]}),s.jsx("div",{className:"flex items-center space-x-1 mt-2 overflow-hidden",children:e.tags?.map(e=>s.jsx("div",{className:"px-1.5 py-0.5 text-[10px] font-medium rounded",style:{backgroundColor:`${e.color}20`,color:e.color},children:e.name},e.id))})]})]})},e.id))}),o&&l.length>0&&s.jsx("p",{className:"p-4 text-sm text-gray-500 dark:text-gray-300 text-center",children:"Loading more..."})]})})]})};var p=a(77506),b=a(1572),f=a(94019),j=a(39572),k=a(62881);let v=(0,k.Z)("smile",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]);var N=a(71709);let w=(0,k.Z)("paperclip",[["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 2.829 2.829l8.414-8.586a4 4 0 1 0-5.657-5.657l-8.379 8.551a6 6 0 1 0 8.485 8.485l8.379-8.551",key:"1miecu"}]]);var D=a(69436);let C=["\uD83D\uDE00","\uD83D\uDE03","\uD83D\uDE04","\uD83D\uDE01","\uD83D\uDE06","\uD83D\uDE05","\uD83D\uDE02","\uD83E\uDD23","\uD83D\uDE0A","\uD83D\uDE07","\uD83D\uDE42","\uD83D\uDE43","\uD83D\uDE09","\uD83D\uDE0C","\uD83D\uDE0D","\uD83E\uDD70","\uD83D\uDE18","\uD83D\uDE17","\uD83D\uDE19","\uD83D\uDE1A","\uD83D\uDE0B","\uD83D\uDE1B","\uD83D\uDE1D","\uD83D\uDE1C","\uD83E\uDD2A","\uD83E\uDD28","\uD83E\uDDD0","\uD83E\uDD13","\uD83D\uDE0E","\uD83E\uDD29","\uD83E\uDD73","\uD83D\uDE0F","\uD83D\uDE12","\uD83D\uDE1E","\uD83D\uDE14","\uD83D\uDE1F","\uD83D\uDE15","\uD83D\uDE41","â˜¹ï¸","\uD83D\uDE23","\uD83D\uDE16","\uD83D\uDE2B","\uD83D\uDE29","\uD83E\uDD7A","\uD83D\uDE22","\uD83D\uDE2D","\uD83D\uDE24","\uD83D\uDE20","\uD83D\uDE21","\uD83E\uDD2C","\uD83E\uDD2F","\uD83D\uDE33","\uD83E\uDD75","\uD83E\uDD76","\uD83D\uDE31","\uD83D\uDE28","\uD83D\uDE30","\uD83D\uDE25","\uD83D\uDE13","\uD83E\uDD17","\uD83E\uDD14","\uD83E\uDD2D","\uD83E\uDD2B","\uD83E\uDD25","\uD83D\uDE36","\uD83D\uDE10","\uD83D\uDE11","\uD83D\uDE2C","\uD83D\uDE44","\uD83D\uDE2F","\uD83D\uDE26","\uD83D\uDE27","\uD83D\uDE2E","\uD83D\uDE32","\uD83E\uDD71","\uD83D\uDE34","\uD83E\uDD24","\uD83D\uDE2A","\uD83D\uDE35","\uD83E\uDD10","\uD83E\uDD74","\uD83E\uDD22","\uD83E\uDD2E","\uD83E\uDD27","\uD83D\uDE37","\uD83E\uDD12","\uD83E\uDD15","\uD83E\uDD11","\uD83E\uDD20","â¤ï¸","\uD83E\uDDE1","\uD83D\uDC9B","\uD83D\uDC9A","\uD83D\uDC99","\uD83D\uDC9C","\uD83E\uDD0E","\uD83D\uDDA4","\uD83E\uDD0D","\uD83D\uDC94","\uD83D\uDC4D","\uD83D\uDC4E","\uD83D\uDC4C","âœŒï¸","\uD83E\uDD1E","\uD83D\uDE4F","\uD83D\uDE4C","\uD83D\uDC4F","\uD83E\uDD1D"],E=({onSelectEmoji:e,onClose:t})=>{let a=(0,r.useRef)(null);return(0,r.useEffect)(()=>{let e=e=>{a.current&&!a.current.contains(e.target)&&t()};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[t]),s.jsx("div",{ref:a,className:"absolute bottom-full mb-2 bg-white p-3 rounded-2xl shadow-lg border w-80 h-60 overflow-y-auto",children:s.jsx("div",{className:"grid grid-cols-8 gap-1",children:C.map(t=>s.jsx("button",{onClick:()=>e(t),className:"text-2xl hover:bg-gray-200 rounded-lg p-1 transition-colors","aria-label":`Emoji ${t}`,children:t},t))})})},S=({newMessage:e,setNewMessage:t,sendMessage:a,replyingTo:l,onCancelReply:d,messages:i,smartReplies:n,isFetchingReplies:o,onCreateOrder:c})=>{let[u,g]=(0,r.useState)(!1),[h,y]=(0,r.useState)(!1),[k,C]=(0,r.useState)(null),[S,A]=(0,r.useState)(null),P=(0,r.useRef)(null),T=(0,r.useRef)(null),[_,I]=(0,r.useState)(!1),[F,Z]=(0,r.useState)(""),[M,O]=(0,r.useState)(!1),[q,z]=(0,r.useState)("");(0,r.useEffect)(()=>{let e=T.current;if(e){e.style.height="auto";let t=e.scrollHeight;e.style.height=`${t}px`}},[e]);let $=s=>{a("string"==typeof s?s:e,k||void 0),t(""),C(null),A(null)},U=async()=>{if(F.trim()&&i){O(!0),z("");try{let e=i.map(e=>`${"business"===e.from?"Business":"Customer"}: ${e.text||"[attachment]"}`).join("\n"),a=await fetch("/api/ai/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:F,history:e})}),s=await a.json();if(!a.ok)throw Error(s.error||"VyaparAI is currently unavailable. Please try again.");s.functionCall&&"createOrder"===s.functionCall.name?c():t(s.text),I(!1),Z("")}catch(e){console.error("VyaparAI error:",e),z(e.message||"VyaparAI is currently unavailable. Please try again."),setTimeout(()=>z(""),3e3)}finally{O(!1)}}};return(0,s.jsxs)("div",{className:"bg-gray-100 dark:bg-[var(--header-background)] p-4 border-t border-gray-200 dark:border-[var(--card-border)] relative",children:[s.jsx(x.M,{children:(o||n.length>0)&&(0,s.jsxs)(m.E.div,{className:"mb-2 flex flex-wrap items-center gap-2",children:[o&&s.jsx(p.Z,{size:18,className:"animate-spin text-gray-400"}),n.map((e,t)=>s.jsx(m.E.button,{onClick:()=>$(e),className:"px-3 py-1.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 whitespace-nowrap",children:e},t))]})}),s.jsx(x.M,{children:_&&(0,s.jsxs)(m.E.div,{className:"mb-2",children:[(0,s.jsxs)("div",{className:"relative",children:[s.jsx(b.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-blue-500",size:20}),s.jsx("input",{type:"text",value:F,onChange:e=>Z(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),U())},placeholder:"Ask VyaparAI to draft a reply, create an order, etc...",className:"w-full bg-white dark:bg-gray-700 border-2 border-blue-400 rounded-full py-2 pl-10 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm",disabled:M}),M&&s.jsx(p.Z,{className:"absolute right-3 top-1/2 -translate-y-1/2 animate-spin text-gray-500",size:20})]}),q&&s.jsx("p",{className:"text-xs text-red-500 text-center mt-1",children:q})]})}),l&&(0,s.jsxs)("div",{className:"bg-white dark:bg-gray-700 p-2 rounded-t-lg text-sm relative border-l-2 border-blue-500 mb-2 shadow-sm",children:[s.jsx("button",{onClick:d,className:"absolute top-1 right-1 text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100",children:s.jsx(f.Z,{size:16})}),(0,s.jsxs)("p",{className:"font-semibold text-blue-600 dark:text-blue-400",children:["Replying to ","business"===l.from?"yourself":"the customer"]}),s.jsx("p",{className:"text-gray-600 dark:text-gray-300 truncate",children:l.text||"an attachment"})]}),S&&(0,s.jsxs)("div",{className:"bg-white dark:bg-gray-700 p-2 rounded-t-lg relative mb-2 shadow-sm flex items-center space-x-3",children:[s.jsx("button",{onClick:()=>{C(null),A(null),P.current&&(P.current.value="")},className:"absolute top-1 right-1 text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100",children:s.jsx(f.Z,{size:16})}),"document"===S?(0,s.jsxs)("div",{className:"flex items-center space-x-2 text-sm",children:[s.jsx(j.Z,{className:"w-8 h-8 text-blue-500"}),s.jsx("span",{className:"font-medium text-gray-700 dark:text-gray-200",children:k?.name})]}):s.jsx("img",{src:S,alt:"preview",className:"w-16 h-16 object-cover rounded-md"})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-3 bg-white dark:bg-[var(--input-background)] px-4 py-3 rounded-3xl shadow-sm",children:[s.jsx("button",{onClick:()=>I(!_),className:"p-2 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 rounded-full transition-colors",title:"Ask VyaparAI",children:s.jsx(b.Z,{className:"w-5 h-5"})}),(0,s.jsxs)("div",{className:"relative",children:[u&&s.jsx(E,{onSelectEmoji:a=>t(e+a),onClose:()=>g(!1)}),s.jsx("button",{onClick:()=>g(!u),className:"p-2 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 rounded-full transition-colors",children:s.jsx(v,{className:"w-5 h-5"})})]}),(0,s.jsxs)("div",{className:"relative",children:[h&&(0,s.jsxs)("div",{className:"absolute bottom-full mb-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 py-2",children:[(0,s.jsxs)("button",{onClick:()=>P.current?.click(),className:"flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700",children:[s.jsx(N.Z,{className:"w-4 h-4 mr-2 text-purple-500"})," Image"]}),(0,s.jsxs)("button",{onClick:()=>P.current?.click(),className:"flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700",children:[s.jsx(j.Z,{className:"w-4 h-4 mr-2 text-blue-500"})," Document"]})]}),s.jsx("button",{onClick:()=>y(!h),className:"p-2 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 rounded-full transition-colors",children:s.jsx(w,{className:"w-5 h-5"})})]}),s.jsx("input",{type:"file",ref:P,onChange:e=>{let t=e.target.files?.[0];t&&(C(t),t.type.startsWith("image/")?A(URL.createObjectURL(t)):A("document")),y(!1)},className:"hidden",accept:"image/jpeg,image/png,application/pdf,.doc,.docx"}),s.jsx("textarea",{ref:T,rows:1,value:e,onChange:e=>t(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),$())},placeholder:"Type a message...",className:"w-full bg-transparent focus:outline-none text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 resize-none max-h-32 overflow-y-auto",disabled:!!k}),s.jsx("button",{onClick:()=>$(),disabled:!e?.trim()&&!k,className:"p-3 bg-green-500 hover:bg-green-600 disabled:bg-gray-300 dark:disabled:bg-gray-600 rounded-full transition-colors flex-shrink-0",children:s.jsx(D.Z,{className:"w-5 h-5 text-white"})})]})]})};var A=a(98091);let P=({message:e,onClose:t,onConfirmDelete:a})=>s.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 animate-fade-in-up",style:{animationDuration:"0.2s"},children:(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-sm m-4",children:[(0,s.jsxs)("div",{className:"p-6",children:[s.jsx("h2",{className:"text-lg font-semibold text-gray-800",children:"Delete message?"}),s.jsx("div",{className:"my-4 p-3 bg-gray-100 rounded-md text-sm text-gray-700 truncate",children:e.text||e.fileName||"Attachment"})]}),(0,s.jsxs)("div",{className:"px-6 py-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg",children:[s.jsx("button",{onClick:t,className:"px-4 py-2 text-sm font-semibold text-gray-700 bg-transparent rounded-md hover:bg-gray-200 transition-colors",children:"Cancel"}),(0,s.jsxs)("button",{onClick:()=>a(e.id),className:"px-4 py-2 text-sm font-semibold text-red-600 bg-transparent rounded-md hover:bg-red-50 transition-colors flex items-center",children:[s.jsx(A.Z,{size:16,className:"mr-1.5"})," Delete for Everyone"]})]})]})}),T=(0,k.Z)("chevron-left",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]),_=(0,k.Z)("chevron-right",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]),I=({images:e,startIndex:t,onClose:a})=>{let[l,d]=(0,r.useState)(t),i=()=>{d(t=>0===t?e.length-1:t-1)},n=()=>{d(t=>t===e.length-1?0:t+1)};return(0,r.useEffect)(()=>{let e=e=>{"Escape"===e.key&&a(),"ArrowLeft"===e.key&&i(),"ArrowRight"===e.key&&n()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[e]),(0,s.jsxs)(m.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm",onClick:a,children:[s.jsx("button",{className:"absolute top-4 right-4 text-white/70 hover:text-white z-50",onClick:a,"aria-label":"Close gallery",children:s.jsx(f.Z,{size:32})}),e.length>1&&(0,s.jsxs)(s.Fragment,{children:[s.jsx("button",{className:"absolute left-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white z-50 bg-black/20 rounded-full p-2",onClick:e=>{e.stopPropagation(),i()},"aria-label":"Previous image",children:s.jsx(T,{size:32})}),s.jsx("button",{className:"absolute right-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white z-50 bg-black/20 rounded-full p-2",onClick:e=>{e.stopPropagation(),n()},"aria-label":"Next image",children:s.jsx(_,{size:32})})]}),s.jsx(x.M,{mode:"wait",children:s.jsx(m.E.img,{src:e[l].url,alt:`Product image ${l+1}`,className:"max-w-[90vw] max-h-[90vh] object-contain",initial:{opacity:.8,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:.8,scale:.95},transition:{duration:.2},onClick:e=>e.stopPropagation()},l)}),(0,s.jsxs)("div",{className:"absolute bottom-4 text-white/80 text-sm",children:[l+1," / ",e.length]})]})};var F=a(28676);let Z=({line:e})=>{if(""===e.trim())return s.jsx("div",{className:"h-3"});let t=e.trim(),a=!1;t.startsWith("* ")&&(a=!0,t=t.substring(2));let l=t.split("**");if(3===l.length&&""===l[0]&&""===l[2].trim())return s.jsx("h4",{className:"font-semibold text-base mt-4 mb-2 text-gray-900 dark:text-gray-100",children:l[1]});let d=l.map((e,t)=>t%2==1?s.jsx("strong",{className:"font-semibold text-gray-800 dark:text-gray-200",children:e},t):s.jsx(r.Fragment,{children:e},t));return a?(0,s.jsxs)("div",{className:"flex items-start pl-2",children:[s.jsx("span",{className:"mr-2 mt-1 text-gray-500 dark:text-gray-400",children:"â€¢"}),s.jsx("p",{className:"flex-1",children:d})]}):s.jsx("p",{children:d})},M=({isOpen:e,onClose:t,summary:a,isLoading:r})=>(0,s.jsxs)(F.Z,{isOpen:e,onClose:t,title:"Conversation Summary",children:[s.jsx("div",{className:"min-h-[200px] max-h-[60vh] overflow-y-auto pr-2",children:r?(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center h-full py-8",children:[s.jsx(p.Z,{className:"animate-spin text-blue-500",size:32}),s.jsx("p",{className:"mt-4 text-sm text-gray-500 dark:text-gray-400",children:"Generating summary..."})]}):s.jsx(m.E.div,{className:"text-sm text-gray-700 dark:text-gray-300 leading-relaxed",variants:{visible:{transition:{staggerChildren:.05}}},initial:"hidden",animate:"visible",children:a.split("\n").map((e,t)=>s.jsx(m.E.div,{variants:{hidden:{opacity:0,y:10},visible:{opacity:1,y:0}},children:s.jsx(Z,{line:e})},t))})}),s.jsx("div",{className:"flex justify-end mt-4 pt-4 border-t dark:border-gray-700",children:s.jsx("button",{onClick:t,className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Close"})})]});var O=a(48998),q=a(32933),z=a(67211),$=a(31540);let U=(0,k.Z)("reply",[["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}],["path",{d:"m9 17-5-5 5-5",key:"nvlc11"}]]),L=(0,k.Z)("star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]),R=(0,k.Z)("circle-plus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),B=(0,k.Z)("book-text",[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20",key:"k3hazp"}],["path",{d:"M8 11h8",key:"vwpz6n"}],["path",{d:"M8 7h6",key:"1f0q6e"}]]),H=(0,k.Z)("phone",[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]]),Q=(0,k.Z)("ellipsis-vertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);var J=a(34719);let V=({message:e,onImageClick:t})=>{let{product:a}=e;if(!a||!a.images||0===a.images.length)return(0,s.jsxs)("div",{className:"w-64 p-3 rounded-lg border bg-gray-50",children:[s.jsx("p",{className:"font-semibold text-sm",children:a?.name||"Product"}),s.jsx("p",{className:"text-xs text-gray-500",children:"Image not available"}),(0,s.jsxs)("p",{className:"font-bold text-green-700 mt-1",children:["â‚¹",a?.price.toLocaleString("en-IN")]})]});let r=a.images,l=r.length,d=r.slice(0,4),i=l-4;return(0,s.jsxs)("div",{className:"w-64 rounded-lg overflow-hidden relative shadow-md cursor-pointer",children:[1===l?s.jsx("div",{className:"aspect-square w-full",onClick:()=>t(r,0),children:s.jsx("img",{src:r[0].url,alt:a.name,className:"w-full h-full object-cover"})}):2===l?(0,s.jsxs)("div",{className:"grid grid-cols-2 aspect-square w-full gap-1",children:[s.jsx("img",{src:r[0].url,alt:`${a.name} 1`,className:"w-full h-full object-cover",onClick:()=>t(r,0)}),s.jsx("img",{src:r[1].url,alt:`${a.name} 2`,className:"w-full h-full object-cover",onClick:()=>t(r,1)})]}):3===l?(0,s.jsxs)("div",{className:"grid grid-cols-2 grid-rows-2 aspect-square w-full gap-1",children:[s.jsx("img",{src:r[0].url,alt:`${a.name} 1`,className:"w-full h-full object-cover col-span-1 row-span-2",onClick:()=>t(r,0)}),s.jsx("img",{src:r[1].url,alt:`${a.name} 2`,className:"w-full h-full object-cover",onClick:()=>t(r,1)}),s.jsx("img",{src:r[2].url,alt:`${a.name} 3`,className:"w-full h-full object-cover",onClick:()=>t(r,2)})]}):s.jsx("div",{className:"grid grid-cols-2 grid-rows-2 aspect-square w-full gap-1",children:d.map((e,l)=>(0,s.jsxs)("div",{className:"relative",onClick:()=>t(r,l),children:[s.jsx("img",{src:e.url,alt:`${a.name} ${l+1}`,className:"w-full h-full object-cover"}),3===l&&i>0&&s.jsx("div",{className:"absolute inset-0 bg-black/60 flex items-center justify-center",children:(0,s.jsxs)("span",{className:"text-white text-2xl font-bold",children:["+",i]})})]},e.id))}),(0,s.jsxs)("div",{className:"absolute inset-0 p-3 flex flex-col justify-end bg-gradient-to-t from-black/80 via-black/40 to-transparent pointer-events-none",children:[(0,s.jsxs)("div",{children:[s.jsx("h4",{className:"font-bold text-sm text-white [text-shadow:0_1px_2px_rgba(0,0,0,0.5)]",children:a.name}),(0,s.jsxs)("p",{className:"font-semibold text-white mt-1 text-base [text-shadow:0_1px_2px_rgba(0,0,0,0.5)]",children:["â‚¹",a.price.toLocaleString("en-IN")]})]}),(0,s.jsxs)("div",{className:"flex justify-end items-center text-xs text-white/80 mt-1 [text-shadow:0_1px_1px_rgba(0,0,0,0.5)]",children:[s.jsx("span",{children:(0,J.WU)(new Date(e.createdAt),"p")}),"business"===e.from&&(e=>{switch(e){case"pending":return s.jsx(O.Z,{size:16,className:"text-white/80 ml-1"});case"sent":return s.jsx(q.Z,{size:16,className:"text-white/80 ml-1"});case"delivered":return s.jsx(z.Z,{size:16,className:"text-white/80 ml-1"});case"read":return s.jsx(z.Z,{size:16,className:"text-[#53bdeb] ml-1"});case"failed":return s.jsx(f.Z,{size:16,className:"text-red-400 ml-1"});default:return null}})(e.status)]})]})]})},W=e=>e?"image"===e.type&&e.mediaUrl?e.mediaUrl:"product"===e.type&&e.product?.images?.[0]?.url?e.product.images[0].url:null:null,G=({chat:e,onPromoteCustomer:t,messages:a=[],onMessagesChange:l,initialMessage:d,initialNextCursor:i,onCreateOrder:n})=>{let[o,c]=(0,r.useState)(null),[g,h]=(0,r.useState)(null),[y,b]=(0,r.useState)(""),[j,k]=(0,r.useState)(null),v=(0,r.useRef)(null),N=(0,r.useRef)(null),w=(0,r.useRef)(null),D=(0,r.useRef)(0),[C,E]=(0,r.useState)(null),[A,T]=(0,r.useState)(!0),[_,F]=(0,r.useState)(!1),[Z,G]=(0,r.useState)([]),[Y,K]=(0,r.useState)(!1),[X,ee]=(0,r.useState)(""),[et,ea]=(0,r.useState)(!1),[es,er]=(0,r.useState)(!1);(0,r.useEffect)(()=>{E(i??null),T(!!i)},[i]);let el=a.length>0?a[a.length-1].id:null,ed=()=>{v.current?.scrollIntoView({behavior:"smooth"})};(0,r.useEffect)(()=>{ed()},[el]),(0,r.useEffect)(()=>{d&&e&&b(d)},[d,e?.id]);let ei=(0,r.useCallback)(async()=>{if(a&&0!==a.length){K(!0);try{let e=a.slice(-3).map(e=>`${"business"===e.from?"Business":"Customer"}: ${e.text||"[attachment]"}`).join("\n"),t=await fetch("/api/ai/smart-replies",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({history:e})});if(t.ok){let e=await t.json();G(e.replies||[])}}catch(e){console.error("Failed to fetch smart replies:",e),G([])}finally{K(!1)}}},[a]);(0,r.useEffect)(()=>{let e=a[a.length-1];e&&"customer"===e.from?ei():G([])},[a,ei]);let en=async()=>{if(a&&0!==a.length){er(!0),ea(!0),ee("");try{let e=a.map(e=>`${"business"===e.from?"Business":"Customer"}: ${e.text||"[attachment]"}`).join("\n"),t=await fetch("/api/ai/summarize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({history:e})});if(t.ok){let e=await t.json();ee(e.text)}else throw Error("Failed to generate summary.")}catch(e){console.error("Summarization error:",e),ee("Sorry, we couldn't generate a summary at this time.")}finally{ea(!1)}}},eo=(0,r.useCallback)(async()=>{if(!A||_||!C||!e)return;let t=N.current;t&&(D.current=t.scrollHeight),F(!0);try{let t=await fetch(`/api/messages?contactId=${e.id}&limit=30&cursor=${C}`);if(t.ok){let{messages:e,nextCursor:a}=await t.json();l(t=>[...e,...Array.isArray(t)?t:[]]),E(a),T(!!a)}}catch(e){console.error("Failed to load more messages:",e)}},[A,_,C,e,l]);(0,r.useLayoutEffect)(()=>{let e=N.current;e&&_&&(e.scrollTop=e.scrollHeight-D.current,F(!1))},[a.length,_]),(0,r.useEffect)(()=>{let e=new IntersectionObserver(([e])=>{e.isIntersecting&&A&&!_&&eo()},{threshold:1}),t=w.current;return t&&e.observe(t),()=>{t&&e.unobserve(t)}},[A,_,eo]);let ec=e=>{if(!e)return;let t=document.getElementById(`message-${e}`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("highlight-message"),setTimeout(()=>{t.classList.remove("highlight-message")},1500))},eu=e=>e?e.text?e.text:e.fileName?e.fileName:"image"===e.type?"\uD83D\uDCF7 Image":"document"===e.type?"\uD83D\uDCCE Document":e.product?.name?`ðŸ“¦ ${e.product.name}`:"an attachment":null,em=async(t,a)=>{if(!e||!t.trim()&&!a)return;let s=Date.now().toString();G([]);let r={id:s,from:"business",to:e.phone,text:a?a.name:t,createdAt:new Date().toISOString(),type:a?a.type.startsWith("image/")?"image":"document":"text",contactId:e.id,status:"pending",mediaUrl:a?URL.createObjectURL(a):void 0,fileName:a?a.name:void 0,replyToId:o?.id||null,replyToText:eu(o),replyToMediaUrl:W(o)};l(e=>Array.isArray(e)?[...e,r]:[r]),b(""),c(null);try{let r={contactId:e.id,text:t,replyingToId:o?.id||null};if(a){let e=new FormData;e.append("file",a);let t=await fetch("/api/uploads/file",{method:"POST",body:e}),s=await t.json();if(!t.ok)throw Error("File upload failed");r.mediaUrl=s.url,r.fileName=a.name,r.type=a.type.startsWith("image/")?"image":"document"}let d=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!d.ok){let e=await d.json();throw Error(e.error||"Failed to send message")}let i=await d.json();l(e=>{let t=Array.isArray(e)?e:[];return t.some(e=>e.id===i.id)?t.filter(e=>e.id!==s):t.map(e=>e.id===s?i:e)})}catch(e){console.error("Failed to send message:",e),l(e=>(Array.isArray(e)?e:[]).map(e=>e.id===s?{...e,status:"failed"}:e))}},ex=async e=>{h(null),l(t=>(Array.isArray(t)?t:[]).filter(t=>t.id!==e));try{(await fetch(`/api/messages/${e}`,{method:"DELETE"})).ok||l(a)}catch(e){l(a)}},eg=e=>{switch(e){case"pending":return s.jsx(O.Z,{size:16,className:"text-gray-500 dark:text-gray-400 ml-1"});case"sent":return s.jsx(q.Z,{size:16,className:"text-gray-500 dark:text-gray-400 ml-1"});case"delivered":return s.jsx(z.Z,{size:16,className:"text-gray-500 dark:text-gray-400 ml-1"});case"read":return s.jsx(z.Z,{size:16,className:"text-blue-500 ml-1"});case"failed":return s.jsx(f.Z,{size:16,className:"text-red-500 ml-1"});default:return null}},eh=(e,t)=>{k({images:e,startIndex:t})},ey=e=>{switch(e.type){case"image":return(0,s.jsxs)("div",{children:[e.mediaUrl&&s.jsx("img",{src:e.mediaUrl,alt:e.text||"Sent media",className:"rounded-md max-w-xs cursor-pointer",onClick:()=>eh([{id:e.id,url:e.mediaUrl}],0)}),e.text&&s.jsx("p",{className:"text-sm whitespace-pre-wrap mt-1",children:e.text})]});case"document":return(0,s.jsxs)("a",{href:e.mediaUrl,target:"_blank",rel:"noopener noreferrer",className:"flex items-center bg-black/5 dark:bg-black/20 p-2 rounded-lg hover:bg-black/10 dark:hover:bg-black/30",children:[s.jsx(u.Z,{name:"file",className:"w-8 h-8 text-gray-600 dark:text-gray-300 mr-2 flex-shrink-0"}),s.jsx("div",{className:"min-w-0",children:s.jsx("p",{className:"truncate font-medium",children:e.fileName||"Document"})}),s.jsx($.Z,{className:"w-5 h-5 ml-2 text-gray-500 dark:text-gray-400 flex-shrink-0"})]});case"product":if(!e.product)return(0,s.jsxs)("p",{className:"px-3 py-2 text-sm italic",children:["Product: ",e.text||"Details not available."]});return s.jsx(V,{message:e,onImageClick:eh});default:return s.jsx("p",{className:"text-sm whitespace-pre-wrap",children:e.text})}};return e?(0,s.jsxs)("div",{className:"w-full flex flex-col h-full",children:[(0,s.jsxs)("header",{className:"bg-white dark:bg-[var(--header-background)] p-4 border-b border-gray-200 dark:border-[var(--card-border)] shadow-sm flex items-center justify-between z-10",children:[(0,s.jsxs)("div",{className:"flex items-center",children:[s.jsx("div",{className:"w-10 h-10 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center justify-center mr-3",children:s.jsx("span",{className:"font-bold text-gray-600 dark:text-gray-300",children:(e.name||"?").charAt(0).toUpperCase()})}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[s.jsx("h2",{className:"font-semibold text-gray-800 dark:text-gray-100",children:e.name}),s.jsx("button",{onClick:t,title:e.isMasterCustomer?"Master Customer":"Promote to Master Customer",children:e.isMasterCustomer?s.jsx(L,{className:"text-yellow-500 fill-yellow-400",size:18}):s.jsx(R,{className:"text-gray-400 hover:text-blue-500",size:18})})]}),s.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:e.phone})]})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[s.jsx("button",{onClick:en,className:"p-2.5 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full",title:"Summarize Conversation",children:s.jsx(B,{size:20})}),s.jsx("button",{className:"p-2.5 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full",title:"Call Contact",children:s.jsx(H,{size:20})}),s.jsx("button",{className:"p-2.5 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full",title:"More Options",children:s.jsx(Q,{size:20})})]})]}),s.jsx("main",{className:"flex-1 relative chat-background",children:(0,s.jsxs)("div",{ref:N,className:"absolute inset-0 overflow-y-auto p-4",children:[s.jsx("div",{ref:w,className:"h-1"}),_&&s.jsx("div",{className:"text-center py-2",children:s.jsx(p.Z,{className:"animate-spin text-gray-500"})}),s.jsx(x.M,{children:(()=>{let e=Array.isArray(a)?a:[],t=null;return e.map((e,a)=>{let r=(0,J.WU)(new Date(e.createdAt),"yyyy-MM-dd"),l=r!==t;t=r;let d="business"===e.from,i="product"===e.type&&!!e.product;return(0,s.jsxs)(m.E.div,{initial:{opacity:0,y:10,x:d?10:-10},animate:{opacity:1,y:0,x:0},exit:{opacity:0,scale:.95,transition:{duration:.2}},transition:{type:"spring",stiffness:200,damping:25},children:[l&&s.jsx("div",{className:"text-center my-4",children:s.jsx("span",{className:"bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow text-gray-600 dark:text-gray-300 text-xs font-semibold px-3 py-1 rounded-full",children:(0,J.WU)(new Date(e.createdAt),"MMMM d, yyyy")})}),s.jsx("div",{id:`message-${e.id}`,className:`flex ${d?"justify-end":"justify-start"} mt-1`,children:(0,s.jsxs)("div",{className:`flex items-end gap-2 group ${d?"flex-row-reverse":"flex-row"}`,children:[(0,s.jsxs)("div",{className:`chat-bubble ${d?"outgoing":"incoming"} 
                                 ${i?"p-0 overflow-hidden bg-transparent shadow-none":""}`,children:[e.replyToId&&s.jsx("div",{onClick:()=>ec(e.replyToId),className:"text-xs bg-black/5 dark:bg-black/20 p-1.5 rounded-t-md mb-1 border-l-2 border-blue-500 cursor-pointer overflow-hidden",children:(0,s.jsxs)("div",{className:"flex items-start gap-2",children:[e.replyToMediaUrl&&s.jsx("img",{src:e.replyToMediaUrl,alt:"reply preview",className:"w-10 h-10 object-cover rounded-sm flex-shrink-0"}),s.jsx("div",{className:"flex-1 min-w-0",children:s.jsx("p",{className:"truncate",children:e.replyToText})})]})}),ey(e),!i&&(0,s.jsxs)("div",{className:"flex justify-end items-center text-xs mt-1 text-gray-500 dark:text-gray-400",children:[s.jsx("span",{children:(0,J.WU)(new Date(e.createdAt),"p")}),d&&eg(e.status)]})]}),(0,s.jsxs)("div",{className:"flex opacity-0 group-hover:opacity-100 transition-opacity self-center",children:[s.jsx("button",{onClick:()=>c(e),className:"p-1 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full",title:"Reply",children:s.jsx(U,{size:16})}),d&&s.jsx("button",{onClick:()=>h(e),className:"p-1 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full",title:"Delete Message",children:s.jsx(u.Z,{name:"trash2",size:16})})]})]})})]},e.id)})})()}),s.jsx("div",{ref:v})]})}),s.jsx(S,{newMessage:y,setNewMessage:b,sendMessage:em,messages:a,smartReplies:Z,isFetchingReplies:Y,replyingTo:o?{text:eu(o),from:o.from}:null,onCancelReply:()=>c(null),onCreateOrder:n}),g&&s.jsx(P,{message:g,onClose:()=>h(null),onConfirmDelete:ex}),j&&s.jsx(I,{images:j.images,startIndex:j.startIndex,onClose:()=>k(null)}),s.jsx(M,{isOpen:es,onClose:()=>er(!1),summary:X,isLoading:et})]}):(0,s.jsxs)("div",{className:"w-full chat-background flex flex-col items-center justify-center text-center h-full",children:[s.jsx(u.Z,{name:"messageCircle",size:48,className:"mx-auto text-gray-400 dark:text-gray-500"}),s.jsx("h2",{className:"text-2xl font-medium mt-4 text-gray-700 dark:text-gray-200",children:"Welcome to VyaparConnect"}),s.jsx("p",{className:"mt-2 text-gray-500 dark:text-gray-400",children:"Select a chat to start messaging."})]})},Y=({socket:e,contacts:t,setContacts:a,activeContact:r,onSelectContact:l,onPromoteCustomer:d,messages:i,setMessages:n,initialMessage:o,initialCursor:c,onCreateOrder:u})=>(0,s.jsxs)("div",{className:"flex h-full bg-white overflow-hidden",children:[s.jsx(y,{socket:e,activeContactId:r?.id||null,onSelectChat:l}),s.jsx("div",{className:"flex-1 flex flex-col min-w-0",children:s.jsx(G,{chat:r,onPromoteCustomer:d,messages:i,onMessagesChange:n,initialMessage:o,initialNextCursor:c,onCreateOrder:u})})]}),K=(0,k.Z)("arrow-left",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);var X=a(83855),ee=a(48705),et=a(36283);let ea=(0,k.Z)("lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]),es=(0,k.Z)("user-check",[["path",{d:"m16 11 2 2 4-4",key:"9rsbq5"}],["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]]),er={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.05}}},el={hidden:{opacity:0,y:15},visible:{opacity:1,y:0}},ed=({workflow:e})=>{let t={QUOTATION_FOCUSED:{label:"Q",color:"bg-green-100 text-green-800",title:"Quotation Specific"},ORDER_FOCUSED:{label:"O",color:"bg-orange-100 text-orange-800",title:"Order Specific"},HYBRID:{label:"H",color:"bg-blue-100 text-blue-800",title:"Hybrid"}}[e];return t?s.jsx("span",{title:t.title,className:`text-[10px] font-bold h-4 w-4 flex items-center justify-center rounded-full ml-2 flex-shrink-0 ${t.color}`,children:t.label}):null},ei=({products:e,onShareProduct:t,onEditProduct:a,onDeleteProduct:r})=>0===e.length?s.jsx("p",{className:"p-4 text-center text-gray-500",children:"No products found for this workspace."}):s.jsx(m.E.div,{className:"p-2",variants:er,initial:"hidden",animate:"visible",children:e.map(e=>(0,s.jsxs)(m.E.div,{variants:el,layout:!0,className:"p-2 mb-2 border dark:border-gray-700 rounded-lg flex items-center hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[s.jsx("img",{src:e.imageUrl,alt:e.name,className:"w-16 h-16 object-cover rounded-md mr-3 flex-shrink-0"}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex items-center",children:[s.jsx("h3",{className:"font-semibold text-sm truncate",children:e.name}),s.jsx(ed,{workflow:e.workflow})]}),(0,s.jsxs)("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:["â‚¹",e.price.toLocaleString()]})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-1 ml-2",children:[s.jsx("button",{onClick:()=>t(e),className:"p-2 text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-full",title:"Share Product",children:s.jsx(u.Z,{name:"share2",size:16})}),s.jsx("button",{onClick:()=>a(e),className:"p-2 text-gray-500 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-full",title:"Edit Product",children:s.jsx(u.Z,{name:"edit",size:16})}),s.jsx("button",{onClick:()=>r(e),className:"p-2 text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-full",title:"Delete Product",children:s.jsx(u.Z,{name:"trash2",size:16})})]})]},e.id))});var en=a(69508);let eo=(0,k.Z)("refresh-cw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]),ec=({children:e,color:t})=>s.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${{green:"bg-green-100 text-green-800",gray:"bg-gray-200 text-gray-800",red:"bg-red-100 text-red-800",yellow:"bg-yellow-100 text-yellow-800"}[t]}`,children:e}),eu=e=>{switch(e){case"PAID":case"BILLED":case"CONFIRMED":return"green";case"PARTIALLY_PAID":return"yellow";case"CANCELLED":return"red";default:return"gray"}},em={hidden:{},visible:{transition:{staggerChildren:.07}}},ex={hidden:{y:15,opacity:0},visible:{y:0,opacity:1}},eg=({contactId:e,onNewQuote:t,onBillQuote:a,onSendDraft:l,onSetFollowUp:d})=>{let[i,n]=(0,r.useState)([]),[o,c]=(0,r.useState)(!0),[u,x]=(0,r.useState)(null),[g,h]=(0,r.useState)(null),y=async()=>{c(!0);try{let t=await fetch(`/api/quotations?contactId=${e}`);t.ok&&n(await t.json())}catch(e){console.error("Failed to fetch quotations:",e)}finally{c(!1)}};(0,r.useEffect)(()=>{e&&y()},[e]);let b=async()=>{if(u){h(u.id);try{if(!(await fetch(`/api/quotations/${u.id}`,{method:"DELETE"})).ok)throw Error("Failed to delete quotation");n(e=>e.filter(e=>e.id!==u.id)),x(null)}catch(e){console.error(e)}finally{h(null)}}},f=e=>{switch(e.status){case"DRAFT":return(0,s.jsxs)("button",{onClick:()=>l(e),className:"flex items-center text-blue-600 text-sm font-semibold hover:underline",children:[s.jsx(D.Z,{size:14,className:"mr-1"})," Review & Send"]});case"SENT":return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("button",{onClick:()=>d(e),className:"flex items-center text-orange-600 text-sm font-semibold hover:underline",children:[s.jsx(O.Z,{size:14,className:"mr-1"})," Set Follow-up"]}),(0,s.jsxs)("button",{onClick:()=>a(e),className:"flex items-center text-green-600 text-sm font-semibold hover:underline ml-2",children:[s.jsx(en.Z,{size:14,className:"mr-1"})," Finalize & Bill"]})]});case"CONFIRMED":return(0,s.jsxs)("button",{onClick:()=>a(e),className:"flex items-center text-green-600 text-sm font-semibold hover:underline",children:[s.jsx(D.Z,{size:14,className:"mr-1"})," Finalize & Bill"]});case"BILLED":case"PARTIALLY_PAID":return(0,s.jsxs)("button",{onClick:()=>a(e),className:"flex items-center text-blue-600 text-sm font-semibold hover:underline",children:[s.jsx(en.Z,{size:14,className:"mr-1"})," Manage Payments"]});case"PAID":return s.jsx("span",{className:"text-sm font-semibold text-gray-400",children:"Paid in full"});case"CANCELLED":return s.jsx("span",{className:"text-sm font-semibold text-gray-400",children:"Cancelled"});default:return null}};return(0,s.jsxs)("div",{className:"p-4",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[s.jsx("h3",{className:"font-bold text-lg",children:"Quotation History"}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[s.jsx("button",{onClick:y,disabled:o,className:"p-2 text-gray-500 hover:bg-gray-100 rounded-full disabled:opacity-50",children:s.jsx(eo,{size:16,className:o?"animate-spin":""})}),(0,s.jsxs)("button",{onClick:t,className:"flex items-center bg-blue-600 text-white text-sm px-3 py-2 rounded-md hover:bg-blue-700",children:[s.jsx(X.Z,{size:16,className:"mr-1"})," New"]})]})]}),o?s.jsx("p",{className:"text-sm text-gray-500 text-center py-8",children:"Loading..."}):0===i.length?s.jsx("p",{className:"text-sm text-gray-500 text-center py-8",children:"No quotations found for this contact."}):s.jsx(m.E.ul,{className:"space-y-3",variants:em,initial:"hidden",animate:"visible",children:i.map(e=>(0,s.jsxs)(m.E.li,{variants:ex,className:"p-3 border dark:border-gray-700 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[(0,s.jsxs)("div",{className:"flex justify-between items-start",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("p",{className:"font-semibold text-sm",children:["Quotation #",e.id.substring(0,6)]}),s.jsx("p",{className:"text-xs text-gray-500",children:(0,J.WU)(new Date(e.createdAt),"PP")})]}),s.jsx(ec,{color:eu(e.status),children:e.status.replace("_"," ")})]}),(0,s.jsxs)("div",{className:"flex justify-between items-end mt-2",children:[(0,s.jsxs)("p",{className:"text-lg font-bold",children:["â‚¹",e.total.toLocaleString("en-IN")]}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[f(e),s.jsx("button",{onClick:()=>x(e),className:"p-1.5 text-gray-400 hover:bg-red-100 hover:text-red-600 rounded-full dark:hover:bg-red-900/30",title:"Delete Quotation",disabled:!!g,children:g===e.id?s.jsx(p.Z,{className:"animate-spin",size:16}):s.jsx(A.Z,{size:16})})]})]})]},e.id))}),u&&(0,s.jsxs)(F.Z,{isOpen:!!u,onClose:()=>x(null),title:"Confirm Deletion",children:[(0,s.jsxs)("p",{children:["Are you sure you want to delete Quotation ",(0,s.jsxs)("strong",{children:["#",u.id.substring(0,6)]}),"? This action cannot be undone."]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-2 mt-4",children:[s.jsx("button",{onClick:()=>x(null),className:"px-4 py-2 border dark:border-gray-600 rounded-md",children:"Cancel"}),s.jsx("button",{onClick:b,className:"px-4 py-2 bg-red-600 text-white rounded-md",disabled:!!g,children:g?"Deleting...":"Delete"})]})]})]})},eh=(0,k.Z)("link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]),ey=(0,k.Z)("banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]),ep=(0,k.Z)("qr-code",[["rect",{width:"5",height:"5",x:"3",y:"3",rx:"1",key:"1tu5fj"}],["rect",{width:"5",height:"5",x:"16",y:"3",rx:"1",key:"1v8r4q"}],["rect",{width:"5",height:"5",x:"3",y:"16",rx:"1",key:"1x03jg"}],["path",{d:"M21 16h-3a2 2 0 0 0-2 2v3",key:"177gqh"}],["path",{d:"M21 21v.01",key:"ents32"}],["path",{d:"M12 7v3a2 2 0 0 1-2 2H7",key:"8crl2c"}],["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M12 3h.01",key:"n36tog"}],["path",{d:"M12 16v.01",key:"133mhm"}],["path",{d:"M16 12h1",key:"1slzba"}],["path",{d:"M21 12v.01",key:"1lwtk9"}],["path",{d:"M12 21v-1",key:"1880an"}]]),eb=({quotation:e,onBack:t,onFinalized:a,socket:l})=>{let[d,i]=(0,r.useState)(e),[n,o]=(0,r.useState)(d.discountPercentage||0),[c,u]=(0,r.useState)(d.taxRate||0),[m,x]=(0,r.useState)(d.deliveryCharges||0),[g,h]=(0,r.useState)(d.total),[y,b]=(0,r.useState)(d.payments||[]),[f,j]=(0,r.useState)(!1),[k,v]=(0,r.useState)(null),[N,w]=(0,r.useState)(""),[C,E]=(0,r.useState)(!1),[S,A]=(0,r.useState)({amount:"",method:"Cash",notes:""}),P=y.reduce((e,t)=>e+t.amount,0),T=g-P,_="DRAFT"!==d.status&&"SENT"!==d.status&&"CONFIRMED"!==d.status;(0,r.useEffect)(()=>{let e=d.subtotal,t=e*n/100,a=e-t,s=a*c/100;h(a+s+m)},[n,c,m,d.subtotal]);let I=async()=>{try{let e=await fetch(`/api/quotations/${d.id}/payments`);if(e.ok){let t=await e.json();b(t)}}catch(e){console.error(e)}};(0,r.useEffect)(()=>{if(I(),l){let e=e=>{e.id===d.id&&(i(e),b(e.payments||[]))};return l.on("quotation_update",e),()=>{l.off("quotation_update",e)}}},[d.id,l]);let Z=async()=>{j(!0),w("");try{let e=await fetch(`/api/quotations/${d.id}/finalize`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({discountPercentage:n,taxRate:c,deliveryCharges:m,total:g})});if(!e.ok)throw Error("Failed to save bill.");let t=await e.json();i(t)}catch(e){w(e.message)}finally{j(!1)}},M=async(e,t)=>{v(e),w("");try{let a={action:e};void 0!==t&&t>0&&(a.amount=t);let s=await fetch(`/api/quotations/${d.id}/send-bill-action`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok){let e=await s.json();throw Error(e.error||"Action failed.")}}catch(e){w(e.message)}finally{v(null)}},O=async e=>{e.preventDefault(),j(!0),w("");try{let e=await fetch(`/api/quotations/${d.id}/payments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...S,amount:parseFloat(S.amount)})}),t=await e.json();if(!e.ok)throw Error(t.error||"Failed to add payment.");i(e=>e?{...e,status:t.status,payments:t.payments}:t),b(t.payments||[]),E(!1),A({amount:"",method:"Cash",notes:""})}catch(e){w(e.message)}finally{j(!1)}};return(0,s.jsxs)("div",{className:"p-4 space-y-4",children:[N&&s.jsx("p",{className:"text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-300 p-2 rounded-md text-sm mb-2",children:N}),(0,s.jsxs)("div",{className:"p-3 border dark:border-gray-700 rounded-lg space-y-3",children:[s.jsx("h4",{className:"font-semibold text-sm text-gray-800 dark:text-gray-100",children:"Final Bill Calculation"}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Discount (%)"}),s.jsx("input",{type:"number",value:n,onChange:e=>o(parseFloat(e.target.value)||0),className:"w-full border rounded-md p-1.5 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",disabled:_})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Tax / GST (%)"}),s.jsx("input",{type:"number",value:c,onChange:e=>u(parseFloat(e.target.value)||0),className:"w-full border rounded-md p-1.5 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",disabled:_})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Delivery Charges (â‚¹)"}),s.jsx("input",{type:"number",value:m,onChange:e=>x(parseFloat(e.target.value)||0),className:"w-full border rounded-md p-1.5 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",disabled:_})]}),(0,s.jsxs)("div",{className:"text-right font-bold text-lg text-gray-800 dark:text-gray-100",children:["Total: â‚¹",g.toFixed(2)]}),!_&&s.jsx("button",{onClick:Z,disabled:f,className:"w-full bg-blue-600 text-white py-2 rounded-md text-sm font-semibold disabled:opacity-50",children:f?"Saving...":"Save & Lock Bill"})]}),_&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"p-3 border dark:border-gray-700 rounded-lg",children:[s.jsx("h4",{className:"font-semibold text-sm mb-2 text-gray-800 dark:text-gray-100",children:"Payment Status"}),(0,s.jsxs)("div",{className:"text-sm space-y-1 text-gray-700 dark:text-gray-300",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Total Bill:"})," ",(0,s.jsxs)("span",{className:"font-bold text-gray-800 dark:text-gray-100",children:["â‚¹",g.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Total Paid:"})," ",(0,s.jsxs)("span",{className:"font-bold text-green-600 dark:text-green-400",children:["â‚¹",P.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Amount Due:"})," ",(0,s.jsxs)("span",{className:"font-bold text-red-600 dark:text-red-400",children:["â‚¹",T.toFixed(2)]})]})]}),s.jsx("div",{className:"mt-2 text-xs text-gray-500 dark:text-gray-400 max-h-24 overflow-y-auto",children:y.map(e=>(0,s.jsxs)("div",{className:"flex justify-between items-center border-t dark:border-gray-600 py-1",children:[(0,s.jsxs)("span",{children:[e.method," (",(0,J.WU)(new Date(e.createdAt),"PP"),")"]}),(0,s.jsxs)("span",{children:["â‚¹",e.amount.toFixed(2)]})]},e.id))}),(0,s.jsxs)("button",{onClick:()=>E(!0),className:"w-full mt-3 flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 py-2 rounded-md",children:[s.jsx(X.Z,{size:16,className:"mr-1"})," Record Manual Payment"]})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[s.jsx("h4",{className:"font-semibold text-sm pt-2 text-gray-800 dark:text-gray-100",children:"Payment Actions"}),s.jsx("button",{onClick:()=>M("send_final_bill"),disabled:!!k,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_final_bill"===k?s.jsx(p.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(D.Z,{size:16,className:"mr-2"})," Send Bill Image"]})}),s.jsx("button",{onClick:()=>M("send_razorpay",T),disabled:!!k||T<=0,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_razorpay"===k?s.jsx(p.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(eh,{size:16,className:"mr-2"})," Send Payment Link"]})}),s.jsx("button",{onClick:()=>M("send_bank_details",T),disabled:!!k||T<=0,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_bank_details"===k?s.jsx(p.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(ey,{size:16,className:"mr-2"})," Send Bank Details"]})}),s.jsx("button",{onClick:()=>M("send_qr_code",T),disabled:!!k||T<=0,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_qr_code"===k?s.jsx(p.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(ep,{size:16,className:"mr-2"})," Send UPI QR Code"]})})]})]}),s.jsx(F.Z,{isOpen:C,onClose:()=>E(!1),title:"Record Manual Payment",children:(0,s.jsxs)("form",{onSubmit:O,className:"space-y-3",children:[(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Amount"}),s.jsx("input",{type:"number",placeholder:"Amount paid",value:S.amount,onChange:e=>A(t=>({...t,amount:e.target.value})),required:!0,className:"w-full border rounded-md p-2 text-sm mt-1 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Method"}),(0,s.jsxs)("select",{value:S.method,onChange:e=>A(t=>({...t,method:e.target.value})),className:"w-full border rounded-md p-2 text-sm mt-1 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",children:[s.jsx("option",{children:"Cash"})," ",s.jsx("option",{children:"Bank Transfer"})," ",s.jsx("option",{children:"UPI"})," ",s.jsx("option",{children:"Other"})]})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Notes (Optional)"}),s.jsx("input",{type:"text",placeholder:"e.g., Transaction ID",value:S.notes,onChange:e=>A(t=>({...t,notes:e.target.value})),className:"w-full border rounded-md p-2 text-sm mt-1 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"})]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2 pt-2",children:[s.jsx("button",{type:"button",onClick:()=>E(!1),className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:f,className:"px-4 py-2 text-sm bg-green-600 text-white rounded-md disabled:opacity-50",children:f?"Adding...":"Add Payment"})]})]})})]})};function ef(e,t){switch(t.type){case"UPDATE_FIELD":return{...e,[t.field]:t.payload};case"UPDATE_ITEM":{let a=[...e.items];return a[t.index][t.field]=t.payload,"productId"===t.field&&t.product&&(a[t.index].price=t.product.price,a[t.index].name=t.product.name),{...e,items:a}}case"ADD_ITEM":return{...e,items:[...e.items,{productId:"",quantity:1,price:0}]};case"REMOVE_ITEM":return{...e,items:e.items.filter((e,a)=>a!==t.index)};default:return e}}let ej=({contact:e,onCancel:t,onQuotationCreated:a})=>{let l={customerName:e.name,contactNumber:e.phone,billingAddress:e.lastBillingAddress||e.lastAddress||"",shippingAddress:e.lastShippingAddress||e.shippingAddress||"",items:[{productId:"",quantity:1,price:0}]},[d,i]=(0,r.useReducer)(ef,l),[n,o]=(0,r.useState)([]),[c,u]=(0,r.useState)(!1),[m,x]=(0,r.useState)("");(0,r.useEffect)(()=>{(async()=>{let e=await fetch("/api/products");e.ok&&o(await e.json())})()},[]);let g=(e,t,a)=>{let s;"productId"===t&&(s=n.find(e=>e.id===a)),i({type:"UPDATE_ITEM",index:e,field:t,payload:a,product:s})},h=e=>i({type:"REMOVE_ITEM",index:e}),y=d.items.reduce((e,t)=>e+(t.quantity||0)*(t.price||0),0),p=async t=>{t.preventDefault(),u(!0),x("");try{let{customerName:t,contactNumber:s,billingAddress:r,shippingAddress:l,items:i}=d,n=await fetch("/api/quotations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contactId:e.id,customerName:t,contactNumber:s,billingAddress:r,shippingAddress:l,items:i.map(({name:e,...t})=>t).filter(e=>e.productId),subtotal:y,total:y,status:"DRAFT"})});if(!n.ok){let e=await n.json();throw Error(e.error||"Failed to create quotation")}let o=await n.json();a(o)}catch(e){x(e.message)}finally{u(!1)}};return(0,s.jsxs)("form",{onSubmit:p,className:"p-4",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[s.jsx("h3",{className:"font-bold text-lg text-gray-800 dark:text-gray-100",children:"New Quotation"}),s.jsx("button",{type:"button",onClick:t,className:"text-gray-500 dark:text-gray-300",children:s.jsx(f.Z,{size:20})})]}),m&&s.jsx("p",{className:"text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-300 p-2 rounded-md text-sm mb-4",children:m}),(0,s.jsxs)("div",{className:"space-y-3 text-sm",children:[s.jsx("input",{type:"text",value:d.customerName,onChange:e=>i({type:"UPDATE_FIELD",field:"customerName",payload:e.target.value}),placeholder:"Customer Name",className:"w-full border rounded-md p-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",required:!0}),s.jsx("input",{type:"text",value:d.contactNumber,onChange:e=>i({type:"UPDATE_FIELD",field:"contactNumber",payload:e.target.value}),placeholder:"Contact Number",className:"w-full border rounded-md p-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",required:!0}),s.jsx("textarea",{value:d.billingAddress,onChange:e=>i({type:"UPDATE_FIELD",field:"billingAddress",payload:e.target.value}),placeholder:"Billing Address",className:"w-full border rounded-md p-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",rows:2,required:!0}),s.jsx("textarea",{value:d.shippingAddress,onChange:e=>i({type:"UPDATE_FIELD",field:"shippingAddress",payload:e.target.value}),placeholder:"Shipping Address",className:"w-full border rounded-md p-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",rows:2,required:!0})]}),(0,s.jsxs)("div",{className:"mt-4",children:[s.jsx("h4",{className:"font-semibold mb-2 text-gray-800 dark:text-gray-100",children:"Products"}),d.items.map((e,t)=>(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,s.jsxs)("select",{value:e.productId??"",onChange:e=>g(t,"productId",e.target.value),className:"w-1/2 border rounded-md p-2 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",required:!0,children:[s.jsx("option",{value:"",children:"Select Product"}),n.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]}),s.jsx("input",{type:"number",value:e.quantity,onChange:e=>g(t,"quantity",parseInt(e.target.value,10)),min:"1",className:"w-1/4 border rounded-md p-2 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"}),(0,s.jsxs)("span",{className:"w-1/4 text-gray-700 dark:text-gray-300",children:["@ â‚¹",e.price?.toFixed(2)]}),s.jsx("button",{type:"button",onClick:()=>h(t),children:s.jsx(A.Z,{size:16,className:"text-red-500 hover:text-red-600"})})]},t)),(0,s.jsxs)("button",{type:"button",onClick:()=>i({type:"ADD_ITEM"}),className:"flex items-center text-sm text-blue-600 dark:text-blue-400 mt-2",children:[s.jsx(X.Z,{size:16,className:"mr-1"})," Add Item"]})]}),(0,s.jsxs)("div",{className:"mt-4 text-right font-bold text-gray-800 dark:text-gray-100",children:["Subtotal: â‚¹",y.toFixed(2)]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2 mt-4",children:[s.jsx("button",{type:"button",onClick:t,className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:c,className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-md disabled:opacity-50 flex items-center justify-center",children:c?"Generating...":"Generate & Preview"})]})]})},ek=(0,k.Z)("bell",[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}]]);var ev=a(67597);let eN=({quotation:e,onCancel:t,onSuccess:a})=>{let[l,d]=(0,r.useState)((0,J.WU)((0,ev.E)(new Date,3),"yyyy-MM-dd'T'HH:mm")),i=`Follow up with ${e.customerName} about Quotation #${e.id.substring(0,6)}.`,n=`Hi ${e.customerName}, this is a friendly follow-up regarding the quotation for â‚¹${e.total.toLocaleString("en-IN")} we sent you recently. Please let us know if you have any questions or are ready to proceed. Thank you!`,[o,c]=(0,r.useState)(i),[u,m]=(0,r.useState)(n),[x,g]=(0,r.useState)(!1),[h,y]=(0,r.useState)(""),b=async t=>{t.preventDefault(),g(!0),y("");try{let t=await fetch(`/api/contacts/${e.contactId}/reminders`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({remindAt:new Date(l).toISOString(),ownerMessage:o,customerMessage:u,quotationId:e.id})});if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to set reminder.")}a()}catch(e){y(e.message)}finally{g(!1)}};return(0,s.jsxs)("form",{onSubmit:b,className:"p-4 space-y-4",children:[h&&s.jsx("p",{className:"text-red-600 bg-red-50 p-2 rounded-md text-sm",children:h}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium",children:"Remind on"}),s.jsx("input",{type:"datetime-local",value:l,onChange:e=>d(e.target.value),className:"mt-1 w-full border rounded-md p-2 text-sm dark:bg-gray-700 dark:border-gray-600",required:!0})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium",children:"Internal Note (for you)"}),s.jsx("textarea",{value:o,onChange:e=>c(e.target.value),rows:2,className:"mt-1 w-full border rounded-md p-2 text-sm dark:bg-gray-700 dark:border-gray-600",required:!0})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium",children:"Automated Message (to customer)"}),s.jsx("textarea",{value:u,onChange:e=>m(e.target.value),rows:4,className:"mt-1 w-full border rounded-md p-2 text-sm dark:bg-gray-700 dark:border-gray-600"}),s.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Leave blank to not send an automated message."})]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2 pt-2",children:[s.jsx("button",{type:"button",onClick:t,className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md",children:"Cancel"}),(0,s.jsxs)("button",{type:"submit",disabled:x,className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-md disabled:opacity-50 flex items-center",children:[x?s.jsx(p.Z,{className:"animate-spin mr-2"}):s.jsx(ek,{className:"mr-2",size:16}),"Set Reminder"]})]})]})};function ew(e,t){switch(t.type){case"UPDATE_FIELD":return{...e,[t.field]:t.payload};case"ADD_ITEM":return{...e,items:[...e.items,{id:Date.now(),productName:"",quantity:"1",price:"0"}]};case"REMOVE_ITEM":return{...e,items:e.items.filter(e=>e.id!==t.id)};case"UPDATE_ITEM":return{...e,items:e.items.map(e=>e.id===t.id?{...e,[t.field]:t.payload}:e)};default:return e}}let eD=({contact:e,onCancel:t,onOrderCreated:a,suggestedAddress:l})=>{let d={customerName:e.name,billingAddress:e.lastBillingAddress||e.lastAddress||"",shippingAddress:e.lastShippingAddress||e.shippingAddress||"",items:[{id:Date.now(),productName:"",quantity:"1",price:"0"}],discountPercentage:"0",deliveryCharges:"0"},[i,n]=(0,r.useReducer)(ew,d),[o,c]=(0,r.useState)([]),[u,m]=(0,r.useState)(!1),[x,g]=(0,r.useState)("");(0,r.useEffect)(()=>{(async()=>{let e=await fetch("/api/products");e.ok&&c(await e.json())})()},[]),(0,r.useEffect)(()=>{l&&n({type:"UPDATE_FIELD",field:"shippingAddress",payload:l})},[l]);let h=(e,t)=>{let a=o.find(e=>e.name.toLowerCase()===t.toLowerCase());a?(n({type:"UPDATE_ITEM",id:e,field:"productName",payload:a.name}),n({type:"UPDATE_ITEM",id:e,field:"productId",payload:a.id}),n({type:"UPDATE_ITEM",id:e,field:"price",payload:a.price.toString()})):(n({type:"UPDATE_ITEM",id:e,field:"productName",payload:t}),n({type:"UPDATE_ITEM",id:e,field:"productId",payload:void 0}))},y=i.items.reduce((e,t)=>e+(parseFloat(t.quantity)||0)*(parseFloat(t.price)||0),0),b=y*(parseFloat(i.discountPercentage)||0)/100,f=y-b+(parseFloat(i.deliveryCharges)||0),j=async t=>{t.preventDefault(),m(!0),g("");let s=i.items.filter(e=>e.productName.trim()&&parseFloat(e.price)>=0).map(e=>({...e,price:parseFloat(e.price)}));if(0===s.length){g("Please add at least one valid item."),m(!1);return}try{let t=await fetch("/api/orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contactId:e.id,customerName:i.customerName,contactNumber:e.phone,billingAddress:i.billingAddress,shippingAddress:i.shippingAddress,items:s,subtotal:y,total:f,discountPercentage:parseFloat(i.discountPercentage)||0,deliveryCharges:parseFloat(i.deliveryCharges)||0})});if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to create order")}let r=await t.json();a(r)}catch(e){g(e.message)}finally{m(!1)}};return(0,s.jsxs)("form",{onSubmit:j,className:"p-4",children:[s.jsx("h3",{className:"font-bold text-lg text-gray-800 dark:text-gray-100 mb-4",children:"New Order"}),x&&s.jsx("p",{className:"text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-300 p-2 rounded-md text-sm mb-4",children:x}),(0,s.jsxs)("div",{className:"space-y-3 text-sm",children:[s.jsx("input",{type:"text",value:i.customerName,onChange:e=>n({type:"UPDATE_FIELD",field:"customerName",payload:e.target.value}),placeholder:"Customer Name",className:"w-full border rounded-md p-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",required:!0}),s.jsx("textarea",{value:i.billingAddress,onChange:e=>n({type:"UPDATE_FIELD",field:"billingAddress",payload:e.target.value}),placeholder:"Billing Address",className:"w-full border rounded-md p-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",rows:2,required:!0}),s.jsx("textarea",{value:i.shippingAddress,onChange:e=>n({type:"UPDATE_FIELD",field:"shippingAddress",payload:e.target.value}),placeholder:"Shipping Address",className:"w-full border rounded-md p-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",rows:2,required:!0})]}),(0,s.jsxs)("div",{className:"mt-4",children:[s.jsx("h4",{className:"font-semibold mb-2 text-gray-800 dark:text-gray-100",children:"Items"}),s.jsx("div",{className:"space-y-2",children:i.items.map(e=>(0,s.jsxs)("div",{className:"grid grid-cols-[1fr,80px,80px,100px,auto] gap-2 items-center",children:[s.jsx("input",{list:"product-list",type:"text",value:e.productName,onChange:t=>h(e.id,t.target.value),placeholder:"Product Name",className:"w-full border rounded-md p-2 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",required:!0}),s.jsx("input",{type:"text",value:e.quantity,onChange:t=>n({type:"UPDATE_ITEM",id:e.id,field:"quantity",payload:t.target.value}),placeholder:"Qty",className:"w-full border rounded-md p-2 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",required:!0}),s.jsx("input",{type:"number",value:e.price,onChange:t=>n({type:"UPDATE_ITEM",id:e.id,field:"price",payload:t.target.value}),placeholder:"Price",step:"0.01",className:"w-full border rounded-md p-2 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",required:!0}),(0,s.jsxs)("span",{className:"text-sm font-semibold text-right pr-2 dark:text-gray-200",children:["â‚¹",((parseFloat(e.quantity)||0)*(parseFloat(e.price)||0)).toFixed(2)]}),s.jsx("button",{type:"button",onClick:()=>n({type:"REMOVE_ITEM",id:e.id}),children:s.jsx(A.Z,{size:16,className:"text-red-500 hover:text-red-600"})})]},e.id))}),s.jsx("datalist",{id:"product-list",children:o.map(e=>s.jsx("option",{value:e.name},e.id))}),(0,s.jsxs)("button",{type:"button",onClick:()=>n({type:"ADD_ITEM"}),className:"flex items-center text-sm text-blue-600 dark:text-blue-400 mt-2",children:[s.jsx(X.Z,{size:16,className:"mr-1"})," Add Item"]})]}),(0,s.jsxs)("div",{className:"mt-6 space-y-3",children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-xs",children:"Discount (%)"}),s.jsx("input",{type:"number",value:i.discountPercentage,onChange:e=>n({type:"UPDATE_FIELD",field:"discountPercentage",payload:e.target.value}),className:"w-full border rounded-md p-2 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-xs",children:"Delivery (â‚¹)"}),s.jsx("input",{type:"number",value:i.deliveryCharges,onChange:e=>n({type:"UPDATE_FIELD",field:"deliveryCharges",payload:e.target.value}),className:"w-full border rounded-md p-2 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"})]})]}),(0,s.jsxs)("div",{className:"text-right font-bold text-lg text-gray-800 dark:text-gray-100",children:["Total: â‚¹",f.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2 mt-4",children:[s.jsx("button",{type:"button",onClick:t,className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:u,className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-md disabled:opacity-50 flex items-center justify-center",children:u?s.jsx(p.Z,{className:"animate-spin"}):"Create & View Bill"})]})]})};var eC=a(24422);let eE={hidden:{},visible:{transition:{staggerChildren:.07}}},eS={hidden:{y:15,opacity:0},visible:{y:0,opacity:1}},eA=({contactId:e,onNewOrder:t,onManagePayments:a})=>{let[l,d]=(0,r.useState)([]),[i,n]=(0,r.useState)(!0),[o,c]=(0,r.useState)(null),[u,x]=(0,r.useState)(null),g=async()=>{n(!0);try{let t=await fetch(`/api/orders?contactId=${e}`);t.ok&&d(await t.json())}catch(e){console.error("Failed to fetch orders:",e)}finally{n(!1)}};(0,r.useEffect)(()=>{e&&g()},[e]);let h=async()=>{if(o){x(o.id);try{if(!(await fetch(`/api/orders/${o.id}`,{method:"DELETE"})).ok)throw Error("Failed to delete order.");d(e=>e.filter(e=>e.id!==o.id)),c(null)}catch(e){console.error(e)}finally{x(null)}}};return(0,s.jsxs)("div",{className:"p-4",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[s.jsx("h3",{className:"font-bold text-lg",children:"Order History"}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[s.jsx("button",{onClick:g,disabled:i,className:"p-2 text-gray-500 hover:bg-gray-100 rounded-full disabled:opacity-50",children:s.jsx(eo,{size:16,className:i?"animate-spin":""})}),(0,s.jsxs)("button",{onClick:t,className:"flex items-center bg-blue-600 text-white text-sm px-3 py-2 rounded-md hover:bg-blue-700",children:[s.jsx(X.Z,{size:16,className:"mr-1"})," New"]})]})]}),i?s.jsx("p",{className:"text-sm text-gray-500 text-center py-8",children:"Loading..."}):0===l.length?s.jsx("p",{className:"text-sm text-gray-500 text-center py-8",children:"No orders found for this contact."}):s.jsx(m.E.ul,{className:"space-y-3",variants:eE,initial:"hidden",animate:"visible",children:l.map(e=>(0,s.jsxs)(m.E.li,{variants:eS,className:"p-3 border dark:border-gray-700 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[(0,s.jsxs)("div",{className:"flex justify-between items-start",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("p",{className:"font-semibold text-sm",children:["Order #",e.id.substring(0,6)]}),s.jsx("p",{className:"text-xs text-gray-500",children:(0,J.WU)(new Date(e.createdAt),"PP")})]}),s.jsx(eC.Z,{status:e.status})]}),(0,s.jsxs)("div",{className:"flex justify-between items-end mt-2",children:[(0,s.jsxs)("p",{className:"text-lg font-bold",children:["â‚¹",e.total.toLocaleString("en-IN")]}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsxs)("button",{onClick:()=>a(e),className:"flex items-center text-blue-600 text-sm font-semibold hover:underline",children:[s.jsx(ee.Z,{size:14,className:"mr-1"})," Manage Payments"]}),s.jsx("button",{onClick:()=>c(e),className:"p-1.5 text-gray-400 hover:bg-red-100 hover:text-red-600 rounded-full dark:hover:bg-red-900/30",title:"Delete Order",disabled:!!u,children:u===e.id?s.jsx(p.Z,{className:"animate-spin",size:16}):s.jsx(A.Z,{size:16})})]})]})]},e.id))}),o&&(0,s.jsxs)(F.Z,{isOpen:!!o,onClose:()=>c(null),title:"Confirm Deletion",children:[(0,s.jsxs)("p",{children:["Are you sure you want to delete Order ",(0,s.jsxs)("strong",{children:["#",o.id.substring(0,6)]}),"? This action cannot be undone."]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-2 mt-4",children:[s.jsx("button",{onClick:()=>c(null),className:"px-4 py-2 border dark:border-gray-600 rounded-md",children:"Cancel"}),s.jsx("button",{onClick:h,className:"px-4 py-2 bg-red-600 text-white rounded-md",disabled:!!u,children:u?"Deleting...":"Delete"})]})]})]})};var eP=a(41291);let eT=(0,k.Z)("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),e_=({order:e,onDone:t})=>{let[a,l]=(0,r.useState)(!1),[d,i]=(0,r.useState)(null),[n,o]=(0,r.useState)(!1),c=async()=>{l(!0),i(null);try{let t=await fetch(`/api/orders/${e.id}/send-bill`,{method:"POST"}),a=await t.json();if(!t.ok)throw Error(a.error||"Failed to send bill.");o(!0)}catch(e){i(e.message)}finally{l(!1)}},u=e.items.reduce((e,t)=>e+t.price*Number(t.quantity),0),m=u*(e.discountPercentage||0)/100;return(0,s.jsxs)("div",{className:"p-4",children:[s.jsx("h3",{className:"font-bold text-lg mb-4 text-center",children:"Order Created!"}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-4 text-xs",children:[(0,s.jsxs)("div",{children:[s.jsx("h4",{className:"font-semibold text-gray-500 dark:text-gray-400",children:"Billing To"}),s.jsx("p",{className:"whitespace-pre-wrap text-gray-700 dark:text-gray-300",children:e.billingAddress})]}),(0,s.jsxs)("div",{children:[s.jsx("h4",{className:"font-semibold text-gray-500 dark:text-gray-400",children:"Shipping To"}),s.jsx("p",{className:"whitespace-pre-wrap text-gray-700 dark:text-gray-300",children:e.shippingAddress})]})]}),(0,s.jsxs)("div",{className:"p-4 border dark:border-gray-700 rounded-lg bg-gray-50/50 dark:bg-gray-900/50 space-y-3 text-sm",children:[(0,s.jsxs)("table",{className:"w-full text-left",children:[s.jsx("thead",{className:"text-xs text-gray-500",children:(0,s.jsxs)("tr",{children:[s.jsx("th",{className:"pb-1 font-medium",children:"Item"}),s.jsx("th",{className:"pb-1 font-medium text-right",children:"Price"})]})}),s.jsx("tbody",{children:e.items.map(e=>(0,s.jsxs)("tr",{className:"border-t dark:border-gray-600",children:[(0,s.jsxs)("td",{className:"py-2",children:[e.productName," ",(0,s.jsxs)("span",{className:"text-gray-500",children:["x ",e.quantity]})]}),(0,s.jsxs)("td",{className:"py-2 text-right",children:["â‚¹",e.price.toFixed(2)]})]},e.id))})]}),(0,s.jsxs)("div",{className:"space-y-1 pt-2 border-t dark:border-gray-600",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Subtotal"}),(0,s.jsxs)("span",{children:["â‚¹",u.toFixed(2)]})]}),e.discountPercentage&&e.discountPercentage>0&&(0,s.jsxs)("div",{className:"flex justify-between text-red-600 dark:text-red-400",children:[(0,s.jsxs)("span",{children:["Discount (",e.discountPercentage,"%)"]}),(0,s.jsxs)("span",{children:["- â‚¹",m.toFixed(2)]})]}),e.deliveryCharges&&e.deliveryCharges>0&&(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Delivery Charges"}),(0,s.jsxs)("span",{children:["+ â‚¹",e.deliveryCharges.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between font-bold text-base pt-1 border-t dark:border-gray-600 mt-1",children:[s.jsx("span",{children:"Total"}),(0,s.jsxs)("span",{children:["â‚¹",e.total.toFixed(2)]})]})]})]}),(0,s.jsxs)("div",{className:"mt-4",children:[d&&(0,s.jsxs)("div",{className:"p-2 mb-2 bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-300 rounded-md text-sm flex items-center",children:[s.jsx(eP.Z,{size:16,className:"mr-2"}),d]}),n?(0,s.jsxs)("div",{className:"p-3 text-center bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-300 rounded-md",children:[s.jsx(eT,{className:"inline-block mr-2"})," Bill sent successfully!"]}):s.jsx("button",{onClick:c,className:"w-full bg-green-600 text-white rounded-md px-4 py-2.5 text-sm font-semibold flex items-center justify-center",disabled:a,children:a?s.jsx(p.Z,{size:18,className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(D.Z,{size:16,className:"mr-2"}),"Send Bill as Image"]})}),s.jsx("button",{onClick:t,className:"w-full mt-2 text-sm text-gray-600 dark:text-gray-400 py-2 hover:underline",children:"Done"})]})]})},eI=({order:e,onBack:t,onFinalized:a,socket:l})=>{let[d,i]=(0,r.useState)(e),[n,o]=(0,r.useState)(d.payments||[]),[c,u]=(0,r.useState)(null),[m,x]=(0,r.useState)(""),[g,h]=(0,r.useState)(!1),[y,b]=(0,r.useState)({amount:"",method:"Cash",notes:""}),[f,j]=(0,r.useState)(!1),k=n.reduce((e,t)=>e+t.amount,0),v=d.total-k;(0,r.useEffect)(()=>{if((async()=>{if(!d.id)return;let e=await fetch(`/api/orders/${d.id}`);if(e.ok){let t=await e.json();i(t),o(t.payments||[])}})(),l){let e=e=>{e.id===d.id&&(i(e),o(e.payments||[]))};return l.on("order_update",e),()=>{l.off("order_update",e)}}},[d.id,l]);let N=async e=>{u(e),x("");try{let t=await fetch(`/api/orders/${d.id}/send-payment-action`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:e})});if(!t.ok){let e=await t.json();throw Error(e.error||"Action failed.")}}catch(e){x(e.message)}finally{u(null)}},w=async e=>{e.preventDefault(),j(!0),x("");try{let e=await fetch(`/api/orders/${d.id}/payments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...y,amount:parseFloat(y.amount)})}),t=await e.json();if(!e.ok)throw Error(t.error||"Failed to add payment.");i(t),o(t.payments||[]),h(!1),b({amount:"",method:"Cash",notes:""})}catch(e){x(e.message)}finally{j(!1)}};return(0,s.jsxs)("div",{className:"p-4 space-y-4",children:[m&&s.jsx("p",{className:"text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-300 p-2 rounded-md text-sm mb-2",children:m}),(0,s.jsxs)("div",{className:"p-3 border dark:border-gray-700 rounded-lg",children:[s.jsx("h4",{className:"font-semibold text-sm mb-2 text-gray-800 dark:text-gray-100",children:"Payment Status"}),(0,s.jsxs)("div",{className:"text-sm space-y-1 text-gray-700 dark:text-gray-300",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Total Bill:"})," ",(0,s.jsxs)("span",{className:"font-bold text-gray-800 dark:text-gray-100",children:["â‚¹",d.total.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Total Paid:"})," ",(0,s.jsxs)("span",{className:"font-bold text-green-600 dark:text-green-400",children:["â‚¹",k.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Amount Due:"})," ",(0,s.jsxs)("span",{className:"font-bold text-red-600 dark:text-red-400",children:["â‚¹",v.toFixed(2)]})]})]}),s.jsx("div",{className:"mt-2 text-xs text-gray-500 dark:text-gray-400 max-h-24 overflow-y-auto",children:n.map(e=>(0,s.jsxs)("div",{className:"flex justify-between items-center border-t dark:border-gray-600 py-1",children:[(0,s.jsxs)("span",{children:[e.method," (",(0,J.WU)(new Date(e.createdAt),"PP"),")"]}),(0,s.jsxs)("span",{children:["â‚¹",e.amount.toFixed(2)]})]},e.id))}),(0,s.jsxs)("button",{onClick:()=>h(!0),className:"w-full mt-3 flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 py-2 rounded-md",children:[s.jsx(X.Z,{size:16,className:"mr-1"})," Record Manual Payment"]})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[s.jsx("h4",{className:"font-semibold text-sm pt-2 text-gray-800 dark:text-gray-100",children:"Payment Actions"}),s.jsx("button",{onClick:()=>N("send_bill_image"),disabled:!!c,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_bill_image"===c?s.jsx(p.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(D.Z,{size:16,className:"mr-2"})," Send Bill Image"]})}),s.jsx("button",{onClick:()=>N("send_razorpay"),disabled:!!c||v<=0,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_razorpay"===c?s.jsx(p.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(eh,{size:16,className:"mr-2"})," Send Payment Link"]})}),s.jsx("button",{onClick:()=>N("send_bank_details"),disabled:!!c||v<=0,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_bank_details"===c?s.jsx(p.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(ey,{size:16,className:"mr-2"})," Send Bank Details"]})}),s.jsx("button",{onClick:()=>N("send_qr_code"),disabled:!!c||v<=0,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_qr_code"===c?s.jsx(p.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(ep,{size:16,className:"mr-2"})," Send UPI QR Code"]})})]}),s.jsx(F.Z,{isOpen:g,onClose:()=>h(!1),title:"Record Manual Payment",children:(0,s.jsxs)("form",{onSubmit:w,className:"space-y-3",children:[(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Amount"}),s.jsx("input",{type:"number",placeholder:"Amount paid",value:y.amount,onChange:e=>b(t=>({...t,amount:e.target.value})),required:!0,className:"w-full border rounded-md p-2 text-sm mt-1 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Method"}),(0,s.jsxs)("select",{value:y.method,onChange:e=>b(t=>({...t,method:e.target.value})),className:"w-full border rounded-md p-2 text-sm mt-1 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",children:[s.jsx("option",{children:"Cash"})," ",s.jsx("option",{children:"Bank Transfer"})," ",s.jsx("option",{children:"UPI"})," ",s.jsx("option",{children:"Other"})]})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Notes (Optional)"}),s.jsx("input",{type:"text",placeholder:"e.g., Transaction ID",value:y.notes,onChange:e=>b(t=>({...t,notes:e.target.value})),className:"w-full border rounded-md p-2 text-sm mt-1 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"})]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2 pt-2",children:[s.jsx("button",{type:"button",onClick:()=>h(!1),className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:f,className:"px-4 py-2 text-sm bg-green-600 text-white rounded-md disabled:opacity-50",children:f?"Adding...":"Add Payment"})]})]})})]})};var eF=a(31215);let eZ=({name:e,color:t,onRemove:a})=>(0,s.jsxs)("div",{className:"flex items-center text-xs font-medium rounded-full px-2.5 py-1",style:{backgroundColor:`${t}20`,color:t},children:[s.jsx("span",{children:e}),a&&s.jsx("button",{type:"button",onClick:a,className:"ml-1.5 -mr-1 rounded-full hover:bg-black/10 p-0.5 transition-colors","aria-label":`Remove tag ${e}`,children:s.jsx(f.Z,{size:12,style:{color:t}})})]}),eM=["#3b82f6","#22c55e","#eab308","#f97316","#ef4444","#8b5cf6","#d946ef","#64748b"],eO=({tags:e,onTagsChange:t})=>{let[a,l]=(0,r.useState)([]),[d,i]=(0,r.useState)(!1),[n,o]=(0,r.useState)(""),[c,u]=(0,r.useState)(eM[0]),[m,x]=(0,r.useState)(""),g=async()=>{let e=await fetch("/api/tags");e.ok&&l(await e.json())};(0,r.useEffect)(()=>{g()},[]);let h=s=>{if(!s)return;let r=a.find(e=>e.id===s);r&&!e.some(e=>e.id===s)&&t([...e,r])},y=a=>{t(e.filter(e=>e.id!==a))},p=async()=>{if(!n.trim()){x("Tag name cannot be empty.");return}x("");try{let a=await fetch("/api/tags",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n,color:c})}),s=await a.json();if(!a.ok)throw Error(s.error||"Failed to create tag.");await g(),t([...e,s]),o(""),u(eM[0]),i(!1)}catch(e){x(e.message)}},b=a.filter(t=>!e.some(e=>e.id===t.id));return(0,s.jsxs)("div",{className:"p-3 border dark:border-gray-700 rounded-lg",children:[s.jsx("h4",{className:"font-semibold text-sm mb-2 text-gray-700 dark:text-gray-300",children:"Tags"}),m&&s.jsx("p",{className:"text-xs text-red-500 mb-2",children:m}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-2 items-center",children:[e.map(e=>s.jsx(eZ,{name:e.name,color:e.color,onRemove:()=>y(e.id)},e.id)),!d&&(0,s.jsxs)("button",{type:"button",onClick:()=>i(!0),className:"flex items-center text-xs text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/50",children:[s.jsx(X.Z,{size:12,className:"mr-1"})," Add Tag"]})]}),d&&(0,s.jsxs)("div",{className:"mt-3 space-y-2 animate-fade-in-up",style:{animationDuration:"0.3s"},children:[b.length>0&&(0,s.jsxs)("select",{onChange:e=>{h(e.target.value),e.target.value=""},className:"w-full border rounded-md p-1.5 text-sm dark:bg-gray-700 dark:border-gray-600",defaultValue:"",children:[s.jsx("option",{value:"",disabled:!0,children:"Add existing tag..."}),b.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]}),s.jsx("p",{className:"text-xs text-center text-gray-500",children:"Or"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[s.jsx("input",{value:n,onChange:e=>{o(e.target.value),x("")},placeholder:"Create new tag...",className:"flex-1 border rounded-md p-1.5 text-sm dark:bg-gray-700 dark:border-gray-600"}),s.jsx("div",{className:"flex gap-1 bg-gray-100 dark:bg-gray-900 p-1 rounded-md",children:eM.map(e=>s.jsx("button",{type:"button",onClick:()=>u(e),style:{backgroundColor:e},className:`w-5 h-5 rounded-full transition-transform hover:scale-110 ${c===e?"ring-2 ring-offset-1 dark:ring-offset-gray-800 ring-blue-500":""}`},e))})]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2 text-xs",children:[s.jsx("button",{type:"button",onClick:()=>{i(!1),x("")},className:"px-3 py-1 border rounded-md dark:border-gray-600",children:"Cancel"}),s.jsx("button",{type:"button",onClick:p,className:"bg-blue-600 text-white px-3 py-1 rounded-md",children:"Create & Add"})]})]})]})},eq={hidden:{},visible:{transition:{staggerChildren:.07}}},ez={hidden:{y:15,opacity:0},visible:{y:0,opacity:1}},e$=({contact:e,onPromoted:t})=>{let[a,l]=(0,r.useState)(null),[d,i]=(0,r.useState)(!0),[n,o]=(0,r.useState)(!1),[c,x]=(0,r.useState)({name:"",shippingAddress:"",bankDetails:"",tags:[]}),[g,h]=(0,r.useState)(!1),[y,b]=(0,r.useState)(!1),[f,j]=(0,r.useState)(""),k=async()=>{i(!0),j("");try{let t=await fetch(`/api/contacts/${e.id}/details`);if(!t.ok)throw Error("Failed to load details.");let a=await t.json();l(a),x({name:a.name||"",shippingAddress:a.shippingAddress||"",bankDetails:a.bankDetails||"",tags:a.tags||[]}),o(!a.isMasterCustomer)}catch(e){j(e.message)}finally{i(!1)}};(0,r.useEffect)(()=>{e.id&&k()},[e.id]);let v=async t=>{t.preventDefault(),h(!0),j("");try{let t=await fetch(`/api/contacts/${e.id}/promote-to-master`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:c.name,shippingAddress:c.shippingAddress,bankDetails:c.bankDetails,tagIds:c.tags.map(e=>e.id)})});if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to save customer details.")}await k(),o(!1)}catch(e){j(e.message)}finally{h(!1)}},N=async()=>{if(window.confirm("Are you sure you want to remove this customer from master status?")){b(!0),j("");try{if(!(await fetch(`/api/contacts/${e.id}/demote`,{method:"POST"})).ok)throw Error("Failed to demote customer.");t()}catch(e){j(e.message)}finally{b(!1)}}};return d?(0,s.jsxs)("div",{className:"p-4 text-center",children:[s.jsx(p.Z,{className:"animate-spin inline-block"}),s.jsx("p",{className:"text-sm text-gray-500",children:"Loading Details..."})]}):f&&!a?s.jsx("p",{className:"p-4 text-red-600 bg-red-50 text-center",children:f}):n?(0,s.jsxs)(m.E.form,{variants:eq,initial:"hidden",animate:"visible",onSubmit:v,className:"p-4 space-y-4",children:[(0,s.jsxs)(m.E.h3,{variants:ez,className:"font-semibold flex items-center text-yellow-500",children:[s.jsx(L,{size:18,className:"mr-2 fill-current"}),a?.isMasterCustomer?"Edit Master Details":"Promote to Master Customer"]}),f&&s.jsx("p",{className:"text-red-600 bg-red-50 p-2 rounded-md text-sm",children:f}),(0,s.jsxs)(m.E.div,{variants:ez,children:[(0,s.jsxs)("label",{className:"text-sm font-medium",children:["Customer Name ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx("input",{type:"text",value:c.name,onChange:e=>x(t=>({...t,name:e.target.value})),className:"mt-1 w-full border rounded-md p-2 text-sm dark:bg-[var(--input-background)] dark:border-gray-600",required:!0})]}),(0,s.jsxs)(m.E.div,{variants:ez,children:[(0,s.jsxs)("label",{className:"text-sm font-medium",children:["Shipping Address ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx("textarea",{value:c.shippingAddress,onChange:e=>x(t=>({...t,shippingAddress:e.target.value})),rows:3,className:"mt-1 w-full border rounded-md p-2 text-sm dark:bg-[var(--input-background)] dark:border-gray-600",placeholder:"Enter full shipping address...",required:!0})]}),(0,s.jsxs)(m.E.div,{variants:ez,children:[s.jsx("label",{className:"text-sm font-medium",children:"Bank Account Details"}),s.jsx("textarea",{value:c.bankDetails,onChange:e=>x(t=>({...t,bankDetails:e.target.value})),rows:3,className:"mt-1 w-full border rounded-md p-2 text-sm dark:bg-[var(--input-background)] dark:border-gray-600",placeholder:"Bank Name, Account Number, IFSC Code..."})]}),s.jsx(m.E.div,{variants:ez,children:s.jsx(eO,{tags:c.tags,onTagsChange:e=>x(t=>({...t,tags:e}))})}),(0,s.jsxs)(m.E.div,{variants:ez,className:"flex justify-end gap-2 pt-2",children:[a?.isMasterCustomer&&s.jsx("button",{type:"button",onClick:()=>{a&&x({name:a.name||"",shippingAddress:a.shippingAddress||"",bankDetails:a.bankDetails||"",tags:a.tags||[]}),o(!1)},className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md",children:"Cancel"}),(0,s.jsxs)("button",{type:"submit",disabled:g,className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-md disabled:opacity-50 flex items-center",children:[g?s.jsx(p.Z,{className:"animate-spin mr-2"}):s.jsx(eF.Z,{className:"mr-2"}),g?"Saving...":"Save Details"]})]})]}):(0,s.jsxs)(m.E.div,{variants:eq,initial:"hidden",animate:"visible",className:"p-4 space-y-4",children:[(0,s.jsxs)(m.E.div,{variants:eq,className:"space-y-3",children:[(0,s.jsxs)(m.E.div,{variants:ez,children:[s.jsx("label",{className:"text-xs font-semibold text-gray-500 dark:text-gray-400",children:"Tags"}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-2 items-center mt-1",children:[a?.tags?.map(e=>s.jsx(eZ,{name:e.name,color:e.color},e.id)),a?.tags?.length===0&&s.jsx("p",{className:"text-sm text-gray-400 dark:text-gray-500 italic",children:"No tags"})]})]}),(0,s.jsxs)(m.E.div,{variants:ez,children:[s.jsx("label",{className:"text-xs font-semibold text-gray-500 dark:text-gray-400",children:"Shipping Address"}),s.jsx("p",{className:"text-sm whitespace-pre-wrap p-2 bg-gray-50 dark:bg-[var(--input-background)] rounded-md mt-1",children:a?.shippingAddress||s.jsx("span",{className:"italic text-gray-400 dark:text-gray-500",children:"Not provided"})})]}),(0,s.jsxs)(m.E.div,{variants:ez,children:[s.jsx("label",{className:"text-xs font-semibold text-gray-500 dark:text-gray-400",children:"Bank Details"}),s.jsx("p",{className:"text-sm whitespace-pre-wrap p-2 bg-gray-50 dark:bg-[var(--input-background)] rounded-md mt-1",children:a?.bankDetails||s.jsx("span",{className:"italic text-gray-400 dark:text-gray-500",children:"Not provided"})})]})]}),(0,s.jsxs)(m.E.div,{variants:ez,className:"flex justify-between items-center pt-2",children:[(0,s.jsxs)("button",{type:"button",onClick:N,disabled:y,className:"flex items-center text-xs text-red-500 hover:underline disabled:opacity-50",children:[y?s.jsx(p.Z,{size:14,className:"animate-spin mr-1"}):s.jsx(u.Z,{name:"UserX",size:14,className:"mr-1"}),"Demote Customer"]}),(0,s.jsxs)("button",{onClick:()=>o(!0),className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-md flex items-center",children:[s.jsx(en.Z,{size:16,className:"mr-2"})," Edit Details"]})]})]})};function eU({initialImages:e=[],onChange:t,label:a="Product Images"}){let[l,d]=(0,r.useState)(e),[i,n]=(0,r.useState)(!1),o=async e=>{if(!e.target.files||0===e.target.files.length)return;n(!0);let a=[...l],s=e.target.files;for(let e=0;e<s.length;e++){let t=s[e],r=new FormData;r.append("image",t);try{let e=await fetch("https://api.imgbb.com/1/upload?key=ce388deb1931d0d58b9e876d99c2b152",{method:"POST",body:r}),t=await e.json();e.ok&&t.data&&t.data.url?a.push(t.data.url):console.error("ImgBB upload failed:",t.error?.message||"Unknown error")}catch(e){console.error("ImgBB upload error:",e)}}d(a),t(a),n(!1)},c=e=>{let a=l.filter(t=>t!==e);d(a),t(a)};return(0,s.jsxs)("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:a}),s.jsx("input",{type:"file",accept:"image/jpeg, image/png",multiple:!0,onChange:o,disabled:i,className:"mt-1 block w-full text-sm text-gray-700 dark:text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-blue-900/50 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 dark:hover:file:bg-blue-900"}),i&&s.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-2",children:"Uploading..."}),l.length>0&&s.jsx("div",{className:"mt-3 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2",children:l.map((e,t)=>(0,s.jsxs)("div",{className:"relative",children:[s.jsx("img",{src:e,alt:`preview-${t}`,className:"h-24 w-full object-cover rounded-md border dark:border-gray-600"}),s.jsx("button",{type:"button",onClick:()=>c(e),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 text-xs leading-none",children:"âœ•"})]},t))})]})}function eL({onSuccess:e,onCancel:t}){let[a,l]=(0,r.useState)(""),[d,i]=(0,r.useState)(""),[n,o]=(0,r.useState)(""),[c,u]=(0,r.useState)(""),[m,x]=(0,r.useState)("0"),[g,h]=(0,r.useState)(!0),[y,p]=(0,r.useState)("HYBRID"),[b,f]=(0,r.useState)(!1),[j,k]=(0,r.useState)(""),[v,N]=(0,r.useState)([]),w=async t=>{t.preventDefault(),k(""),f(!0);try{let t=await fetch("/api/products",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a,price:d,description:n,category:c,inStock:g,stockQuantity:m,images:v,workflow:y})});if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(e.error||"Failed to add product")}await t.json(),e()}catch(e){console.error("AddProductForm error:",e),k(e.message||"Something went wrong")}finally{f(!1)}};return(0,s.jsxs)("form",{onSubmit:w,className:"bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg p-4 shadow-md",children:[s.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100",children:"Add New Product"}),j&&s.jsx("p",{className:"text-red-600 text-sm mb-3",children:j}),(0,s.jsxs)("div",{className:"mb-3",children:[(0,s.jsxs)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:["Product Usage / Workflow",s.jsx("span",{className:"text-red-500",children:"*"})]}),(0,s.jsxs)("select",{required:!0,value:y,onChange:e=>p(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[s.jsx("option",{value:"QUOTATION_FOCUSED",children:"Quotation Specific"}),s.jsx("option",{value:"ORDER_FOCUSED",children:"Order Specific"}),s.jsx("option",{value:"HYBRID",children:"Hybrid (for both)"})]})]}),(0,s.jsxs)("div",{className:"mb-3",children:[(0,s.jsxs)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:["Name",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx("input",{type:"text",required:!0,value:a,onChange:e=>l(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-3",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:["Price (â‚¹)",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx("input",{type:"number",required:!0,value:d,onChange:e=>i(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Stock Quantity"}),s.jsx("input",{type:"number",value:m,onChange:e=>x(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),(0,s.jsxs)("div",{className:"mb-3",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description"}),s.jsx("textarea",{value:n,onChange:e=>o(e.target.value),rows:3,className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),s.jsx("div",{className:"mb-3",children:s.jsx(eU,{onChange:N})}),(0,s.jsxs)("div",{className:"mb-3",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Category"}),s.jsx("input",{type:"text",value:c,onChange:e=>u(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,s.jsxs)("div",{className:"mb-4 flex items-center",children:[s.jsx("input",{type:"checkbox",checked:g,onChange:e=>h(e.target.checked),className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),s.jsx("label",{className:"ml-2 block text-sm text-gray-700 dark:text-gray-300",children:"In Stock"})]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-2",children:[s.jsx("button",{type:"button",onClick:t,className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:b,className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50",children:b?"Adding...":"Add Product"})]})]})}function eR({product:e,onSuccess:t,onCancel:a}){let[l,d]=(0,r.useState)(e.name),[i,n]=(0,r.useState)(e.price.toString()),[o,c]=(0,r.useState)(e.description||""),[u,m]=(0,r.useState)(e.category||""),[x,g]=(0,r.useState)((e.stockQuantity||0).toString()),[h,y]=(0,r.useState)(e.inStock??!0),[p,b]=(0,r.useState)(e.workflow||"HYBRID"),[f,j]=(0,r.useState)(!1),[k,v]=(0,r.useState)(""),[N,w]=(0,r.useState)(e.images||[]),[D,C]=(0,r.useState)([]),[E,S]=(0,r.useState)([]),A=e=>{w(t=>t.filter(t=>t.id!==e)),C(t=>[...t,e])},P=async a=>{a.preventDefault(),v(""),j(!0);try{let a=await fetch(`/api/products/${e.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:l,price:i,description:o,category:u,inStock:h,stockQuantity:x,workflow:p,imagesToAdd:E,imagesToDelete:D})});if(!a.ok){let e=await a.json().catch(()=>({}));throw Error(e.error||"Failed to update product")}await a.json(),t()}catch(e){console.error("EditProductForm error:",e),v(e.message||"Something went wrong")}finally{j(!1)}};return(0,s.jsxs)("form",{onSubmit:P,className:"bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg p-4 shadow-md",children:[s.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100",children:"Edit Product"}),k&&s.jsx("p",{className:"text-red-600 text-sm mb-3",children:k}),(0,s.jsxs)("div",{className:"mb-3",children:[(0,s.jsxs)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:["Product Usage / Workflow",s.jsx("span",{className:"text-red-500",children:"*"})]}),(0,s.jsxs)("select",{required:!0,value:p,onChange:e=>b(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[s.jsx("option",{value:"QUOTATION_FOCUSED",children:"Quotation Specific"}),s.jsx("option",{value:"ORDER_FOCUSED",children:"Order Specific"}),s.jsx("option",{value:"HYBRID",children:"Hybrid (for both)"})]})]}),(0,s.jsxs)("div",{className:"mb-3",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Name"}),s.jsx("input",{type:"text",required:!0,value:l,onChange:e=>d(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-3",children:[(0,s.jsxs)("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Price (â‚¹)"}),s.jsx("input",{type:"number",required:!0,value:i,onChange:e=>n(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Stock Quantity"}),s.jsx("input",{type:"number",value:x,onChange:e=>g(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),(0,s.jsxs)("div",{className:"mb-3",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description"}),s.jsx("textarea",{value:o,onChange:e=>c(e.target.value),rows:3,className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),N.length>0&&(0,s.jsxs)("div",{className:"mb-3",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Existing Images"}),s.jsx("div",{className:"mt-2 grid grid-cols-3 gap-2",children:N.map(e=>(0,s.jsxs)("div",{className:"relative",children:[s.jsx("img",{src:e.url,alt:"product",className:"h-24 w-full object-cover rounded-md border dark:border-gray-600"}),s.jsx("button",{type:"button",onClick:()=>A(e.id),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 text-xs",children:"âœ•"})]},e.id))})]}),s.jsx(eU,{label:"Add New Images",initialImages:E,onChange:S}),(0,s.jsxs)("div",{className:"mb-3",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Category"}),s.jsx("input",{type:"text",value:u,onChange:e=>m(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,s.jsxs)("div",{className:"mb-4 flex items-center",children:[s.jsx("input",{type:"checkbox",checked:h,onChange:e=>y(e.target.checked),className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),s.jsx("label",{className:"ml-2 block text-sm text-gray-700 dark:text-gray-300",children:"In Stock"})]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-2",children:[s.jsx("button",{type:"button",onClick:a,className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:f,className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50",children:f?"Saving...":"Save Changes"})]})]})}let eB=({quotation:e,onClose:t,onSend:a,isSending:r,error:l})=>e?s.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col",children:[(0,s.jsxs)("header",{className:"p-4 border-b dark:border-gray-700 flex justify-between items-center",children:[s.jsx("h2",{className:"font-bold text-lg text-gray-800 dark:text-gray-100",children:"Quotation Preview"}),s.jsx("button",{onClick:t,children:s.jsx(f.Z,{})})]}),(0,s.jsxs)("main",{className:"p-6 overflow-y-auto",children:[(0,s.jsxs)("div",{className:"flex justify-between mb-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("p",{children:[s.jsx("strong",{children:"To:"})," ",e.customerName]}),(0,s.jsxs)("p",{children:[s.jsx("strong",{children:"Phone:"})," ",e.contactNumber]})]}),s.jsx("div",{children:(0,s.jsxs)("p",{children:[s.jsx("strong",{children:"Date:"})," ",new Date(e.createdAt).toLocaleDateString()]})})]}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-4 text-sm",children:[(0,s.jsxs)("div",{children:[s.jsx("h4",{className:"font-semibold text-gray-500 dark:text-gray-400",children:"Billing Address"}),s.jsx("p",{className:"whitespace-pre-wrap text-gray-700 dark:text-gray-300",children:e.billingAddress})]}),(0,s.jsxs)("div",{children:[s.jsx("h4",{className:"font-semibold text-gray-500 dark:text-gray-400",children:"Shipping Address"}),s.jsx("p",{className:"whitespace-pre-wrap text-gray-700 dark:text-gray-300",children:e.shippingAddress})]})]}),(0,s.jsxs)("table",{className:"w-full text-sm text-left",children:[s.jsx("thead",{className:"bg-gray-100 dark:bg-gray-700",children:(0,s.jsxs)("tr",{children:[s.jsx("th",{className:"p-2",children:"Product"}),s.jsx("th",{className:"p-2 text-center",children:"Qty"}),s.jsx("th",{className:"p-2 text-right",children:"Price"}),s.jsx("th",{className:"p-2 text-right",children:"Subtotal"})]})}),s.jsx("tbody",{children:e.items.map(e=>(0,s.jsxs)("tr",{className:"border-b dark:border-gray-600",children:[s.jsx("td",{className:"p-2",children:e.product?.name}),s.jsx("td",{className:"p-2 text-center",children:e.quantity}),(0,s.jsxs)("td",{className:"p-2 text-right",children:["â‚¹",e.price.toFixed(2)]}),(0,s.jsxs)("td",{className:"p-2 text-right",children:["â‚¹",(e.price*e.quantity).toFixed(2)]})]},e.id))})]}),(0,s.jsxs)("div",{className:"mt-4 text-right",children:[(0,s.jsxs)("p",{children:[s.jsx("strong",{children:"Subtotal:"})," â‚¹",e.subtotal.toFixed(2)]}),(0,s.jsxs)("p",{className:"font-bold text-xl",children:[s.jsx("strong",{children:"Total:"})," â‚¹",e.total.toFixed(2)]})]})]}),(0,s.jsxs)("footer",{className:"p-4 border-t dark:border-gray-700 flex flex-col",children:[l&&(0,s.jsxs)("div",{className:"p-2 mb-2 bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-300 rounded-md text-sm flex items-center",children:[s.jsx(eP.Z,{size:16,className:"mr-2"}),l]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2",children:[s.jsx("button",{onClick:t,className:"border dark:border-gray-600 rounded-md px-4 py-2 text-sm",children:"Cancel"}),s.jsx("button",{onClick:()=>a(e.id),className:"bg-green-600 text-white rounded-md px-4 py-2 text-sm flex items-center justify-center w-40",disabled:r,children:r?s.jsx(p.Z,{size:18,className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(D.Z,{size:16,className:"mr-2"}),"Send to Customer"]})})]})]})]})}):null;var eH=a(77109);let eQ={initial:{opacity:0,y:10},enter:{opacity:1,y:0,transition:{duration:.3,ease:[.4,0,.2,1]}},exit:{opacity:0,y:-10,transition:{duration:.2,ease:[.4,0,1,1]}}},eJ={visible:{transition:{staggerChildren:.06}}},eV={hidden:{y:15,opacity:0},visible:{y:0,opacity:1,transition:{ease:"easeOut",duration:.3}}},eW=({activeContact:e,messages:t,onShareProduct:a,initialViewId:l="main_menu",socket:d,newAddressForOrder:i})=>{let{data:n}=(0,eH.useSession)(),[o,c]=(0,r.useState)(l),[u,g]=(0,r.useState)([]),[h,y]=(0,r.useState)(null),[b,f]=(0,r.useState)(null),[j,k]=(0,r.useState)(null),[v,N]=(0,r.useState)(null),[w,D]=(0,r.useState)(null),[C,E]=(0,r.useState)(!1),[S,A]=(0,r.useState)(null),[P,T]=(0,r.useState)(0),[_,I]=(0,r.useState)(!1),[Z,M]=(0,r.useState)(null),[O,q]=(0,r.useState)(null),[z,$]=(0,r.useState)(null),[U,L]=(0,r.useState)([]),[R,B]=(0,r.useState)(!1),H=async()=>{try{$(null);let e=await fetch("/api/products");if(!e.ok)throw Error("Failed to fetch products.");let t=(await e.json()).map(e=>({...e,imageUrl:e.images?.[0]?.url||"https://i.imgur.com/vJkrA4g.png"}));return g(t),t}catch(e){return console.error("Failed to fetch products:",e),$(e.message),[]}},Q=async()=>{if(t&&0!==t.length){B(!0),L([]),$(null),c("products");try{let e=u.length>0?u:await H(),a=t.slice(-10).map(e=>`${"business"===e.from?"Business":"Customer"}: ${e.text||"[attachment]"}`).join("\n"),s=await fetch("/api/ai/suggest-products",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({history:a})});if(!s.ok){let e="Failed to get AI suggestions.";try{e=(await s.json()).error||e}catch(t){console.error("Server returned a non-JSON error response for AI suggestions."),e="An unexpected error occurred on the server. Please try again later."}throw Error(e)}let{query:r}=await s.json();if(r){let t=r.toLowerCase(),a=e.filter(e=>e.name.toLowerCase().includes(t)||e.description?.toLowerCase().includes(t)||e.category?.toLowerCase().includes(t));L(a),0===a.length&&$(`AI suggested searching for "${r}", but no products matched.`)}else $("AI couldn't determine a product suggestion from the chat.")}catch(e){$(e.message||"An error occurred while getting suggestions.")}finally{B(!1)}}};(0,r.useEffect)(()=>{l&&c(l)},[l]),(0,r.useEffect)(()=>{"products"!==o||0!==u.length||R||H()},[o,R,u.length]);let J=async()=>{if(O){$(null);try{let e=await fetch(`/api/products/${O.id}`,{method:"DELETE"});if(!e.ok){let t=await e.json();throw Error(t.error||"Failed to delete product.")}H(),q(null)}catch(e){$(e.message)}}},V=()=>{$(null),L([]),"order_billing"===o||"new_order"===o||"order_summary"===o?c("order_history"):"billing"===o||"new_quotation"===o||"new_reminder"===o?c("quotations"):c("main_menu"),N(null)},W=()=>{c("main_menu")},G=e=>{c("quotations"),D(e),T(e=>e+1)},Y=e=>{N(e),c("order_summary")},er=async e=>{E(!0),A(null);try{let t=await fetch(`/api/quotations/${e}/send-as-image`,{method:"POST"});if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to send quotation image.")}D(null),T(e=>e+1)}catch(e){A(e.message)}finally{E(!1)}};return(0,s.jsxs)("aside",{className:"w-[30%] min-w-[350px] max-w-[450px] bg-white dark:bg-[var(--header-background)] border-l border-gray-200 dark:border-[var(--card-border)] flex flex-col flex-shrink-0",children:[(()=>{let e={main_menu:"Contact Actions",products:"Products",quotations:"Quotations",new_quotation:"New Quotation",new_reminder:"Set Follow-up Reminder",billing:`Bill for #${h?.id.substring(0,6)}`,master_customer_details:"Customer Details",order_history:"Orders",new_order:"New Order",order_summary:"Order Summary",order_billing:`Bill for #${j?.id.substring(0,6)}`};return(0,s.jsxs)("div",{className:"p-4 border-b border-gray-200 dark:border-[var(--card-border)] flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center",children:["main_menu"!==o&&s.jsx("button",{onClick:V,className:"mr-3 p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700",children:s.jsx(K,{size:20})}),s.jsx("h2",{className:"text-xl font-bold",children:e[o]})]}),s.jsx("div",{className:"flex items-center space-x-2",children:"products"===o&&(0,s.jsxs)("button",{onClick:()=>I(!0),className:"bg-blue-600 text-white px-3 py-1.5 rounded-md flex items-center text-sm font-semibold hover:bg-blue-700",children:[s.jsx(X.Z,{size:16,className:"mr-1"})," Add New"]})})]})})(),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[z&&s.jsx("div",{className:"p-4 m-2 bg-red-50 text-red-700 rounded-md text-sm",children:z}),(()=>{let t;if(!e)return s.jsx("p",{className:"p-4 text-center text-gray-500 dark:text-gray-400",children:"Please select a contact."});switch(o){case"products":t=(0,s.jsxs)("div",{children:[R&&(0,s.jsxs)("div",{className:"p-4 text-center text-gray-500 dark:text-gray-400",children:[s.jsx(p.Z,{className:"animate-spin inline-block mr-2"}),"Analyzing chat for suggestions..."]}),U.length>0&&(0,s.jsxs)("div",{className:"p-2 border-b-2 border-dashed dark:border-gray-700",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-2 px-2",children:[s.jsx("h4",{className:"font-bold text-blue-600 dark:text-blue-400",children:"AI Suggestions"}),s.jsx("button",{onClick:()=>L([]),className:"text-xs text-gray-500 hover:underline",children:"Clear"})]}),s.jsx(ei,{products:U,onShareProduct:a,onEditProduct:e=>M(e),onDeleteProduct:e=>q(e)})]}),s.jsx(ei,{products:u,onShareProduct:a,onEditProduct:e=>M({...e,description:e.description??"",category:e.category??"",workflow:e.workflow}),onDeleteProduct:e=>q(e)})]});break;case"quotations":t=s.jsx(eg,{contactId:e.id,onNewQuote:()=>c("new_quotation"),onBillQuote:e=>{y(e),c("billing")},onSendDraft:e=>D(e),onSetFollowUp:e=>{f(e),c("new_reminder")}},P);break;case"new_quotation":t=s.jsx(ej,{contact:e,onCancel:()=>c("quotations"),onQuotationCreated:G});break;case"new_reminder":if(!b)return null;t=s.jsx(eN,{quotation:b,onCancel:()=>c("quotations"),onSuccess:()=>c("quotations")});break;case"order_history":t=s.jsx(eA,{contactId:e.id,onNewOrder:()=>c("new_order"),onManagePayments:e=>{k(e),c("order_billing")}});break;case"new_order":t=s.jsx(eD,{contact:e,onCancel:()=>c("order_history"),onOrderCreated:Y,suggestedAddress:i});break;case"order_summary":if(!v)return null;t=s.jsx(e_,{order:v,onDone:V});break;case"billing":if(!h)return null;t=s.jsx(eb,{quotation:h,onBack:()=>c("quotations"),onFinalized:()=>{},socket:d});break;case"order_billing":if(!j)return null;t=s.jsx(eI,{order:j,onBack:()=>c("order_history"),onFinalized:()=>{},socket:d});break;case"master_customer_details":t=s.jsx(e$,{contact:e,onPromoted:W});break;default:let r=n?.user?.primaryWorkflow,l="QUOTATION_FOCUSED"===r,g="ORDER_FOCUSED"===r,N=[{id:"orders",label:"Manage Orders",icon:s.jsx(ee.Z,{className:`mr-3 ${l?"text-gray-400 dark:text-gray-500":"text-blue-600 dark:text-blue-400"}`}),action:()=>c("order_history"),disabled:l},{id:"quotations",label:"Manage Quotations",icon:s.jsx(et.Z,{className:`mr-3 ${g?"text-gray-400 dark:text-gray-500":"text-green-600 dark:text-green-400"}`}),action:()=>c("quotations"),disabled:g}];"QUOTATION_FOCUSED"===r&&N.reverse(),t=(0,s.jsxs)(m.E.div,{className:"p-4 space-y-3",variants:eJ,initial:"hidden",animate:"visible",children:[N.map(e=>(0,s.jsxs)(m.E.button,{variants:eV,onClick:e.action,disabled:e.disabled,className:`w-full flex items-center p-3 text-left rounded-lg transition-colors ${e.disabled?"bg-gray-100 dark:bg-gray-800/50 text-gray-400 dark:text-gray-500 cursor-not-allowed":"bg-gray-50 hover:bg-gray-100 dark:bg-[var(--input-background)] dark:hover:bg-gray-700"}`,title:e.disabled?`${e.label} (Disabled in this workspace)`:e.label,children:[e.icon," ",e.label]},e.id)),(0,s.jsxs)(m.E.button,{variants:eV,onClick:Q,className:"w-full flex items-center p-3 text-left bg-gray-50 hover:bg-gray-100 dark:bg-[var(--input-background)] dark:hover:bg-gray-700 rounded-lg",children:[s.jsx(ea,{className:"mr-3 text-yellow-500 dark:text-yellow-400"})," Suggest Products"]}),(0,s.jsxs)(m.E.button,{variants:eV,onClick:()=>c("products"),className:"w-full flex items-center p-3 text-left bg-gray-50 hover:bg-gray-100 dark:bg-[var(--input-background)] dark:hover:bg-gray-700 rounded-lg",children:[s.jsx(ee.Z,{className:"mr-3 text-orange-600 dark:text-orange-400"})," Share Product"]}),(0,s.jsxs)(m.E.button,{variants:eV,onClick:()=>c("master_customer_details"),className:"w-full flex items-center p-3 text-left bg-gray-50 hover:bg-gray-100 dark:bg-[var(--input-background)] dark:hover:bg-gray-700 rounded-lg",children:[s.jsx(es,{className:"mr-3 text-purple-600 dark:text-purple-400"})," Customer Details"]})]})}return s.jsx(x.M,{mode:"wait",children:s.jsx(m.E.div,{variants:eQ,initial:"initial",animate:"enter",exit:"exit",children:t},o)})})()]}),s.jsx(F.Z,{isOpen:_,onClose:()=>I(!1),title:"Add New Product",children:s.jsx(eL,{onSuccess:()=>{I(!1),H()},onCancel:()=>I(!1)})}),Z&&s.jsx(F.Z,{isOpen:!!Z,onClose:()=>M(null),title:"Edit Product",children:s.jsx(eR,{product:Z,onSuccess:()=>{M(null),H()},onCancel:()=>M(null)})}),O&&(0,s.jsxs)(F.Z,{isOpen:!!O,onClose:()=>q(null),title:"Confirm Deletion",children:[(0,s.jsxs)("p",{children:["Are you sure you want to delete the product: ",s.jsx("strong",{children:O.name}),"?"]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-2 mt-4",children:[s.jsx("button",{onClick:()=>q(null),className:"px-4 py-2 border rounded-md",children:"Cancel"}),s.jsx("button",{onClick:J,className:"px-4 py-2 bg-red-600 text-white rounded-md",children:"Delete"})]})]}),w&&s.jsx(eB,{quotation:w,onClose:()=>{D(null),A(null)},onSend:er,isSending:C,error:S})]})};a(44069);let eG=()=>(0,s.jsxs)("div",{className:"w-full flex flex-col h-full",children:[(0,s.jsxs)("div",{className:"p-4 border-b dark:border-[var(--card-border)] flex items-center",children:[s.jsx(n.Z,{className:"w-10 h-10 rounded-full mr-3"}),(0,s.jsxs)("div",{className:"flex-1",children:[s.jsx(n.Z,{className:"h-5 w-1/3 mb-1"}),s.jsx(n.Z,{className:"h-3 w-1/4"})]})]}),(0,s.jsxs)("div",{className:"flex-1 p-4 space-y-4",children:[(0,s.jsxs)("div",{className:"flex justify-start",children:[" ",s.jsx(n.Z,{className:"h-10 w-2/5 rounded-lg"})," "]}),(0,s.jsxs)("div",{className:"flex justify-end",children:[" ",s.jsx(n.Z,{className:"h-16 w-3/5 rounded-lg"})," "]}),(0,s.jsxs)("div",{className:"flex justify-start",children:[" ",s.jsx(n.Z,{className:"h-8 w-1/3 rounded-lg"})," "]}),(0,s.jsxs)("div",{className:"flex justify-end",children:[" ",s.jsx(n.Z,{className:"h-12 w-1/2 rounded-lg"})," "]})]}),s.jsx("div",{className:"p-4 border-t dark:border-[var(--card-border)]",children:s.jsx(n.Z,{className:"h-12 w-full rounded-full"})})]}),eY=()=>(0,s.jsxs)("div",{className:"flex h-screen overflow-hidden",children:[(0,s.jsxs)("div",{className:"w-80 border-r dark:border-[var(--card-border)] flex flex-col",children:[(0,s.jsxs)("div",{className:"p-4 border-b dark:border-[var(--card-border)]",children:[s.jsx(n.Z,{className:"h-6 w-1/3 mb-4"}),s.jsx(n.Z,{className:"h-9 w-full rounded-md"})]}),s.jsx(c,{})]}),s.jsx("div",{className:"flex-1 flex flex-col",children:s.jsx(eG,{})})]});function eK(){let e=(0,l.useSearchParams)();e?.get("contactId"),e?.get("message");let[t,a]=(0,r.useState)([]),[d,i]=(0,r.useState)(null),[n,o]=(0,r.useState)(null),[c,u]=(0,r.useState)([]),[m,x]=(0,r.useState)(null),[g,h]=(0,r.useState)(null),[y,p]=(0,r.useState)(0),[b,f]=(0,r.useState)("main_menu"),[j,k]=(0,r.useState)(!1),[v,N]=(0,r.useState)(null),w=async e=>{d&&(u(t=>[...t,{id:`temp-${Date.now()}`,from:"business",to:d.phone,type:"product",text:`Sharing ${e.name}...`,createdAt:new Date().toISOString(),contactId:d.id,status:"pending",product:e}]),await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contactId:d.id,type:"product",productId:e.id})}))},D=async()=>{if(!d)return;N(null),f("new_order"),p(e=>e+1);let e="";e=d.lastShippingAddress?`Hi ${d.name}, we're creating a new order for you. Should we use your last known address for delivery?

${d.lastShippingAddress}

Please reply with 'Yes' to confirm, or provide a new address.`:`Hi ${d.name}, we're creating a new order for you. What is the delivery address?`,k(!0),await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contactId:d.id,text:e})})};return(0,s.jsxs)("div",{className:"flex h-screen overflow-hidden",children:[s.jsx("div",{className:"transition-all duration-300 ease-in-out flex-1",children:s.jsx(Y,{socket:n,contacts:t,setContacts:a,activeContact:d,onSelectContact:e=>{d?.id!==e.id&&(i(e),f("main_menu"),p(e=>e+1),x(null))},onPromoteCustomer:()=>{f("master_customer_details"),p(e=>e+1)},messages:c,setMessages:u,initialMessage:m,initialCursor:g,onCreateOrder:D})}),d&&s.jsx(eW,{activeContact:d,messages:c,onShareProduct:w,initialViewId:b,socket:n,newAddressForOrder:v},y)]})}function eX(){return s.jsx(r.Suspense,{fallback:s.jsx(eY,{}),children:s.jsx(eK,{})})}},24422:(e,t,a)=>{"use strict";a.d(t,{Z:()=>l});var s=a(10326);a(17577);let r={PENDING:{label:"Pending",className:"bg-yellow-100 text-yellow-800"},CONFIRMED:{label:"Confirmed",className:"bg-blue-100 text-blue-700"},SHIPPED:{label:"Shipped",className:"bg-indigo-100 text-indigo-700"},DELIVERED:{label:"Delivered",className:"bg-green-100 text-green-700"},CANCELLED:{label:"Cancelled",className:"bg-red-100 text-red-700"}},l=({status:e})=>{let t=r[e]||{label:"Unknown",className:"bg-gray-100 text-gray-700"};return s.jsx("span",{className:`px-2.5 py-1 text-xs font-semibold rounded-full inline-block ${t.className}`,children:t.label})}},28676:(e,t,a)=>{"use strict";a.d(t,{Z:()=>r});var s=a(10326);a(17577);let r=({isOpen:e,onClose:t,title:a,children:r})=>e?s.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50",onClick:t,children:(0,s.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md m-4",onClick:e=>e.stopPropagation(),children:[(0,s.jsxs)("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center",children:[s.jsx("h2",{className:"text-lg font-semibold text-gray-800 dark:text-gray-100",children:a}),s.jsx("button",{onClick:t,className:"text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100",children:"\xd7"})]}),s.jsx("div",{className:"p-4",children:r})]})}):null},17334:(e,t,a)=>{"use strict";a.d(t,{Z:()=>r});var s=a(10326);a(17577);let r=({className:e,...t})=>s.jsx("div",{className:function(...e){return e.filter(Boolean).join(" ")}("animate-pulse rounded-md bg-gray-200 dark:bg-gray-700",e),...t})},44069:(e,t,a)=>{"use strict";a(87432)},34356:(e,t,a)=>{"use strict";a.r(t),a.d(t,{$$typeof:()=>d,__esModule:()=>l,default:()=>i});var s=a(68570);let r=(0,s.createProxy)(String.raw`C:\vyaparconnect-crm\src\app\chat\page.tsx`),{__esModule:l,$$typeof:d}=r;r.default;let i=(0,s.createProxy)(String.raw`C:\vyaparconnect-crm\src\app\chat\page.tsx#default`)}};var t=require("../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[8948,6294,1244,4719,6469,7377,1833],()=>a(27269));module.exports=s})();