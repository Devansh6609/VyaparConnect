(()=>{var e={};e.id=1929,e.ids=[1929],e.modules={47849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},55403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},94749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},22037:e=>{"use strict";e.exports=require("os")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},76224:e=>{"use strict";e.exports=require("tty")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},56804:()=>{},68645:()=>{},27269:(e,t,a)=>{"use strict";a.r(t),a.d(t,{GlobalError:()=>d.a,__next_app__:()=>m,originalPathname:()=>u,pages:()=>c,routeModule:()=>x,tree:()=>o}),a(34356),a(95499),a(72110),a(35866);var s=a(23191),r=a(88716),l=a(37922),d=a.n(l),i=a(95231),n={};for(let e in i)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(n[e]=()=>i[e]);a.d(t,n);let o=["",{children:["chat",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(a.bind(a,34356)),"C:\\vyaparconnect-crm\\src\\app\\chat\\page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(a.bind(a,95499)),"C:\\vyaparconnect-crm\\src\\app\\layout.tsx"],loading:[()=>Promise.resolve().then(a.bind(a,72110)),"C:\\vyaparconnect-crm\\src\\app\\loading.tsx"],"not-found":[()=>Promise.resolve().then(a.t.bind(a,35866,23)),"next/dist/client/components/not-found-error"]}],c=["C:\\vyaparconnect-crm\\src\\app\\chat\\page.tsx"],u="/chat/page",m={require:a,loadChunk:()=>Promise.resolve()},x=new s.AppPageRouteModule({definition:{kind:r.x.APP_PAGE,page:"/chat/page",pathname:"/chat",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:o}})},9432:(e,t,a)=>{Promise.resolve().then(a.bind(a,87641))},83855:(e,t,a)=>{"use strict";a.d(t,{Z:()=>s});/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let s=(0,a(62881).Z)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},31215:(e,t,a)=>{"use strict";a.d(t,{Z:()=>s});/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let s=(0,a(62881).Z)("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]])},87641:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>eV});var s=a(10326),r=a(17577),l=a(35047),d=a(43686),i=a(37978),n=a(17334);let o=()=>(0,s.jsxs)("div",{className:"flex items-center p-3",children:[s.jsx(n.Z,{className:"h-10 w-10 rounded-full"}),(0,s.jsxs)("div",{className:"ml-3 flex-1",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[s.jsx(n.Z,{className:"h-4 w-2/4"}),s.jsx(n.Z,{className:"h-3 w-1/4"})]}),s.jsx("div",{className:"mt-2",children:s.jsx(n.Z,{className:"h-3 w-3/4"})})]})]}),c=()=>s.jsx("div",{className:"pt-2",children:[...Array(8)].map((e,t)=>s.jsx(o,{},t))});var u=a(78539),m=a(30058),x=a(88129);let g=({socket:e,activeContactId:t,onSelectChat:a})=>{let[l,n]=(0,r.useState)([]),[o,g]=(0,r.useState)(!0),[h,y]=(0,r.useState)(""),[p,b]=(0,r.useState)(null),[f,j]=(0,r.useState)(!0),[k,N]=(0,r.useState)(!1),[v,w]=(0,r.useState)([]),[D,C]=(0,r.useState)([]),E=(0,r.useRef)(null),S=(0,r.useRef)(null),A=(0,r.useCallback)(async(e=null,t=[])=>{g(!0);try{let a=t.length>0?`&tags=${t.join(",")}`:"",s=`/api/contacts?limit=20${e?`&cursor=${e}`:""}${a}`,r=await fetch(s);if(r.ok){let{contacts:t,nextCursor:a}=await r.json();e?n(e=>[...e,...t]):n(t),b(a),j(!!a)}}catch(e){console.error("Failed to fetch chats",e)}finally{g(!1)}},[]);(0,r.useEffect)(()=>{A(null,D)},[D,A]);let P=(0,r.useCallback)(e=>{!o&&(S.current&&S.current.disconnect(),S.current=new IntersectionObserver(e=>{e[0].isIntersecting&&f&&p&&A(p,D)}),e&&S.current.observe(e))},[o,f,p,A,D]);(0,r.useEffect)(()=>{(async()=>{let e=await fetch("/api/tags");e.ok&&w(await e.json())})();let e=e=>{E.current&&!E.current.contains(e.target)&&N(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),(0,r.useEffect)(()=>{if(e){let a=e=>{n(a=>{let s=e.contactId;if(!s)return a;let r=s===t,l=!1,d=a.map(t=>t.id===s?(l=!0,{...t,lastMessage:e.text||("text"!==e.type?`Sent a ${e.type}`:""),lastMessageAt:e.createdAt,unreadCount:r?0:(t.unreadCount||0)+("customer"===e.from?1:0)}):t);return l?d.sort((e,t)=>new Date(t.lastMessageAt||0).getTime()-new Date(e.lastMessageAt||0).getTime()):(Promise.resolve().then(()=>A(null,D)),a)})};return e.on("newMessage",a),()=>{e.off("newMessage",a)}}},[e,t,A,D]);let T=e=>{C(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},I=l.filter(e=>e.name.toLowerCase().includes(h.toLowerCase()));return(0,s.jsxs)("div",{className:"w-full md:w-80 border-r flex flex-col h-full bg-white dark:bg-[var(--sidebar-background)] border-gray-200 dark:border-[var(--card-border)]",children:[(0,s.jsxs)("div",{className:"p-4 border-b border-gray-200 dark:border-[var(--card-border)]",children:[s.jsx("h2",{className:"text-xl font-bold text-gray-800 dark:text-gray-100",children:"Chats"}),(0,s.jsxs)("div",{className:"flex items-center space-x-2 mt-3",children:[s.jsx("input",{type:"text",placeholder:"Search chats...",value:h,onChange:e=>y(e.target.value),className:"w-full p-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-[var(--incoming-bubble-bg)] border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100"}),(0,s.jsxs)("div",{className:"relative",ref:E,children:[s.jsx("button",{onClick:()=>N(e=>!e),className:`p-2 border rounded-md ${D.length>0?"bg-blue-100 text-blue-600 dark:bg-blue-900/50":"bg-gray-50 dark:bg-[var(--incoming-bubble-bg)]"}`,children:s.jsx(u.Z,{name:"SlidersHorizontal",size:20})}),k&&(0,s.jsxs)("div",{className:"absolute top-full right-0 mt-2 w-48 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-md shadow-lg z-20",children:[s.jsx("div",{className:"p-2 text-sm font-semibold border-b dark:border-gray-700",children:"Filter by Tag"}),s.jsx("div",{className:"p-2 max-h-48 overflow-y-auto",children:v.map(e=>(0,s.jsxs)("label",{className:"flex items-center space-x-2 p-1.5 rounded hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",children:[s.jsx("input",{type:"checkbox",checked:D.includes(e.id),onChange:()=>T(e.id),className:"h-4 w-4 text-blue-600 rounded"}),s.jsx("span",{children:e.name})]},e.id))}),D.length>0&&s.jsx("div",{className:"p-2 border-t dark:border-gray-700",children:s.jsx("button",{onClick:()=>C([]),className:"w-full text-center text-xs text-red-500 hover:underline",children:"Clear Filters"})})]})]})]})]}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:o&&0===l.length?s.jsx(c,{}):(0,s.jsxs)(m.E.ul,{children:[s.jsx(x.M,{children:I.map((e,r)=>s.jsx(m.E.li,{ref:r===I.length-1?P:null,onClick:()=>a(e),className:`p-3 cursor-pointer border-b border-gray-200 dark:border-[var(--card-border)] hover:bg-gray-50 dark:hover:bg-[var(--input-background)] transition-colors ${t===e.id?"bg-blue-50 dark:bg-[var(--incoming-bubble-bg)]":""}`,children:(0,s.jsxs)("div",{className:"flex items-start",children:[s.jsx(i.Z,{initials:(e.name||"?").charAt(0).toUpperCase()}),(0,s.jsxs)("div",{className:"ml-3 flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[s.jsx("p",{className:"font-semibold text-sm truncate text-gray-800 dark:text-gray-100",children:e.name}),s.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 flex-shrink-0 ml-2",children:e.lastMessageAt&&(0,d.Q)(new Date(e.lastMessageAt),{addSuffix:!0})})]}),(0,s.jsxs)("div",{className:"flex justify-between items-start mt-1",children:[s.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-300 truncate pr-2",children:e.lastMessage||"No messages yet"}),e.unreadCount&&e.unreadCount>0&&s.jsx("span",{className:"bg-green-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center flex-shrink-0",children:e.unreadCount})]}),s.jsx("div",{className:"flex items-center space-x-1 mt-2 overflow-hidden",children:e.tags?.map(e=>s.jsx("div",{className:"px-1.5 py-0.5 text-[10px] font-medium rounded",style:{backgroundColor:`${e.color}20`,color:e.color},children:e.name},e.id))})]})]})},e.id))}),o&&l.length>0&&s.jsx("p",{className:"p-4 text-sm text-gray-500 dark:text-gray-300 text-center",children:"Loading more..."})]})})]})};var h=a(77506),y=a(1572),p=a(94019),b=a(39572),f=a(62881);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let j=(0,f.Z)("Smile",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]);var k=a(71709);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let N=(0,f.Z)("Paperclip",[["path",{d:"m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48",key:"1u3ebp"}]]);var v=a(69436);let w=["\uD83D\uDE00","\uD83D\uDE03","\uD83D\uDE04","\uD83D\uDE01","\uD83D\uDE06","\uD83D\uDE05","\uD83D\uDE02","\uD83E\uDD23","\uD83D\uDE0A","\uD83D\uDE07","\uD83D\uDE42","\uD83D\uDE43","\uD83D\uDE09","\uD83D\uDE0C","\uD83D\uDE0D","\uD83E\uDD70","\uD83D\uDE18","\uD83D\uDE17","\uD83D\uDE19","\uD83D\uDE1A","\uD83D\uDE0B","\uD83D\uDE1B","\uD83D\uDE1D","\uD83D\uDE1C","\uD83E\uDD2A","\uD83E\uDD28","\uD83E\uDDD0","\uD83E\uDD13","\uD83D\uDE0E","\uD83E\uDD29","\uD83E\uDD73","\uD83D\uDE0F","\uD83D\uDE12","\uD83D\uDE1E","\uD83D\uDE14","\uD83D\uDE1F","\uD83D\uDE15","\uD83D\uDE41","☹️","\uD83D\uDE23","\uD83D\uDE16","\uD83D\uDE2B","\uD83D\uDE29","\uD83E\uDD7A","\uD83D\uDE22","\uD83D\uDE2D","\uD83D\uDE24","\uD83D\uDE20","\uD83D\uDE21","\uD83E\uDD2C","\uD83E\uDD2F","\uD83D\uDE33","\uD83E\uDD75","\uD83E\uDD76","\uD83D\uDE31","\uD83D\uDE28","\uD83D\uDE30","\uD83D\uDE25","\uD83D\uDE13","\uD83E\uDD17","\uD83E\uDD14","\uD83E\uDD2D","\uD83E\uDD2B","\uD83E\uDD25","\uD83D\uDE36","\uD83D\uDE10","\uD83D\uDE11","\uD83D\uDE2C","\uD83D\uDE44","\uD83D\uDE2F","\uD83D\uDE26","\uD83D\uDE27","\uD83D\uDE2E","\uD83D\uDE32","\uD83E\uDD71","\uD83D\uDE34","\uD83E\uDD24","\uD83D\uDE2A","\uD83D\uDE35","\uD83E\uDD10","\uD83E\uDD74","\uD83E\uDD22","\uD83E\uDD2E","\uD83E\uDD27","\uD83D\uDE37","\uD83E\uDD12","\uD83E\uDD15","\uD83E\uDD11","\uD83E\uDD20","❤️","\uD83E\uDDE1","\uD83D\uDC9B","\uD83D\uDC9A","\uD83D\uDC99","\uD83D\uDC9C","\uD83E\uDD0E","\uD83D\uDDA4","\uD83E\uDD0D","\uD83D\uDC94","\uD83D\uDC4D","\uD83D\uDC4E","\uD83D\uDC4C","✌️","\uD83E\uDD1E","\uD83D\uDE4F","\uD83D\uDE4C","\uD83D\uDC4F","\uD83E\uDD1D"],D=({onSelectEmoji:e,onClose:t})=>{let a=(0,r.useRef)(null);return(0,r.useEffect)(()=>{let e=e=>{a.current&&!a.current.contains(e.target)&&t()};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[t]),s.jsx("div",{ref:a,className:"absolute bottom-full mb-2 bg-white p-3 rounded-2xl shadow-lg border w-80 h-60 overflow-y-auto",children:s.jsx("div",{className:"grid grid-cols-8 gap-1",children:w.map(t=>s.jsx("button",{onClick:()=>e(t),className:"text-2xl hover:bg-gray-200 rounded-lg p-1 transition-colors","aria-label":`Emoji ${t}`,children:t},t))})})},C=({newMessage:e,setNewMessage:t,sendMessage:a,replyingTo:l,onCancelReply:d,messages:i,smartReplies:n,isFetchingReplies:o,onCreateOrder:c})=>{let[u,g]=(0,r.useState)(!1),[f,w]=(0,r.useState)(!1),[C,E]=(0,r.useState)(null),[S,A]=(0,r.useState)(null),P=(0,r.useRef)(null),T=(0,r.useRef)(null),[I,_]=(0,r.useState)(!1),[Z,F]=(0,r.useState)(""),[M,q]=(0,r.useState)(!1),[O,z]=(0,r.useState)("");(0,r.useEffect)(()=>{let e=T.current;if(e){e.style.height="auto";let t=e.scrollHeight;e.style.height=`${t}px`}},[e]);let $=s=>{a("string"==typeof s?s:e,C||void 0),t(""),E(null),A(null)},L=async()=>{if(Z.trim()&&i){q(!0),z("");try{let e=i.map(e=>`${"business"===e.from?"Business":"Customer"}: ${e.text||"[attachment]"}`).join("\n"),a=await fetch("/api/ai/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:Z,history:e})}),s=await a.json();if(!a.ok)throw Error(s.error||"VyaparAI is currently unavailable. Please try again.");s.functionCall&&"createOrder"===s.functionCall.name?c():t(s.text),_(!1),F("")}catch(e){console.error("VyaparAI error:",e),z(e.message||"VyaparAI is currently unavailable. Please try again."),setTimeout(()=>z(""),3e3)}finally{q(!1)}}};return(0,s.jsxs)("div",{className:"bg-gray-100 dark:bg-[var(--header-background)] p-4 border-t border-gray-200 dark:border-[var(--card-border)] relative",children:[s.jsx(x.M,{children:(o||n.length>0)&&(0,s.jsxs)(m.E.div,{className:"mb-2 flex flex-wrap items-center gap-2",children:[o&&s.jsx(h.Z,{size:18,className:"animate-spin text-gray-400"}),n.map((e,t)=>s.jsx(m.E.button,{onClick:()=>$(e),className:"px-3 py-1.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 whitespace-nowrap",children:e},t))]})}),s.jsx(x.M,{children:I&&(0,s.jsxs)(m.E.div,{className:"mb-2",children:[(0,s.jsxs)("div",{className:"relative",children:[s.jsx(y.Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-blue-500",size:20}),s.jsx("input",{type:"text",value:Z,onChange:e=>F(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),L())},placeholder:"Ask VyaparAI to draft a reply, create an order, etc...",className:"w-full bg-white dark:bg-gray-700 border-2 border-blue-400 rounded-full py-2 pl-10 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm",disabled:M}),M&&s.jsx(h.Z,{className:"absolute right-3 top-1/2 -translate-y-1/2 animate-spin text-gray-500",size:20})]}),O&&s.jsx("p",{className:"text-xs text-red-500 text-center mt-1",children:O})]})}),l&&(0,s.jsxs)("div",{className:"bg-white dark:bg-gray-700 p-2 rounded-t-lg text-sm relative border-l-2 border-blue-500 mb-2 shadow-sm",children:[s.jsx("button",{onClick:d,className:"absolute top-1 right-1 text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100",children:s.jsx(p.Z,{size:16})}),(0,s.jsxs)("p",{className:"font-semibold text-blue-600 dark:text-blue-400",children:["Replying to ","business"===l.from?"yourself":"the customer"]}),s.jsx("p",{className:"text-gray-600 dark:text-gray-300 truncate",children:l.text||"an attachment"})]}),S&&(0,s.jsxs)("div",{className:"bg-white dark:bg-gray-700 p-2 rounded-t-lg relative mb-2 shadow-sm flex items-center space-x-3",children:[s.jsx("button",{onClick:()=>{E(null),A(null),P.current&&(P.current.value="")},className:"absolute top-1 right-1 text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100",children:s.jsx(p.Z,{size:16})}),"document"===S?(0,s.jsxs)("div",{className:"flex items-center space-x-2 text-sm",children:[s.jsx(b.Z,{className:"w-8 h-8 text-blue-500"}),s.jsx("span",{className:"font-medium text-gray-700 dark:text-gray-200",children:C?.name})]}):s.jsx("img",{src:S,alt:"preview",className:"w-16 h-16 object-cover rounded-md"})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-3 bg-white dark:bg-[var(--input-background)] px-4 py-3 rounded-3xl shadow-sm",children:[s.jsx("button",{onClick:()=>_(!I),className:"p-2 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 rounded-full transition-colors",title:"Ask VyaparAI",children:s.jsx(y.Z,{className:"w-5 h-5"})}),(0,s.jsxs)("div",{className:"relative",children:[u&&s.jsx(D,{onSelectEmoji:a=>t(e+a),onClose:()=>g(!1)}),s.jsx("button",{onClick:()=>g(!u),className:"p-2 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 rounded-full transition-colors",children:s.jsx(j,{className:"w-5 h-5"})})]}),(0,s.jsxs)("div",{className:"relative",children:[f&&(0,s.jsxs)("div",{className:"absolute bottom-full mb-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 py-2",children:[(0,s.jsxs)("button",{onClick:()=>P.current?.click(),className:"flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700",children:[s.jsx(k.Z,{className:"w-4 h-4 mr-2 text-purple-500"})," Image"]}),(0,s.jsxs)("button",{onClick:()=>P.current?.click(),className:"flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700",children:[s.jsx(b.Z,{className:"w-4 h-4 mr-2 text-blue-500"})," Document"]})]}),s.jsx("button",{onClick:()=>w(!f),className:"p-2 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 rounded-full transition-colors",children:s.jsx(N,{className:"w-5 h-5"})})]}),s.jsx("input",{type:"file",ref:P,onChange:e=>{let t=e.target.files?.[0];t&&(E(t),t.type.startsWith("image/")?A(URL.createObjectURL(t)):A("document")),w(!1)},className:"hidden",accept:"image/jpeg,image/png,application/pdf,.doc,.docx"}),s.jsx("textarea",{ref:T,rows:1,value:e,onChange:e=>t(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),$())},placeholder:"Type a message...",className:"w-full bg-transparent focus:outline-none text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 resize-none max-h-32 overflow-y-auto",disabled:!!C}),s.jsx("button",{onClick:()=>$(),disabled:!e?.trim()&&!C,className:"p-3 bg-green-500 hover:bg-green-600 disabled:bg-gray-300 dark:disabled:bg-gray-600 rounded-full transition-colors flex-shrink-0",children:s.jsx(v.Z,{className:"w-5 h-5 text-white"})})]})]})};var E=a(98091);let S=({message:e,onClose:t,onConfirmDelete:a})=>s.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 animate-fade-in-up",style:{animationDuration:"0.2s"},children:(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-sm m-4",children:[(0,s.jsxs)("div",{className:"p-6",children:[s.jsx("h2",{className:"text-lg font-semibold text-gray-800",children:"Delete message?"}),s.jsx("div",{className:"my-4 p-3 bg-gray-100 rounded-md text-sm text-gray-700 truncate",children:e.text||e.fileName||"Attachment"})]}),(0,s.jsxs)("div",{className:"px-6 py-4 bg-gray-50 flex justify-end space-x-3 rounded-b-lg",children:[s.jsx("button",{onClick:t,className:"px-4 py-2 text-sm font-semibold text-gray-700 bg-transparent rounded-md hover:bg-gray-200 transition-colors",children:"Cancel"}),(0,s.jsxs)("button",{onClick:()=>a(e.id),className:"px-4 py-2 text-sm font-semibold text-red-600 bg-transparent rounded-md hover:bg-red-50 transition-colors flex items-center",children:[s.jsx(E.Z,{size:16,className:"mr-1.5"})," Delete for Everyone"]})]})]})}),A=(0,f.Z)("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]),P=(0,f.Z)("ChevronRight",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]),T=({images:e,startIndex:t,onClose:a})=>{let[l,d]=(0,r.useState)(t),i=()=>{d(t=>0===t?e.length-1:t-1)},n=()=>{d(t=>t===e.length-1?0:t+1)};return(0,r.useEffect)(()=>{let e=e=>{"Escape"===e.key&&a(),"ArrowLeft"===e.key&&i(),"ArrowRight"===e.key&&n()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[e]),(0,s.jsxs)(m.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm",onClick:a,children:[s.jsx("button",{className:"absolute top-4 right-4 text-white/70 hover:text-white z-50",onClick:a,"aria-label":"Close gallery",children:s.jsx(p.Z,{size:32})}),e.length>1&&(0,s.jsxs)(s.Fragment,{children:[s.jsx("button",{className:"absolute left-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white z-50 bg-black/20 rounded-full p-2",onClick:e=>{e.stopPropagation(),i()},"aria-label":"Previous image",children:s.jsx(A,{size:32})}),s.jsx("button",{className:"absolute right-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white z-50 bg-black/20 rounded-full p-2",onClick:e=>{e.stopPropagation(),n()},"aria-label":"Next image",children:s.jsx(P,{size:32})})]}),s.jsx(x.M,{mode:"wait",children:s.jsx(m.E.img,{src:e[l].url,alt:`Product image ${l+1}`,className:"max-w-[90vw] max-h-[90vh] object-contain",initial:{opacity:.8,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:.8,scale:.95},transition:{duration:.2},onClick:e=>e.stopPropagation()},l)}),(0,s.jsxs)("div",{className:"absolute bottom-4 text-white/80 text-sm",children:[l+1," / ",e.length]})]})};var I=a(28676);let _=({line:e})=>{if(""===e.trim())return s.jsx("div",{className:"h-3"});let t=e.trim(),a=!1;t.startsWith("* ")&&(a=!0,t=t.substring(2));let l=t.split("**");if(3===l.length&&""===l[0]&&""===l[2].trim())return s.jsx("h4",{className:"font-semibold text-base mt-4 mb-2 text-gray-900 dark:text-gray-100",children:l[1]});let d=l.map((e,t)=>t%2==1?s.jsx("strong",{className:"font-semibold text-gray-800 dark:text-gray-200",children:e},t):s.jsx(r.Fragment,{children:e},t));return a?(0,s.jsxs)("div",{className:"flex items-start pl-2",children:[s.jsx("span",{className:"mr-2 mt-1 text-gray-500 dark:text-gray-400",children:"•"}),s.jsx("p",{className:"flex-1",children:d})]}):s.jsx("p",{children:d})},Z=({isOpen:e,onClose:t,summary:a,isLoading:r})=>(0,s.jsxs)(I.Z,{isOpen:e,onClose:t,title:"Conversation Summary",children:[s.jsx("div",{className:"min-h-[200px] max-h-[60vh] overflow-y-auto pr-2",children:r?(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center h-full py-8",children:[s.jsx(h.Z,{className:"animate-spin text-blue-500",size:32}),s.jsx("p",{className:"mt-4 text-sm text-gray-500 dark:text-gray-400",children:"Generating summary..."})]}):s.jsx(m.E.div,{className:"text-sm text-gray-700 dark:text-gray-300 leading-relaxed",variants:{visible:{transition:{staggerChildren:.05}}},initial:"hidden",animate:"visible",children:a.split("\n").map((e,t)=>s.jsx(m.E.div,{variants:{hidden:{opacity:0,y:10},visible:{opacity:1,y:0}},children:s.jsx(_,{line:e})},t))})}),s.jsx("div",{className:"flex justify-end mt-4 pt-4 border-t dark:border-gray-700",children:s.jsx("button",{onClick:t,className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Close"})})]});var F=a(48998),M=a(32933),q=a(67211),O=a(31540);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let z=(0,f.Z)("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]),$=(0,f.Z)("Star",[["polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2",key:"8f66p6"}]]),L=(0,f.Z)("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),U=(0,f.Z)("BookText",[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20",key:"t4utmx"}],["path",{d:"M8 7h6",key:"1f0q6e"}],["path",{d:"M8 11h8",key:"vwpz6n"}]]),R=(0,f.Z)("Phone",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}]]),B=(0,f.Z)("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);var Q=a(45804);let H=({message:e,onImageClick:t})=>{let{product:a}=e;if(!a||!a.images||0===a.images.length)return(0,s.jsxs)("div",{className:"w-64 p-3 rounded-lg border bg-gray-50",children:[s.jsx("p",{className:"font-semibold text-sm",children:a?.name||"Product"}),s.jsx("p",{className:"text-xs text-gray-500",children:"Image not available"}),(0,s.jsxs)("p",{className:"font-bold text-green-700 mt-1",children:["₹",a?.price.toLocaleString("en-IN")]})]});let r=a.images,l=r.length,d=r.slice(0,4),i=l-4;return(0,s.jsxs)("div",{className:"w-64 rounded-lg overflow-hidden relative shadow-md cursor-pointer",children:[1===l?s.jsx("div",{className:"aspect-square w-full",onClick:()=>t(r,0),children:s.jsx("img",{src:r[0].url,alt:a.name,className:"w-full h-full object-cover"})}):2===l?(0,s.jsxs)("div",{className:"grid grid-cols-2 aspect-square w-full gap-1",children:[s.jsx("img",{src:r[0].url,alt:`${a.name} 1`,className:"w-full h-full object-cover",onClick:()=>t(r,0)}),s.jsx("img",{src:r[1].url,alt:`${a.name} 2`,className:"w-full h-full object-cover",onClick:()=>t(r,1)})]}):3===l?(0,s.jsxs)("div",{className:"grid grid-cols-2 grid-rows-2 aspect-square w-full gap-1",children:[s.jsx("img",{src:r[0].url,alt:`${a.name} 1`,className:"w-full h-full object-cover col-span-1 row-span-2",onClick:()=>t(r,0)}),s.jsx("img",{src:r[1].url,alt:`${a.name} 2`,className:"w-full h-full object-cover",onClick:()=>t(r,1)}),s.jsx("img",{src:r[2].url,alt:`${a.name} 3`,className:"w-full h-full object-cover",onClick:()=>t(r,2)})]}):s.jsx("div",{className:"grid grid-cols-2 grid-rows-2 aspect-square w-full gap-1",children:d.map((e,l)=>(0,s.jsxs)("div",{className:"relative",onClick:()=>t(r,l),children:[s.jsx("img",{src:e.url,alt:`${a.name} ${l+1}`,className:"w-full h-full object-cover"}),3===l&&i>0&&s.jsx("div",{className:"absolute inset-0 bg-black/60 flex items-center justify-center",children:(0,s.jsxs)("span",{className:"text-white text-2xl font-bold",children:["+",i]})})]},e.id))}),(0,s.jsxs)("div",{className:"absolute inset-0 p-3 flex flex-col justify-end bg-gradient-to-t from-black/80 via-black/40 to-transparent pointer-events-none",children:[(0,s.jsxs)("div",{children:[s.jsx("h4",{className:"font-bold text-sm text-white [text-shadow:0_1px_2px_rgba(0,0,0,0.5)]",children:a.name}),(0,s.jsxs)("p",{className:"font-semibold text-white mt-1 text-base [text-shadow:0_1px_2px_rgba(0,0,0,0.5)]",children:["₹",a.price.toLocaleString("en-IN")]})]}),(0,s.jsxs)("div",{className:"flex justify-end items-center text-xs text-white/80 mt-1 [text-shadow:0_1px_1px_rgba(0,0,0,0.5)]",children:[s.jsx("span",{children:(0,Q.WU)(new Date(e.createdAt),"p")}),"business"===e.from&&(e=>{switch(e){case"pending":return s.jsx(F.Z,{size:16,className:"text-white/80 ml-1"});case"sent":return s.jsx(M.Z,{size:16,className:"text-white/80 ml-1"});case"delivered":return s.jsx(q.Z,{size:16,className:"text-white/80 ml-1"});case"read":return s.jsx(q.Z,{size:16,className:"text-[#53bdeb] ml-1"});case"failed":return s.jsx(p.Z,{size:16,className:"text-red-400 ml-1"});default:return null}})(e.status)]})]})]})},J=e=>e?"image"===e.type&&e.mediaUrl?e.mediaUrl:"product"===e.type&&e.product?.images?.[0]?.url?e.product.images[0].url:null:null,V=({chat:e,onPromoteCustomer:t,messages:a=[],onMessagesChange:l,initialMessage:d,initialNextCursor:i,onCreateOrder:n,onBack:o,onShowPanel:c})=>{let[g,y]=(0,r.useState)(null),[b,f]=(0,r.useState)(null),[j,k]=(0,r.useState)(""),[N,v]=(0,r.useState)(null),w=(0,r.useRef)(null),D=(0,r.useRef)(null),E=(0,r.useRef)(null),A=(0,r.useRef)(0),[P,I]=(0,r.useState)(null),[_,V]=(0,r.useState)(!0),[W,G]=(0,r.useState)(!1),[Y,K]=(0,r.useState)([]),[X,ee]=(0,r.useState)(!1),[et,ea]=(0,r.useState)(""),[es,er]=(0,r.useState)(!1),[el,ed]=(0,r.useState)(!1);(0,r.useEffect)(()=>{I(i??null),V(!!i)},[i]);let ei=a.length>0?a[a.length-1].id:null,en=()=>{w.current?.scrollIntoView({behavior:"smooth"})};(0,r.useEffect)(()=>{en()},[ei]),(0,r.useEffect)(()=>{d&&e&&k(d)},[d,e?.id]);let eo=(0,r.useCallback)(async()=>{if(a&&0!==a.length){ee(!0);try{let e=a.slice(-3).map(e=>`${"business"===e.from?"Business":"Customer"}: ${e.text||"[attachment]"}`).join("\n"),t=await fetch("/api/ai/smart-replies",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({history:e})});if(t.ok){let e=await t.json();K(e.replies||[])}}catch(e){console.error("Failed to fetch smart replies:",e),K([])}finally{ee(!1)}}},[a]);(0,r.useEffect)(()=>{let e=a[a.length-1];e&&"customer"===e.from?eo():K([])},[a,eo]);let ec=async()=>{if(a&&0!==a.length){ed(!0),er(!0),ea("");try{let e=a.map(e=>`${"business"===e.from?"Business":"Customer"}: ${e.text||"[attachment]"}`).join("\n"),t=await fetch("/api/ai/summarize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({history:e})});if(t.ok){let e=await t.json();ea(e.text)}else throw Error("Failed to generate summary.")}catch(e){console.error("Summarization error:",e),ea("Sorry, we couldn't generate a summary at this time.")}finally{er(!1)}}},eu=(0,r.useCallback)(async()=>{if(!_||W||!P||!e)return;let t=D.current;t&&(A.current=t.scrollHeight),G(!0);try{let t=await fetch(`/api/messages?contactId=${e.id}&limit=30&cursor=${P}`);if(t.ok){let{messages:e,nextCursor:a}=await t.json();l(t=>[...e,...Array.isArray(t)?t:[]]),I(a),V(!!a)}}catch(e){console.error("Failed to load more messages:",e)}},[_,W,P,e,l]);(0,r.useLayoutEffect)(()=>{let e=D.current;e&&W&&(e.scrollTop=e.scrollHeight-A.current,G(!1))},[a.length,W]),(0,r.useEffect)(()=>{let e=new IntersectionObserver(([e])=>{e.isIntersecting&&_&&!W&&eu()},{threshold:1}),t=E.current;return t&&e.observe(t),()=>{t&&e.unobserve(t)}},[_,W,eu]);let em=e=>{if(!e)return;let t=document.getElementById(`message-${e}`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("highlight-message"),setTimeout(()=>{t.classList.remove("highlight-message")},1500))},ex=e=>e?e.text?e.text:e.fileName?e.fileName:"image"===e.type?"\uD83D\uDCF7 Image":"document"===e.type?"\uD83D\uDCCE Document":e.product?.name?`📦 ${e.product.name}`:"an attachment":null,eg=async(t,a)=>{if(!e||!t.trim()&&!a)return;let s=Date.now().toString();K([]);let r={id:s,from:"business",to:e.phone,text:a?a.name:t,createdAt:new Date().toISOString(),type:a?a.type.startsWith("image/")?"image":"document":"text",contactId:e.id,status:"pending",mediaUrl:a?URL.createObjectURL(a):void 0,fileName:a?a.name:void 0,replyToId:g?.id||null,replyToText:ex(g),replyToMediaUrl:J(g)};l(e=>Array.isArray(e)?[...e,r]:[r]),k(""),y(null);try{let r={contactId:e.id,text:t,replyingToId:g?.id||null};if(a){let e=new FormData;e.append("file",a);let t=await fetch("/api/uploads/file",{method:"POST",body:e}),s=await t.json();if(!t.ok)throw Error("File upload failed");r.mediaUrl=s.url,r.fileName=a.name,r.type=a.type.startsWith("image/")?"image":"document"}let d=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!d.ok){let e=await d.json();throw Error(e.error||"Failed to send message")}let i=await d.json();l(e=>{let t=Array.isArray(e)?e:[];return t.some(e=>e.id===i.id)?t.filter(e=>e.id!==s):t.map(e=>e.id===s?i:e)})}catch(e){console.error("Failed to send message:",e),l(e=>(Array.isArray(e)?e:[]).map(e=>e.id===s?{...e,status:"failed"}:e))}},eh=async e=>{f(null),l(t=>(Array.isArray(t)?t:[]).filter(t=>t.id!==e));try{(await fetch(`/api/messages/${e}`,{method:"DELETE"})).ok||l(a)}catch(e){l(a)}},ey=e=>{switch(e){case"pending":return s.jsx(F.Z,{size:16,className:"text-gray-500 dark:text-gray-400 ml-1"});case"sent":return s.jsx(M.Z,{size:16,className:"text-gray-500 dark:text-gray-400 ml-1"});case"delivered":return s.jsx(q.Z,{size:16,className:"text-gray-500 dark:text-gray-400 ml-1"});case"read":return s.jsx(q.Z,{size:16,className:"text-blue-500 ml-1"});case"failed":return s.jsx(p.Z,{size:16,className:"text-red-500 ml-1"});default:return null}},ep=(e,t)=>{v({images:e,startIndex:t})},eb=e=>{switch(e.type){case"image":return(0,s.jsxs)("div",{children:[e.mediaUrl&&s.jsx("img",{src:e.mediaUrl,alt:e.text||"Sent media",className:"rounded-md max-w-xs cursor-pointer",onClick:()=>ep([{id:e.id,url:e.mediaUrl}],0)}),e.text&&s.jsx("p",{className:"text-sm whitespace-pre-wrap mt-1",children:e.text})]});case"document":return(0,s.jsxs)("a",{href:e.mediaUrl,target:"_blank",rel:"noopener noreferrer",className:"flex items-center bg-black/5 dark:bg-black/20 p-2 rounded-lg hover:bg-black/10 dark:hover:bg-black/30",children:[s.jsx(u.Z,{name:"file",className:"w-8 h-8 text-gray-600 dark:text-gray-300 mr-2 flex-shrink-0"}),s.jsx("div",{className:"min-w-0",children:s.jsx("p",{className:"truncate font-medium",children:e.fileName||"Document"})}),s.jsx(O.Z,{className:"w-5 h-5 ml-2 text-gray-500 dark:text-gray-400 flex-shrink-0"})]});case"product":if(!e.product)return(0,s.jsxs)("p",{className:"px-3 py-2 text-sm italic",children:["Product: ",e.text||"Details not available."]});return s.jsx(H,{message:e,onImageClick:ep});default:return s.jsx("p",{className:"text-sm whitespace-pre-wrap",children:e.text})}};return e?(0,s.jsxs)("div",{className:"w-full flex flex-col h-full",children:[(0,s.jsxs)("header",{className:"bg-white dark:bg-[var(--header-background)] p-4 border-b border-gray-200 dark:border-[var(--card-border)] shadow-sm flex items-center justify-between z-10",children:[(0,s.jsxs)("div",{className:"flex items-center min-w-0",children:[s.jsx("button",{onClick:o,className:"mr-2 p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 md:hidden","aria-label":"Back to chat list",children:s.jsx(u.Z,{name:"arrowLeft",size:20})}),s.jsx("div",{className:"w-10 h-10 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center justify-center mr-3 flex-shrink-0",children:s.jsx("span",{className:"font-bold text-gray-600 dark:text-gray-300",children:(e.name||"?").charAt(0).toUpperCase()})}),(0,s.jsxs)("div",{className:"min-w-0",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[s.jsx("h2",{className:"font-semibold text-gray-800 dark:text-gray-100 truncate",children:e.name}),s.jsx("button",{onClick:t,title:e.isMasterCustomer?"Master Customer":"Promote to Master Customer",children:e.isMasterCustomer?s.jsx($,{className:"text-yellow-500 fill-yellow-400",size:18}):s.jsx(L,{className:"text-gray-400 hover:text-blue-500",size:18})})]}),s.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 truncate",children:e.phone})]})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-1 md:space-x-2",children:[s.jsx("button",{onClick:ec,className:"p-2.5 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full",title:"Summarize Conversation",children:s.jsx(U,{size:20})}),s.jsx("button",{onClick:c,className:"p-2.5 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full md:hidden",title:"Contact Info",children:s.jsx(u.Z,{name:"info",size:20})}),s.jsx("button",{className:"p-2.5 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full hidden md:block",title:"Call Contact",children:s.jsx(R,{size:20})}),s.jsx("button",{className:"p-2.5 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full hidden md:block",title:"More Options",children:s.jsx(B,{size:20})})]})]}),s.jsx("main",{className:"flex-1 relative chat-background",children:(0,s.jsxs)("div",{ref:D,className:"absolute inset-0 overflow-y-auto p-4",children:[s.jsx("div",{ref:E,className:"h-1"}),W&&s.jsx("div",{className:"text-center py-2",children:s.jsx(h.Z,{className:"animate-spin text-gray-500"})}),s.jsx(x.M,{children:(()=>{let e=Array.isArray(a)?a:[],t=null;return e.map((e,a)=>{let r=(0,Q.WU)(new Date(e.createdAt),"yyyy-MM-dd"),l=r!==t;t=r;let d="business"===e.from,i="product"===e.type&&!!e.product;return(0,s.jsxs)(m.E.div,{children:[l&&s.jsx("div",{className:"text-center my-4",children:s.jsx("span",{className:"bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow text-gray-600 dark:text-gray-300 text-xs font-semibold px-3 py-1 rounded-full",children:(0,Q.WU)(new Date(e.createdAt),"MMMM d, yyyy")})}),s.jsx("div",{id:`message-${e.id}`,className:`flex ${d?"justify-end":"justify-start"} mt-1`,children:(0,s.jsxs)("div",{className:`flex items-end gap-2 group ${d?"flex-row-reverse":"flex-row"}`,children:[(0,s.jsxs)("div",{className:`chat-bubble ${d?"outgoing":"incoming"} 
                                 ${i?"p-0 overflow-hidden bg-transparent shadow-none":""}`,children:[e.replyToId&&s.jsx("div",{onClick:()=>em(e.replyToId),className:"text-xs bg-black/5 dark:bg-black/20 p-1.5 rounded-t-md mb-1 border-l-2 border-blue-500 cursor-pointer overflow-hidden",children:(0,s.jsxs)("div",{className:"flex items-start gap-2",children:[e.replyToMediaUrl&&s.jsx("img",{src:e.replyToMediaUrl,alt:"reply preview",className:"w-10 h-10 object-cover rounded-sm flex-shrink-0"}),s.jsx("div",{className:"flex-1 min-w-0",children:s.jsx("p",{className:"truncate",children:e.replyToText})})]})}),eb(e),!i&&(0,s.jsxs)("div",{className:"flex justify-end items-center text-xs mt-1 text-gray-500 dark:text-gray-400",children:[s.jsx("span",{children:(0,Q.WU)(new Date(e.createdAt),"p")}),d&&ey(e.status)]})]}),(0,s.jsxs)("div",{className:"flex opacity-0 group-hover:opacity-100 transition-opacity self-center",children:[s.jsx("button",{onClick:()=>y(e),className:"p-1 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full",title:"Reply",children:s.jsx(z,{size:16})}),d&&s.jsx("button",{onClick:()=>f(e),className:"p-1 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full",title:"Delete Message",children:s.jsx(u.Z,{name:"trash2",size:16})})]})]})})]},e.id)})})()}),s.jsx("div",{ref:w})]})}),s.jsx(C,{newMessage:j,setNewMessage:k,sendMessage:eg,messages:a,smartReplies:Y,isFetchingReplies:X,replyingTo:g?{text:ex(g),from:g.from}:null,onCancelReply:()=>y(null),onCreateOrder:n}),b&&s.jsx(S,{message:b,onClose:()=>f(null),onConfirmDelete:eh}),N&&s.jsx(T,{images:N.images,startIndex:N.startIndex,onClose:()=>v(null)}),s.jsx(Z,{isOpen:el,onClose:()=>ed(!1),summary:et,isLoading:es})]}):(0,s.jsxs)("div",{className:"w-full chat-background flex flex-col items-center justify-center text-center h-full",children:[s.jsx(u.Z,{name:"messageCircle",size:48,className:"mx-auto text-gray-400 dark:text-gray-500"}),s.jsx("h2",{className:"text-2xl font-medium mt-4 text-gray-700 dark:text-gray-200",children:"Welcome to VyaparConnect"}),s.jsx("p",{className:"mt-2 text-gray-500 dark:text-gray-400",children:"Select a chat to start messaging."})]})},W=({socket:e,contacts:t,setContacts:a,activeContact:r,onSelectContact:l,onPromoteCustomer:d,messages:i,setMessages:n,initialMessage:o,initialCursor:c,onCreateOrder:u,onShowPanel:m})=>(0,s.jsxs)("div",{className:"flex h-full bg-white overflow-hidden",children:[s.jsx("div",{className:`${r?"hidden":"flex"} w-full md:flex md:w-auto flex-col`,children:s.jsx(g,{socket:e,activeContactId:r?.id||null,onSelectChat:l})}),s.jsx("div",{className:`${r?"flex":"hidden"} flex-1 md:flex flex-col min-w-0`,children:s.jsx(V,{chat:r,onPromoteCustomer:d,messages:i,onMessagesChange:n,initialMessage:o,initialNextCursor:c,onCreateOrder:u,onBack:()=>l(null),onShowPanel:m})})]});var G=a(86333),Y=a(83855),K=a(48705),X=a(36283);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let ee=(0,f.Z)("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]),et=(0,f.Z)("UserCheck",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["polyline",{points:"16 11 18 13 22 9",key:"1pwet4"}]]),ea={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.05}}},es={hidden:{opacity:0,y:15},visible:{opacity:1,y:0}},er=({workflow:e})=>{let t={QUOTATION_FOCUSED:{label:"Q",color:"bg-green-100 text-green-800",title:"Quotation Specific"},ORDER_FOCUSED:{label:"O",color:"bg-orange-100 text-orange-800",title:"Order Specific"},HYBRID:{label:"H",color:"bg-blue-100 text-blue-800",title:"Hybrid"}}[e];return t?s.jsx("span",{title:t.title,className:`text-[10px] font-bold h-4 w-4 flex items-center justify-center rounded-full ml-2 flex-shrink-0 ${t.color}`,children:t.label}):null},el=({products:e,onShareProduct:t,onEditProduct:a,onDeleteProduct:r})=>0===e.length?s.jsx("p",{className:"p-4 text-center text-gray-500",children:"No products found for this workspace."}):s.jsx(m.E.div,{className:"p-2",variants:ea,initial:"hidden",animate:"visible",children:e.map(e=>(0,s.jsxs)(m.E.div,{variants:es,layout:!0,className:"p-2 mb-2 border dark:border-gray-700 rounded-lg flex items-center hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[s.jsx("img",{src:e.imageUrl,alt:e.name,className:"w-16 h-16 object-cover rounded-md mr-3 flex-shrink-0"}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex items-center",children:[s.jsx("h3",{className:"font-semibold text-sm truncate",children:e.name}),s.jsx(er,{workflow:e.workflow})]}),(0,s.jsxs)("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:["₹",e.price.toLocaleString()]})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-1 ml-2",children:[s.jsx("button",{onClick:()=>t(e),className:"p-2 text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-full",title:"Share Product",children:s.jsx(u.Z,{name:"share2",size:16})}),s.jsx("button",{onClick:()=>a(e),className:"p-2 text-gray-500 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-full",title:"Edit Product",children:s.jsx(u.Z,{name:"edit",size:16})}),s.jsx("button",{onClick:()=>r(e),className:"p-2 text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-full",title:"Delete Product",children:s.jsx(u.Z,{name:"trash2",size:16})})]})]},e.id))});var ed=a(69508);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let ei=(0,f.Z)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]),en=({children:e,color:t})=>s.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${{green:"bg-green-100 text-green-800",gray:"bg-gray-200 text-gray-800",red:"bg-red-100 text-red-800",yellow:"bg-yellow-100 text-yellow-800"}[t]}`,children:e}),eo=e=>{switch(e){case"PAID":case"BILLED":case"CONFIRMED":return"green";case"PARTIALLY_PAID":return"yellow";case"CANCELLED":return"red";default:return"gray"}},ec={hidden:{},visible:{transition:{staggerChildren:.07}}},eu={hidden:{y:15,opacity:0},visible:{y:0,opacity:1}},em=({contactId:e,onNewQuote:t,onBillQuote:a,onSendDraft:l,onSetFollowUp:d})=>{let[i,n]=(0,r.useState)([]),[o,c]=(0,r.useState)(!0),[u,x]=(0,r.useState)(null),[g,y]=(0,r.useState)(null),p=async()=>{c(!0);try{let t=await fetch(`/api/quotations?contactId=${e}`);t.ok&&n(await t.json())}catch(e){console.error("Failed to fetch quotations:",e)}finally{c(!1)}};(0,r.useEffect)(()=>{e&&p()},[e]);let b=async()=>{if(u){y(u.id);try{if(!(await fetch(`/api/quotations/${u.id}`,{method:"DELETE"})).ok)throw Error("Failed to delete quotation");n(e=>e.filter(e=>e.id!==u.id)),x(null)}catch(e){console.error(e)}finally{y(null)}}},f=e=>{switch(e.status){case"DRAFT":return(0,s.jsxs)("button",{onClick:()=>l(e),className:"flex items-center text-blue-600 text-sm font-semibold hover:underline",children:[s.jsx(v.Z,{size:14,className:"mr-1"})," Review & Send"]});case"SENT":return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("button",{onClick:()=>d(e),className:"flex items-center text-orange-600 text-sm font-semibold hover:underline",children:[s.jsx(F.Z,{size:14,className:"mr-1"})," Set Follow-up"]}),(0,s.jsxs)("button",{onClick:()=>a(e),className:"flex items-center text-green-600 text-sm font-semibold hover:underline ml-2",children:[s.jsx(ed.Z,{size:14,className:"mr-1"})," Finalize & Bill"]})]});case"CONFIRMED":return(0,s.jsxs)("button",{onClick:()=>a(e),className:"flex items-center text-green-600 text-sm font-semibold hover:underline",children:[s.jsx(v.Z,{size:14,className:"mr-1"})," Finalize & Bill"]});case"BILLED":case"PARTIALLY_PAID":return(0,s.jsxs)("button",{onClick:()=>a(e),className:"flex items-center text-blue-600 text-sm font-semibold hover:underline",children:[s.jsx(ed.Z,{size:14,className:"mr-1"})," Manage Payments"]});case"PAID":return s.jsx("span",{className:"text-sm font-semibold text-gray-400",children:"Paid in full"});case"CANCELLED":return s.jsx("span",{className:"text-sm font-semibold text-gray-400",children:"Cancelled"});default:return null}};return(0,s.jsxs)("div",{className:"p-4",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[s.jsx("h3",{className:"font-bold text-lg",children:"Quotation History"}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[s.jsx("button",{onClick:p,disabled:o,className:"p-2 text-gray-500 hover:bg-gray-100 rounded-full disabled:opacity-50",children:s.jsx(ei,{size:16,className:o?"animate-spin":""})}),(0,s.jsxs)("button",{onClick:t,className:"flex items-center bg-blue-600 text-white text-sm px-3 py-2 rounded-md hover:bg-blue-700",children:[s.jsx(Y.Z,{size:16,className:"mr-1"})," New"]})]})]}),o?s.jsx("p",{className:"text-sm text-gray-500 text-center py-8",children:"Loading..."}):0===i.length?s.jsx("p",{className:"text-sm text-gray-500 text-center py-8",children:"No quotations found for this contact."}):s.jsx(m.E.ul,{className:"space-y-3",variants:ec,initial:"hidden",animate:"visible",children:i.map(e=>(0,s.jsxs)(m.E.li,{variants:eu,className:"p-3 border dark:border-gray-700 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[(0,s.jsxs)("div",{className:"flex justify-between items-start",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("p",{className:"font-semibold text-sm",children:["Quotation #",e.id.substring(0,6)]}),s.jsx("p",{className:"text-xs text-gray-500",children:(0,Q.WU)(new Date(e.createdAt),"PP")})]}),s.jsx(en,{color:eo(e.status),children:e.status.replace("_"," ")})]}),(0,s.jsxs)("div",{className:"flex justify-between items-end mt-2",children:[(0,s.jsxs)("p",{className:"text-lg font-bold",children:["₹",e.total.toLocaleString("en-IN")]}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[f(e),s.jsx("button",{onClick:()=>x(e),className:"p-1.5 text-gray-400 hover:bg-red-100 hover:text-red-600 rounded-full dark:hover:bg-red-900/30",title:"Delete Quotation",disabled:!!g,children:g===e.id?s.jsx(h.Z,{className:"animate-spin",size:16}):s.jsx(E.Z,{size:16})})]})]})]},e.id))}),u&&(0,s.jsxs)(I.Z,{isOpen:!!u,onClose:()=>x(null),title:"Confirm Deletion",children:[(0,s.jsxs)("p",{children:["Are you sure you want to delete Quotation ",(0,s.jsxs)("strong",{children:["#",u.id.substring(0,6)]}),"? This action cannot be undone."]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-2 mt-4",children:[s.jsx("button",{onClick:()=>x(null),className:"px-4 py-2 border dark:border-gray-600 rounded-md",children:"Cancel"}),s.jsx("button",{onClick:b,className:"px-4 py-2 bg-red-600 text-white rounded-md",disabled:!!g,children:g?"Deleting...":"Delete"})]})]})]})},ex=(0,f.Z)("Link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]),eg=(0,f.Z)("Banknote",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"2",key:"9lu3g6"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M6 12h.01M18 12h.01",key:"113zkx"}]]),eh=(0,f.Z)("QrCode",[["rect",{width:"5",height:"5",x:"3",y:"3",rx:"1",key:"1tu5fj"}],["rect",{width:"5",height:"5",x:"16",y:"3",rx:"1",key:"1v8r4q"}],["rect",{width:"5",height:"5",x:"3",y:"16",rx:"1",key:"1x03jg"}],["path",{d:"M21 16h-3a2 2 0 0 0-2 2v3",key:"177gqh"}],["path",{d:"M21 21v.01",key:"ents32"}],["path",{d:"M12 7v3a2 2 0 0 1-2 2H7",key:"8crl2c"}],["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M12 3h.01",key:"n36tog"}],["path",{d:"M12 16v.01",key:"133mhm"}],["path",{d:"M16 12h1",key:"1slzba"}],["path",{d:"M21 12v.01",key:"1lwtk9"}],["path",{d:"M12 21v-1",key:"1880an"}]]),ey=({quotation:e,onBack:t,onFinalized:a,socket:l})=>{let[d,i]=(0,r.useState)(e),[n,o]=(0,r.useState)(d.discountPercentage||0),[c,u]=(0,r.useState)(d.taxRate||0),[m,x]=(0,r.useState)(d.deliveryCharges||0),[g,y]=(0,r.useState)(d.total),[p,b]=(0,r.useState)(d.payments||[]),[f,j]=(0,r.useState)(!1),[k,N]=(0,r.useState)(null),[w,D]=(0,r.useState)(""),[C,E]=(0,r.useState)(!1),[S,A]=(0,r.useState)({amount:"",method:"Cash",notes:""}),P=p.reduce((e,t)=>e+t.amount,0),T=g-P,_="DRAFT"!==d.status&&"SENT"!==d.status&&"CONFIRMED"!==d.status;(0,r.useEffect)(()=>{let e=d.subtotal,t=e*n/100,a=e-t,s=a*c/100;y(a+s+m)},[n,c,m,d.subtotal]);let Z=async()=>{try{let e=await fetch(`/api/quotations/${d.id}/payments`);if(e.ok){let t=await e.json();b(t)}}catch(e){console.error(e)}};(0,r.useEffect)(()=>{if(Z(),l){let e=e=>{e.id===d.id&&(i(e),b(e.payments||[]))};return l.on("quotation_update",e),()=>{l.off("quotation_update",e)}}},[d.id,l]);let F=async()=>{j(!0),D("");try{let e=await fetch(`/api/quotations/${d.id}/finalize`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({discountPercentage:n,taxRate:c,deliveryCharges:m,total:g})});if(!e.ok)throw Error("Failed to save bill.");let t=await e.json();i(t)}catch(e){D(e.message)}finally{j(!1)}},M=async(e,t)=>{N(e),D("");try{let a={action:e};void 0!==t&&t>0&&(a.amount=t);let s=await fetch(`/api/quotations/${d.id}/send-bill-action`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok){let e=await s.json();throw Error(e.error||"Action failed.")}}catch(e){D(e.message)}finally{N(null)}},q=async e=>{e.preventDefault(),j(!0),D("");try{let e=await fetch(`/api/quotations/${d.id}/payments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...S,amount:parseFloat(S.amount)})}),t=await e.json();if(!e.ok)throw Error(t.error||"Failed to add payment.");i(e=>e?{...e,status:t.status,payments:t.payments}:t),b(t.payments||[]),E(!1),A({amount:"",method:"Cash",notes:""})}catch(e){D(e.message)}finally{j(!1)}};return(0,s.jsxs)("div",{className:"p-4 space-y-4",children:[w&&s.jsx("p",{className:"text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-300 p-2 rounded-md text-sm mb-2",children:w}),(0,s.jsxs)("div",{className:"p-3 border dark:border-gray-700 rounded-lg space-y-3",children:[s.jsx("h4",{className:"font-semibold text-sm text-gray-800 dark:text-gray-100",children:"Final Bill Calculation"}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Discount (%)"}),s.jsx("input",{type:"number",value:n,onChange:e=>o(parseFloat(e.target.value)||0),className:"w-full border rounded-md p-1.5 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",disabled:_})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Tax / GST (%)"}),s.jsx("input",{type:"number",value:c,onChange:e=>u(parseFloat(e.target.value)||0),className:"w-full border rounded-md p-1.5 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",disabled:_})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Delivery Charges (₹)"}),s.jsx("input",{type:"number",value:m,onChange:e=>x(parseFloat(e.target.value)||0),className:"w-full border rounded-md p-1.5 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",disabled:_})]}),(0,s.jsxs)("div",{className:"text-right font-bold text-lg text-gray-800 dark:text-gray-100",children:["Total: ₹",g.toFixed(2)]}),!_&&s.jsx("button",{onClick:F,disabled:f,className:"w-full bg-blue-600 text-white py-2 rounded-md text-sm font-semibold disabled:opacity-50",children:f?"Saving...":"Save & Lock Bill"})]}),_&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"p-3 border dark:border-gray-700 rounded-lg",children:[s.jsx("h4",{className:"font-semibold text-sm mb-2 text-gray-800 dark:text-gray-100",children:"Payment Status"}),(0,s.jsxs)("div",{className:"text-sm space-y-1 text-gray-700 dark:text-gray-300",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Total Bill:"})," ",(0,s.jsxs)("span",{className:"font-bold text-gray-800 dark:text-gray-100",children:["₹",g.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Total Paid:"})," ",(0,s.jsxs)("span",{className:"font-bold text-green-600 dark:text-green-400",children:["₹",P.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Amount Due:"})," ",(0,s.jsxs)("span",{className:"font-bold text-red-600 dark:text-red-400",children:["₹",T.toFixed(2)]})]})]}),s.jsx("div",{className:"mt-2 text-xs text-gray-500 dark:text-gray-400 max-h-24 overflow-y-auto",children:p.map(e=>(0,s.jsxs)("div",{className:"flex justify-between items-center border-t dark:border-gray-600 py-1",children:[(0,s.jsxs)("span",{children:[e.method," (",(0,Q.WU)(new Date(e.createdAt),"PP"),")"]}),(0,s.jsxs)("span",{children:["₹",e.amount.toFixed(2)]})]},e.id))}),(0,s.jsxs)("button",{onClick:()=>E(!0),className:"w-full mt-3 flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 py-2 rounded-md",children:[s.jsx(Y.Z,{size:16,className:"mr-1"})," Record Manual Payment"]})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[s.jsx("h4",{className:"font-semibold text-sm pt-2 text-gray-800 dark:text-gray-100",children:"Payment Actions"}),s.jsx("button",{onClick:()=>M("send_final_bill"),disabled:!!k,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_final_bill"===k?s.jsx(h.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(v.Z,{size:16,className:"mr-2"})," Send Bill Image"]})}),s.jsx("button",{onClick:()=>M("send_razorpay",T),disabled:!!k||T<=0,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_razorpay"===k?s.jsx(h.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(ex,{size:16,className:"mr-2"})," Send Payment Link"]})}),s.jsx("button",{onClick:()=>M("send_bank_details",T),disabled:!!k||T<=0,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_bank_details"===k?s.jsx(h.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(eg,{size:16,className:"mr-2"})," Send Bank Details"]})}),s.jsx("button",{onClick:()=>M("send_qr_code",T),disabled:!!k||T<=0,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_qr_code"===k?s.jsx(h.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(eh,{size:16,className:"mr-2"})," Send UPI QR Code"]})})]})]}),s.jsx(I.Z,{isOpen:C,onClose:()=>E(!1),title:"Record Manual Payment",children:(0,s.jsxs)("form",{onSubmit:q,className:"space-y-3",children:[(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Amount"}),s.jsx("input",{type:"number",placeholder:"Amount paid",value:S.amount,onChange:e=>A(t=>({...t,amount:e.target.value})),required:!0,className:"w-full border rounded-md p-2 text-sm mt-1 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Method"}),(0,s.jsxs)("select",{value:S.method,onChange:e=>A(t=>({...t,method:e.target.value})),className:"w-full border rounded-md p-2 text-sm mt-1 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",children:[s.jsx("option",{children:"Cash"})," ",s.jsx("option",{children:"Bank Transfer"})," ",s.jsx("option",{children:"UPI"})," ",s.jsx("option",{children:"Other"})]})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Notes (Optional)"}),s.jsx("input",{type:"text",placeholder:"e.g., Transaction ID",value:S.notes,onChange:e=>A(t=>({...t,notes:e.target.value})),className:"w-full border rounded-md p-2 text-sm mt-1 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"})]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2 pt-2",children:[s.jsx("button",{type:"button",onClick:()=>E(!1),className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:f,className:"px-4 py-2 text-sm bg-green-600 text-white rounded-md disabled:opacity-50",children:f?"Adding...":"Add Payment"})]})]})})]})};function ep(e,t){switch(t.type){case"UPDATE_FIELD":return{...e,[t.field]:t.payload};case"UPDATE_ITEM":{let a=[...e.items];return a[t.index][t.field]=t.payload,"productId"===t.field&&t.product&&(a[t.index].price=t.product.price,a[t.index].name=t.product.name),{...e,items:a}}case"ADD_ITEM":return{...e,items:[...e.items,{productId:"",quantity:1,price:0}]};case"REMOVE_ITEM":return{...e,items:e.items.filter((e,a)=>a!==t.index)};default:return e}}let eb=({contact:e,onCancel:t,onQuotationCreated:a})=>{let l={customerName:e.name,contactNumber:e.phone,billingAddress:e.lastBillingAddress||e.lastAddress||"",shippingAddress:e.lastShippingAddress||e.shippingAddress||"",items:[{productId:"",quantity:1,price:0}]},[d,i]=(0,r.useReducer)(ep,l),[n,o]=(0,r.useState)([]),[c,u]=(0,r.useState)(!1),[m,x]=(0,r.useState)("");(0,r.useEffect)(()=>{(async()=>{let e=await fetch("/api/products");e.ok&&o(await e.json())})()},[]);let g=(e,t,a)=>{let s;"productId"===t&&(s=n.find(e=>e.id===a)),i({type:"UPDATE_ITEM",index:e,field:t,payload:a,product:s})},h=e=>i({type:"REMOVE_ITEM",index:e}),y=d.items.reduce((e,t)=>e+(t.quantity||0)*(t.price||0),0),b=async t=>{t.preventDefault(),u(!0),x("");try{let{customerName:t,contactNumber:s,billingAddress:r,shippingAddress:l,items:i}=d,n=await fetch("/api/quotations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contactId:e.id,customerName:t,contactNumber:s,billingAddress:r,shippingAddress:l,items:i.map(({name:e,...t})=>t).filter(e=>e.productId),subtotal:y,total:y,status:"DRAFT"})});if(!n.ok){let e=await n.json();throw Error(e.error||"Failed to create quotation")}let o=await n.json();a(o)}catch(e){x(e.message)}finally{u(!1)}};return(0,s.jsxs)("form",{onSubmit:b,className:"p-4",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[s.jsx("h3",{className:"font-bold text-lg text-gray-800 dark:text-gray-100",children:"New Quotation"}),s.jsx("button",{type:"button",onClick:t,className:"text-gray-500 dark:text-gray-300",children:s.jsx(p.Z,{size:20})})]}),m&&s.jsx("p",{className:"text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-300 p-2 rounded-md text-sm mb-4",children:m}),(0,s.jsxs)("div",{className:"space-y-3 text-sm",children:[s.jsx("input",{type:"text",value:d.customerName,onChange:e=>i({type:"UPDATE_FIELD",field:"customerName",payload:e.target.value}),placeholder:"Customer Name",className:"w-full border rounded-md p-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",required:!0}),s.jsx("input",{type:"text",value:d.contactNumber,onChange:e=>i({type:"UPDATE_FIELD",field:"contactNumber",payload:e.target.value}),placeholder:"Contact Number",className:"w-full border rounded-md p-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",required:!0}),s.jsx("textarea",{value:d.billingAddress,onChange:e=>i({type:"UPDATE_FIELD",field:"billingAddress",payload:e.target.value}),placeholder:"Billing Address",className:"w-full border rounded-md p-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",rows:2,required:!0}),s.jsx("textarea",{value:d.shippingAddress,onChange:e=>i({type:"UPDATE_FIELD",field:"shippingAddress",payload:e.target.value}),placeholder:"Shipping Address",className:"w-full border rounded-md p-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",rows:2,required:!0})]}),(0,s.jsxs)("div",{className:"mt-4",children:[s.jsx("h4",{className:"font-semibold mb-2 text-gray-800 dark:text-gray-100",children:"Products"}),d.items.map((e,t)=>(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,s.jsxs)("select",{value:e.productId??"",onChange:e=>g(t,"productId",e.target.value),className:"w-1/2 border rounded-md p-2 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",required:!0,children:[s.jsx("option",{value:"",children:"Select Product"}),n.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]}),s.jsx("input",{type:"number",value:e.quantity,onChange:e=>g(t,"quantity",parseInt(e.target.value,10)),min:"1",className:"w-1/4 border rounded-md p-2 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"}),(0,s.jsxs)("span",{className:"w-1/4 text-gray-700 dark:text-gray-300",children:["@ ₹",e.price?.toFixed(2)]}),s.jsx("button",{type:"button",onClick:()=>h(t),children:s.jsx(E.Z,{size:16,className:"text-red-500 hover:text-red-600"})})]},t)),(0,s.jsxs)("button",{type:"button",onClick:()=>i({type:"ADD_ITEM"}),className:"flex items-center text-sm text-blue-600 dark:text-blue-400 mt-2",children:[s.jsx(Y.Z,{size:16,className:"mr-1"})," Add Item"]})]}),(0,s.jsxs)("div",{className:"mt-4 text-right font-bold text-gray-800 dark:text-gray-100",children:["Subtotal: ₹",y.toFixed(2)]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2 mt-4",children:[s.jsx("button",{type:"button",onClick:t,className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:c,className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-md disabled:opacity-50 flex items-center justify-center",children:c?"Generating...":"Generate & Preview"})]})]})},ef=(0,f.Z)("Bell",[["path",{d:"M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9",key:"1qo2s2"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}]]);var ej=a(92977);let ek=({quotation:e,onCancel:t,onSuccess:a})=>{let[l,d]=(0,r.useState)((0,Q.WU)((0,ej.E)(new Date,3),"yyyy-MM-dd'T'HH:mm")),i=`Follow up with ${e.customerName} about Quotation #${e.id.substring(0,6)}.`,n=`Hi ${e.customerName}, this is a friendly follow-up regarding the quotation for ₹${e.total.toLocaleString("en-IN")} we sent you recently. Please let us know if you have any questions or are ready to proceed. Thank you!`,[o,c]=(0,r.useState)(i),[u,m]=(0,r.useState)(n),[x,g]=(0,r.useState)(!1),[y,p]=(0,r.useState)(""),b=async t=>{t.preventDefault(),g(!0),p("");try{let t=await fetch(`/api/contacts/${e.contactId}/reminders`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({remindAt:new Date(l).toISOString(),ownerMessage:o,customerMessage:u,quotationId:e.id})});if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to set reminder.")}a()}catch(e){p(e.message)}finally{g(!1)}};return(0,s.jsxs)("form",{onSubmit:b,className:"p-4 space-y-4",children:[y&&s.jsx("p",{className:"text-red-600 bg-red-50 p-2 rounded-md text-sm",children:y}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium",children:"Remind on"}),s.jsx("input",{type:"datetime-local",value:l,onChange:e=>d(e.target.value),className:"mt-1 w-full border rounded-md p-2 text-sm dark:bg-gray-700 dark:border-gray-600",required:!0})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium",children:"Internal Note (for you)"}),s.jsx("textarea",{value:o,onChange:e=>c(e.target.value),rows:2,className:"mt-1 w-full border rounded-md p-2 text-sm dark:bg-gray-700 dark:border-gray-600",required:!0})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium",children:"Automated Message (to customer)"}),s.jsx("textarea",{value:u,onChange:e=>m(e.target.value),rows:4,className:"mt-1 w-full border rounded-md p-2 text-sm dark:bg-gray-700 dark:border-gray-600"}),s.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Leave blank to not send an automated message."})]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2 pt-2",children:[s.jsx("button",{type:"button",onClick:t,className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md",children:"Cancel"}),(0,s.jsxs)("button",{type:"submit",disabled:x,className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-md disabled:opacity-50 flex items-center",children:[x?s.jsx(h.Z,{className:"animate-spin mr-2"}):s.jsx(ef,{className:"mr-2",size:16}),"Set Reminder"]})]})]})};function eN(e,t){switch(t.type){case"UPDATE_FIELD":return{...e,[t.field]:t.payload};case"ADD_ITEM":return{...e,items:[...e.items,{id:Date.now(),productName:"",quantity:"1",price:"0"}]};case"REMOVE_ITEM":return{...e,items:e.items.filter(e=>e.id!==t.id)};case"UPDATE_ITEM":return{...e,items:e.items.map(e=>e.id===t.id?{...e,[t.field]:t.payload}:e)};default:return e}}let ev=({contact:e,onCancel:t,onOrderCreated:a,suggestedAddress:l})=>{let d={customerName:e.name,billingAddress:e.lastBillingAddress||e.lastAddress||"",shippingAddress:e.lastShippingAddress||e.shippingAddress||"",items:[{id:Date.now(),productName:"",quantity:"1",price:"0"}],discountPercentage:"0",deliveryCharges:"0"},[i,n]=(0,r.useReducer)(eN,d),[o,c]=(0,r.useState)([]),[u,m]=(0,r.useState)(!1),[x,g]=(0,r.useState)("");(0,r.useEffect)(()=>{(async()=>{let e=await fetch("/api/products");e.ok&&c(await e.json())})()},[]),(0,r.useEffect)(()=>{l&&n({type:"UPDATE_FIELD",field:"shippingAddress",payload:l})},[l]);let y=(e,t)=>{let a=o.find(e=>e.name.toLowerCase()===t.toLowerCase());a?(n({type:"UPDATE_ITEM",id:e,field:"productName",payload:a.name}),n({type:"UPDATE_ITEM",id:e,field:"productId",payload:a.id}),n({type:"UPDATE_ITEM",id:e,field:"price",payload:a.price.toString()})):(n({type:"UPDATE_ITEM",id:e,field:"productName",payload:t}),n({type:"UPDATE_ITEM",id:e,field:"productId",payload:void 0}))},p=i.items.reduce((e,t)=>e+(parseFloat(t.quantity)||0)*(parseFloat(t.price)||0),0),b=p*(parseFloat(i.discountPercentage)||0)/100,f=p-b+(parseFloat(i.deliveryCharges)||0),j=async t=>{t.preventDefault(),m(!0),g("");let s=i.items.filter(e=>e.productName.trim()&&parseFloat(e.price)>=0).map(e=>({...e,price:parseFloat(e.price)}));if(0===s.length){g("Please add at least one valid item."),m(!1);return}try{let t=await fetch("/api/orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contactId:e.id,customerName:i.customerName,contactNumber:e.phone,billingAddress:i.billingAddress,shippingAddress:i.shippingAddress,items:s,subtotal:p,total:f,discountPercentage:parseFloat(i.discountPercentage)||0,deliveryCharges:parseFloat(i.deliveryCharges)||0})});if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to create order")}let r=await t.json();a(r)}catch(e){g(e.message)}finally{m(!1)}};return(0,s.jsxs)("form",{onSubmit:j,className:"p-4",children:[s.jsx("h3",{className:"font-bold text-lg text-gray-800 dark:text-gray-100 mb-4",children:"New Order"}),x&&s.jsx("p",{className:"text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-300 p-2 rounded-md text-sm mb-4",children:x}),(0,s.jsxs)("div",{className:"space-y-3 text-sm",children:[s.jsx("input",{type:"text",value:i.customerName,onChange:e=>n({type:"UPDATE_FIELD",field:"customerName",payload:e.target.value}),placeholder:"Customer Name",className:"w-full border rounded-md p-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",required:!0}),s.jsx("textarea",{value:i.billingAddress,onChange:e=>n({type:"UPDATE_FIELD",field:"billingAddress",payload:e.target.value}),placeholder:"Billing Address",className:"w-full border rounded-md p-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",rows:2,required:!0}),s.jsx("textarea",{value:i.shippingAddress,onChange:e=>n({type:"UPDATE_FIELD",field:"shippingAddress",payload:e.target.value}),placeholder:"Shipping Address",className:"w-full border rounded-md p-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",rows:2,required:!0})]}),(0,s.jsxs)("div",{className:"mt-4",children:[s.jsx("h4",{className:"font-semibold mb-2 text-gray-800 dark:text-gray-100",children:"Items"}),s.jsx("div",{className:"space-y-2",children:i.items.map(e=>(0,s.jsxs)("div",{className:"grid grid-cols-[1fr,80px,80px,100px,auto] gap-2 items-center",children:[s.jsx("input",{list:"product-list",type:"text",value:e.productName,onChange:t=>y(e.id,t.target.value),placeholder:"Product Name",className:"w-full border rounded-md p-2 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",required:!0}),s.jsx("input",{type:"text",value:e.quantity,onChange:t=>n({type:"UPDATE_ITEM",id:e.id,field:"quantity",payload:t.target.value}),placeholder:"Qty",className:"w-full border rounded-md p-2 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",required:!0}),s.jsx("input",{type:"number",value:e.price,onChange:t=>n({type:"UPDATE_ITEM",id:e.id,field:"price",payload:t.target.value}),placeholder:"Price",step:"0.01",className:"w-full border rounded-md p-2 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",required:!0}),(0,s.jsxs)("span",{className:"text-sm font-semibold text-right pr-2 dark:text-gray-200",children:["₹",((parseFloat(e.quantity)||0)*(parseFloat(e.price)||0)).toFixed(2)]}),s.jsx("button",{type:"button",onClick:()=>n({type:"REMOVE_ITEM",id:e.id}),children:s.jsx(E.Z,{size:16,className:"text-red-500 hover:text-red-600"})})]},e.id))}),s.jsx("datalist",{id:"product-list",children:o.map(e=>s.jsx("option",{value:e.name},e.id))}),(0,s.jsxs)("button",{type:"button",onClick:()=>n({type:"ADD_ITEM"}),className:"flex items-center text-sm text-blue-600 dark:text-blue-400 mt-2",children:[s.jsx(Y.Z,{size:16,className:"mr-1"})," Add Item"]})]}),(0,s.jsxs)("div",{className:"mt-6 space-y-3",children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-xs",children:"Discount (%)"}),s.jsx("input",{type:"number",value:i.discountPercentage,onChange:e=>n({type:"UPDATE_FIELD",field:"discountPercentage",payload:e.target.value}),className:"w-full border rounded-md p-2 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-xs",children:"Delivery (₹)"}),s.jsx("input",{type:"number",value:i.deliveryCharges,onChange:e=>n({type:"UPDATE_FIELD",field:"deliveryCharges",payload:e.target.value}),className:"w-full border rounded-md p-2 text-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"})]})]}),(0,s.jsxs)("div",{className:"text-right font-bold text-lg text-gray-800 dark:text-gray-100",children:["Total: ₹",f.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2 mt-4",children:[s.jsx("button",{type:"button",onClick:t,className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:u,className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-md disabled:opacity-50 flex items-center justify-center",children:u?s.jsx(h.Z,{className:"animate-spin"}):"Create & View Bill"})]})]})};var ew=a(24422);let eD={hidden:{},visible:{transition:{staggerChildren:.07}}},eC={hidden:{y:15,opacity:0},visible:{y:0,opacity:1}},eE=({contactId:e,onNewOrder:t,onManagePayments:a})=>{let[l,d]=(0,r.useState)([]),[i,n]=(0,r.useState)(!0),[o,c]=(0,r.useState)(null),[u,x]=(0,r.useState)(null),g=async()=>{n(!0);try{let t=await fetch(`/api/orders?contactId=${e}`);t.ok&&d(await t.json())}catch(e){console.error("Failed to fetch orders:",e)}finally{n(!1)}};(0,r.useEffect)(()=>{e&&g()},[e]);let y=async()=>{if(o){x(o.id);try{if(!(await fetch(`/api/orders/${o.id}`,{method:"DELETE"})).ok)throw Error("Failed to delete order.");d(e=>e.filter(e=>e.id!==o.id)),c(null)}catch(e){console.error(e)}finally{x(null)}}};return(0,s.jsxs)("div",{className:"p-4",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[s.jsx("h3",{className:"font-bold text-lg",children:"Order History"}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[s.jsx("button",{onClick:g,disabled:i,className:"p-2 text-gray-500 hover:bg-gray-100 rounded-full disabled:opacity-50",children:s.jsx(ei,{size:16,className:i?"animate-spin":""})}),(0,s.jsxs)("button",{onClick:t,className:"flex items-center bg-blue-600 text-white text-sm px-3 py-2 rounded-md hover:bg-blue-700",children:[s.jsx(Y.Z,{size:16,className:"mr-1"})," New"]})]})]}),i?s.jsx("p",{className:"text-sm text-gray-500 text-center py-8",children:"Loading..."}):0===l.length?s.jsx("p",{className:"text-sm text-gray-500 text-center py-8",children:"No orders found for this contact."}):s.jsx(m.E.ul,{className:"space-y-3",variants:eD,initial:"hidden",animate:"visible",children:l.map(e=>(0,s.jsxs)(m.E.li,{variants:eC,className:"p-3 border dark:border-gray-700 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[(0,s.jsxs)("div",{className:"flex justify-between items-start",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("p",{className:"font-semibold text-sm",children:["Order #",e.id.substring(0,6)]}),s.jsx("p",{className:"text-xs text-gray-500",children:(0,Q.WU)(new Date(e.createdAt),"PP")})]}),s.jsx(ew.Z,{status:e.status})]}),(0,s.jsxs)("div",{className:"flex justify-between items-end mt-2",children:[(0,s.jsxs)("p",{className:"text-lg font-bold",children:["₹",e.total.toLocaleString("en-IN")]}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsxs)("button",{onClick:()=>a(e),className:"flex items-center text-blue-600 text-sm font-semibold hover:underline",children:[s.jsx(K.Z,{size:14,className:"mr-1"})," Manage Payments"]}),s.jsx("button",{onClick:()=>c(e),className:"p-1.5 text-gray-400 hover:bg-red-100 hover:text-red-600 rounded-full dark:hover:bg-red-900/30",title:"Delete Order",disabled:!!u,children:u===e.id?s.jsx(h.Z,{className:"animate-spin",size:16}):s.jsx(E.Z,{size:16})})]})]})]},e.id))}),o&&(0,s.jsxs)(I.Z,{isOpen:!!o,onClose:()=>c(null),title:"Confirm Deletion",children:[(0,s.jsxs)("p",{children:["Are you sure you want to delete Order ",(0,s.jsxs)("strong",{children:["#",o.id.substring(0,6)]}),"? This action cannot be undone."]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-2 mt-4",children:[s.jsx("button",{onClick:()=>c(null),className:"px-4 py-2 border dark:border-gray-600 rounded-md",children:"Cancel"}),s.jsx("button",{onClick:y,className:"px-4 py-2 bg-red-600 text-white rounded-md",disabled:!!u,children:u?"Deleting...":"Delete"})]})]})]})};var eS=a(41291);/**
 * @license lucide-react v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let eA=(0,f.Z)("CircleCheckBig",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),eP=({order:e,onDone:t})=>{let[a,l]=(0,r.useState)(!1),[d,i]=(0,r.useState)(null),[n,o]=(0,r.useState)(!1),c=async()=>{l(!0),i(null);try{let t=await fetch(`/api/orders/${e.id}/send-bill`,{method:"POST"}),a=await t.json();if(!t.ok)throw Error(a.error||"Failed to send bill.");o(!0)}catch(e){i(e.message)}finally{l(!1)}},u=e.items.reduce((e,t)=>e+t.price*Number(t.quantity),0),m=u*(e.discountPercentage||0)/100;return(0,s.jsxs)("div",{className:"p-4",children:[s.jsx("h3",{className:"font-bold text-lg mb-4 text-center",children:"Order Created!"}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-4 text-xs",children:[(0,s.jsxs)("div",{children:[s.jsx("h4",{className:"font-semibold text-gray-500 dark:text-gray-400",children:"Billing To"}),s.jsx("p",{className:"whitespace-pre-wrap text-gray-700 dark:text-gray-300",children:e.billingAddress})]}),(0,s.jsxs)("div",{children:[s.jsx("h4",{className:"font-semibold text-gray-500 dark:text-gray-400",children:"Shipping To"}),s.jsx("p",{className:"whitespace-pre-wrap text-gray-700 dark:text-gray-300",children:e.shippingAddress})]})]}),(0,s.jsxs)("div",{className:"p-4 border dark:border-gray-700 rounded-lg bg-gray-50/50 dark:bg-gray-900/50 space-y-3 text-sm",children:[(0,s.jsxs)("table",{className:"w-full text-left",children:[s.jsx("thead",{className:"text-xs text-gray-500",children:(0,s.jsxs)("tr",{children:[s.jsx("th",{className:"pb-1 font-medium",children:"Item"}),s.jsx("th",{className:"pb-1 font-medium text-right",children:"Price"})]})}),s.jsx("tbody",{children:e.items.map(e=>(0,s.jsxs)("tr",{className:"border-t dark:border-gray-600",children:[(0,s.jsxs)("td",{className:"py-2",children:[e.productName," ",(0,s.jsxs)("span",{className:"text-gray-500",children:["x ",e.quantity]})]}),(0,s.jsxs)("td",{className:"py-2 text-right",children:["₹",e.price.toFixed(2)]})]},e.id))})]}),(0,s.jsxs)("div",{className:"space-y-1 pt-2 border-t dark:border-gray-600",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Subtotal"}),(0,s.jsxs)("span",{children:["₹",u.toFixed(2)]})]}),e.discountPercentage&&e.discountPercentage>0&&(0,s.jsxs)("div",{className:"flex justify-between text-red-600 dark:text-red-400",children:[(0,s.jsxs)("span",{children:["Discount (",e.discountPercentage,"%)"]}),(0,s.jsxs)("span",{children:["- ₹",m.toFixed(2)]})]}),e.deliveryCharges&&e.deliveryCharges>0&&(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Delivery Charges"}),(0,s.jsxs)("span",{children:["+ ₹",e.deliveryCharges.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between font-bold text-base pt-1 border-t dark:border-gray-600 mt-1",children:[s.jsx("span",{children:"Total"}),(0,s.jsxs)("span",{children:["₹",e.total.toFixed(2)]})]})]})]}),(0,s.jsxs)("div",{className:"mt-4",children:[d&&(0,s.jsxs)("div",{className:"p-2 mb-2 bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-300 rounded-md text-sm flex items-center",children:[s.jsx(eS.Z,{size:16,className:"mr-2"}),d]}),n?(0,s.jsxs)("div",{className:"p-3 text-center bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-300 rounded-md",children:[s.jsx(eA,{className:"inline-block mr-2"})," Bill sent successfully!"]}):s.jsx("button",{onClick:c,className:"w-full bg-green-600 text-white rounded-md px-4 py-2.5 text-sm font-semibold flex items-center justify-center",disabled:a,children:a?s.jsx(h.Z,{size:18,className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(v.Z,{size:16,className:"mr-2"}),"Send Bill as Image"]})}),s.jsx("button",{onClick:t,className:"w-full mt-2 text-sm text-gray-600 dark:text-gray-400 py-2 hover:underline",children:"Done"})]})]})},eT=({order:e,onBack:t,onFinalized:a,socket:l})=>{let[d,i]=(0,r.useState)(e),[n,o]=(0,r.useState)(d.payments||[]),[c,u]=(0,r.useState)(null),[m,x]=(0,r.useState)(""),[g,y]=(0,r.useState)(!1),[p,b]=(0,r.useState)({amount:"",method:"Cash",notes:""}),[f,j]=(0,r.useState)(!1),k=n.reduce((e,t)=>e+t.amount,0),N=d.total-k;(0,r.useEffect)(()=>{if((async()=>{if(!d.id)return;let e=await fetch(`/api/orders/${d.id}`);if(e.ok){let t=await e.json();i(t),o(t.payments||[])}})(),l){let e=e=>{e.id===d.id&&(i(e),o(e.payments||[]))};return l.on("order_update",e),()=>{l.off("order_update",e)}}},[d.id,l]);let w=async e=>{u(e),x("");try{let t=await fetch(`/api/orders/${d.id}/send-payment-action`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:e})});if(!t.ok){let e=await t.json();throw Error(e.error||"Action failed.")}}catch(e){x(e.message)}finally{u(null)}},D=async e=>{e.preventDefault(),j(!0),x("");try{let e=await fetch(`/api/orders/${d.id}/payments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...p,amount:parseFloat(p.amount)})}),t=await e.json();if(!e.ok)throw Error(t.error||"Failed to add payment.");i(t),o(t.payments||[]),y(!1),b({amount:"",method:"Cash",notes:""})}catch(e){x(e.message)}finally{j(!1)}};return(0,s.jsxs)("div",{className:"p-4 space-y-4",children:[m&&s.jsx("p",{className:"text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-300 p-2 rounded-md text-sm mb-2",children:m}),(0,s.jsxs)("div",{className:"p-3 border dark:border-gray-700 rounded-lg",children:[s.jsx("h4",{className:"font-semibold text-sm mb-2 text-gray-800 dark:text-gray-100",children:"Payment Status"}),(0,s.jsxs)("div",{className:"text-sm space-y-1 text-gray-700 dark:text-gray-300",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Total Bill:"})," ",(0,s.jsxs)("span",{className:"font-bold text-gray-800 dark:text-gray-100",children:["₹",d.total.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Total Paid:"})," ",(0,s.jsxs)("span",{className:"font-bold text-green-600 dark:text-green-400",children:["₹",k.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[s.jsx("span",{children:"Amount Due:"})," ",(0,s.jsxs)("span",{className:"font-bold text-red-600 dark:text-red-400",children:["₹",N.toFixed(2)]})]})]}),s.jsx("div",{className:"mt-2 text-xs text-gray-500 dark:text-gray-400 max-h-24 overflow-y-auto",children:n.map(e=>(0,s.jsxs)("div",{className:"flex justify-between items-center border-t dark:border-gray-600 py-1",children:[(0,s.jsxs)("span",{children:[e.method," (",(0,Q.WU)(new Date(e.createdAt),"PP"),")"]}),(0,s.jsxs)("span",{children:["₹",e.amount.toFixed(2)]})]},e.id))}),(0,s.jsxs)("button",{onClick:()=>y(!0),className:"w-full mt-3 flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 py-2 rounded-md",children:[s.jsx(Y.Z,{size:16,className:"mr-1"})," Record Manual Payment"]})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[s.jsx("h4",{className:"font-semibold text-sm pt-2 text-gray-800 dark:text-gray-100",children:"Payment Actions"}),s.jsx("button",{onClick:()=>w("send_bill_image"),disabled:!!c,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_bill_image"===c?s.jsx(h.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(v.Z,{size:16,className:"mr-2"})," Send Bill Image"]})}),s.jsx("button",{onClick:()=>w("send_razorpay"),disabled:!!c||N<=0,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_razorpay"===c?s.jsx(h.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(ex,{size:16,className:"mr-2"})," Send Payment Link"]})}),s.jsx("button",{onClick:()=>w("send_bank_details"),disabled:!!c||N<=0,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_bank_details"===c?s.jsx(h.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(eg,{size:16,className:"mr-2"})," Send Bank Details"]})}),s.jsx("button",{onClick:()=>w("send_qr_code"),disabled:!!c||N<=0,className:"w-full flex items-center justify-center text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300 p-3 rounded-md disabled:opacity-50 disabled:cursor-not-allowed",children:"send_qr_code"===c?s.jsx(h.Z,{className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(eh,{size:16,className:"mr-2"})," Send UPI QR Code"]})})]}),s.jsx(I.Z,{isOpen:g,onClose:()=>y(!1),title:"Record Manual Payment",children:(0,s.jsxs)("form",{onSubmit:D,className:"space-y-3",children:[(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Amount"}),s.jsx("input",{type:"number",placeholder:"Amount paid",value:p.amount,onChange:e=>b(t=>({...t,amount:e.target.value})),required:!0,className:"w-full border rounded-md p-2 text-sm mt-1 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Method"}),(0,s.jsxs)("select",{value:p.method,onChange:e=>b(t=>({...t,method:e.target.value})),className:"w-full border rounded-md p-2 text-sm mt-1 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",children:[s.jsx("option",{children:"Cash"})," ",s.jsx("option",{children:"Bank Transfer"})," ",s.jsx("option",{children:"UPI"})," ",s.jsx("option",{children:"Other"})]})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Notes (Optional)"}),s.jsx("input",{type:"text",placeholder:"e.g., Transaction ID",value:p.notes,onChange:e=>b(t=>({...t,notes:e.target.value})),className:"w-full border rounded-md p-2 text-sm mt-1 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"})]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2 pt-2",children:[s.jsx("button",{type:"button",onClick:()=>y(!1),className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:f,className:"px-4 py-2 text-sm bg-green-600 text-white rounded-md disabled:opacity-50",children:f?"Adding...":"Add Payment"})]})]})})]})};var eI=a(31215);let e_=({name:e,color:t,onRemove:a})=>(0,s.jsxs)("div",{className:"flex items-center text-xs font-medium rounded-full px-2.5 py-1",style:{backgroundColor:`${t}20`,color:t},children:[s.jsx("span",{children:e}),a&&s.jsx("button",{type:"button",onClick:a,className:"ml-1.5 -mr-1 rounded-full hover:bg-black/10 p-0.5 transition-colors","aria-label":`Remove tag ${e}`,children:s.jsx(p.Z,{size:12,style:{color:t}})})]}),eZ=["#3b82f6","#22c55e","#eab308","#f97316","#ef4444","#8b5cf6","#d946ef","#64748b"],eF=({tags:e,onTagsChange:t})=>{let[a,l]=(0,r.useState)([]),[d,i]=(0,r.useState)(!1),[n,o]=(0,r.useState)(""),[c,u]=(0,r.useState)(eZ[0]),[m,x]=(0,r.useState)(""),g=async()=>{let e=await fetch("/api/tags");e.ok&&l(await e.json())};(0,r.useEffect)(()=>{g()},[]);let h=s=>{if(!s)return;let r=a.find(e=>e.id===s);r&&!e.some(e=>e.id===s)&&t([...e,r])},y=a=>{t(e.filter(e=>e.id!==a))},p=async()=>{if(!n.trim()){x("Tag name cannot be empty.");return}x("");try{let a=await fetch("/api/tags",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n,color:c})}),s=await a.json();if(!a.ok)throw Error(s.error||"Failed to create tag.");await g(),t([...e,s]),o(""),u(eZ[0]),i(!1)}catch(e){x(e.message)}},b=a.filter(t=>!e.some(e=>e.id===t.id));return(0,s.jsxs)("div",{className:"p-3 border dark:border-gray-700 rounded-lg",children:[s.jsx("h4",{className:"font-semibold text-sm mb-2 text-gray-700 dark:text-gray-300",children:"Tags"}),m&&s.jsx("p",{className:"text-xs text-red-500 mb-2",children:m}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-2 items-center",children:[e.map(e=>s.jsx(e_,{name:e.name,color:e.color,onRemove:()=>y(e.id)},e.id)),!d&&(0,s.jsxs)("button",{type:"button",onClick:()=>i(!0),className:"flex items-center text-xs text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/50",children:[s.jsx(Y.Z,{size:12,className:"mr-1"})," Add Tag"]})]}),d&&(0,s.jsxs)("div",{className:"mt-3 space-y-2 animate-fade-in-up",style:{animationDuration:"0.3s"},children:[b.length>0&&(0,s.jsxs)("select",{onChange:e=>{h(e.target.value),e.target.value=""},className:"w-full border rounded-md p-1.5 text-sm dark:bg-gray-700 dark:border-gray-600",defaultValue:"",children:[s.jsx("option",{value:"",disabled:!0,children:"Add existing tag..."}),b.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]}),s.jsx("p",{className:"text-xs text-center text-gray-500",children:"Or"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[s.jsx("input",{value:n,onChange:e=>{o(e.target.value),x("")},placeholder:"Create new tag...",className:"flex-1 border rounded-md p-1.5 text-sm dark:bg-gray-700 dark:border-gray-600"}),s.jsx("div",{className:"flex gap-1 bg-gray-100 dark:bg-gray-900 p-1 rounded-md",children:eZ.map(e=>s.jsx("button",{type:"button",onClick:()=>u(e),style:{backgroundColor:e},className:`w-5 h-5 rounded-full transition-transform hover:scale-110 ${c===e?"ring-2 ring-offset-1 dark:ring-offset-gray-800 ring-blue-500":""}`},e))})]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2 text-xs",children:[s.jsx("button",{type:"button",onClick:()=>{i(!1),x("")},className:"px-3 py-1 border rounded-md dark:border-gray-600",children:"Cancel"}),s.jsx("button",{type:"button",onClick:p,className:"bg-blue-600 text-white px-3 py-1 rounded-md",children:"Create & Add"})]})]})]})},eM={hidden:{},visible:{transition:{staggerChildren:.07}}},eq={hidden:{y:15,opacity:0},visible:{y:0,opacity:1}},eO=({contact:e,onPromoted:t})=>{let[a,l]=(0,r.useState)(null),[d,i]=(0,r.useState)(!0),[n,o]=(0,r.useState)(!1),[c,x]=(0,r.useState)({name:"",shippingAddress:"",bankDetails:"",tags:[]}),[g,y]=(0,r.useState)(!1),[p,b]=(0,r.useState)(!1),[f,j]=(0,r.useState)(""),k=async()=>{i(!0),j("");try{let t=await fetch(`/api/contacts/${e.id}/details`);if(!t.ok)throw Error("Failed to load details.");let a=await t.json();l(a),x({name:a.name||"",shippingAddress:a.shippingAddress||"",bankDetails:a.bankDetails||"",tags:a.tags||[]}),o(!a.isMasterCustomer)}catch(e){j(e.message)}finally{i(!1)}};(0,r.useEffect)(()=>{e.id&&k()},[e.id]);let N=async t=>{t.preventDefault(),y(!0),j("");try{let t=await fetch(`/api/contacts/${e.id}/promote-to-master`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:c.name,shippingAddress:c.shippingAddress,bankDetails:c.bankDetails,tagIds:c.tags.map(e=>e.id)})});if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to save customer details.")}await k(),o(!1)}catch(e){j(e.message)}finally{y(!1)}},v=async()=>{if(window.confirm("Are you sure you want to remove this customer from master status?")){b(!0),j("");try{if(!(await fetch(`/api/contacts/${e.id}/demote`,{method:"POST"})).ok)throw Error("Failed to demote customer.");t()}catch(e){j(e.message)}finally{b(!1)}}};return d?(0,s.jsxs)("div",{className:"p-4 text-center",children:[s.jsx(h.Z,{className:"animate-spin inline-block"}),s.jsx("p",{className:"text-sm text-gray-500",children:"Loading Details..."})]}):f&&!a?s.jsx("p",{className:"p-4 text-red-600 bg-red-50 text-center",children:f}):n?(0,s.jsxs)(m.E.form,{variants:eM,initial:"hidden",animate:"visible",onSubmit:N,className:"p-4 space-y-4",children:[(0,s.jsxs)(m.E.h3,{variants:eq,className:"font-semibold flex items-center text-yellow-500",children:[s.jsx($,{size:18,className:"mr-2 fill-current"}),a?.isMasterCustomer?"Edit Master Details":"Promote to Master Customer"]}),f&&s.jsx("p",{className:"text-red-600 bg-red-50 p-2 rounded-md text-sm",children:f}),(0,s.jsxs)(m.E.div,{variants:eq,children:[(0,s.jsxs)("label",{className:"text-sm font-medium",children:["Customer Name ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx("input",{type:"text",value:c.name,onChange:e=>x(t=>({...t,name:e.target.value})),className:"mt-1 w-full border rounded-md p-2 text-sm dark:bg-[var(--input-background)] dark:border-gray-600",required:!0})]}),(0,s.jsxs)(m.E.div,{variants:eq,children:[(0,s.jsxs)("label",{className:"text-sm font-medium",children:["Shipping Address ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx("textarea",{value:c.shippingAddress,onChange:e=>x(t=>({...t,shippingAddress:e.target.value})),rows:3,className:"mt-1 w-full border rounded-md p-2 text-sm dark:bg-[var(--input-background)] dark:border-gray-600",placeholder:"Enter full shipping address...",required:!0})]}),(0,s.jsxs)(m.E.div,{variants:eq,children:[s.jsx("label",{className:"text-sm font-medium",children:"Bank Account Details"}),s.jsx("textarea",{value:c.bankDetails,onChange:e=>x(t=>({...t,bankDetails:e.target.value})),rows:3,className:"mt-1 w-full border rounded-md p-2 text-sm dark:bg-[var(--input-background)] dark:border-gray-600",placeholder:"Bank Name, Account Number, IFSC Code..."})]}),s.jsx(m.E.div,{variants:eq,children:s.jsx(eF,{tags:c.tags,onTagsChange:e=>x(t=>({...t,tags:e}))})}),(0,s.jsxs)(m.E.div,{variants:eq,className:"flex justify-end gap-2 pt-2",children:[a?.isMasterCustomer&&s.jsx("button",{type:"button",onClick:()=>{a&&x({name:a.name||"",shippingAddress:a.shippingAddress||"",bankDetails:a.bankDetails||"",tags:a.tags||[]}),o(!1)},className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md",children:"Cancel"}),(0,s.jsxs)("button",{type:"submit",disabled:g,className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-md disabled:opacity-50 flex items-center",children:[g?s.jsx(h.Z,{className:"animate-spin mr-2"}):s.jsx(eI.Z,{className:"mr-2"}),g?"Saving...":"Save Details"]})]})]}):(0,s.jsxs)(m.E.div,{variants:eM,initial:"hidden",animate:"visible",className:"p-4 space-y-4",children:[(0,s.jsxs)(m.E.div,{variants:eM,className:"space-y-3",children:[(0,s.jsxs)(m.E.div,{variants:eq,children:[s.jsx("label",{className:"text-xs font-semibold text-gray-500 dark:text-gray-400",children:"Tags"}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-2 items-center mt-1",children:[a?.tags?.map(e=>s.jsx(e_,{name:e.name,color:e.color},e.id)),a?.tags?.length===0&&s.jsx("p",{className:"text-sm text-gray-400 dark:text-gray-500 italic",children:"No tags"})]})]}),(0,s.jsxs)(m.E.div,{variants:eq,children:[s.jsx("label",{className:"text-xs font-semibold text-gray-500 dark:text-gray-400",children:"Shipping Address"}),s.jsx("p",{className:"text-sm whitespace-pre-wrap p-2 bg-gray-50 dark:bg-[var(--input-background)] rounded-md mt-1",children:a?.shippingAddress||s.jsx("span",{className:"italic text-gray-400 dark:text-gray-500",children:"Not provided"})})]}),(0,s.jsxs)(m.E.div,{variants:eq,children:[s.jsx("label",{className:"text-xs font-semibold text-gray-500 dark:text-gray-400",children:"Bank Details"}),s.jsx("p",{className:"text-sm whitespace-pre-wrap p-2 bg-gray-50 dark:bg-[var(--input-background)] rounded-md mt-1",children:a?.bankDetails||s.jsx("span",{className:"italic text-gray-400 dark:text-gray-500",children:"Not provided"})})]})]}),(0,s.jsxs)(m.E.div,{variants:eq,className:"flex justify-between items-center pt-2",children:[(0,s.jsxs)("button",{type:"button",onClick:v,disabled:p,className:"flex items-center text-xs text-red-500 hover:underline disabled:opacity-50",children:[p?s.jsx(h.Z,{size:14,className:"animate-spin mr-1"}):s.jsx(u.Z,{name:"UserX",size:14,className:"mr-1"}),"Demote Customer"]}),(0,s.jsxs)("button",{onClick:()=>o(!0),className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-md flex items-center",children:[s.jsx(ed.Z,{size:16,className:"mr-2"})," Edit Details"]})]})]})};function ez({initialImages:e=[],onChange:t,label:a="Product Images"}){let[l,d]=(0,r.useState)(e),[i,n]=(0,r.useState)(!1),o=async e=>{if(!e.target.files||0===e.target.files.length)return;n(!0);let a=[...l],s=e.target.files;for(let e=0;e<s.length;e++){let t=s[e],r=new FormData;r.append("image",t);try{let e=await fetch("https://api.imgbb.com/1/upload?key=ce388deb1931d0d58b9e876d99c2b152",{method:"POST",body:r}),t=await e.json();e.ok&&t.data&&t.data.url?a.push(t.data.url):console.error("ImgBB upload failed:",t.error?.message||"Unknown error")}catch(e){console.error("ImgBB upload error:",e)}}d(a),t(a),n(!1)},c=e=>{let a=l.filter(t=>t!==e);d(a),t(a)};return(0,s.jsxs)("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:a}),s.jsx("input",{type:"file",accept:"image/jpeg, image/png",multiple:!0,onChange:o,disabled:i,className:"mt-1 block w-full text-sm text-gray-700 dark:text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-blue-900/50 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 dark:hover:file:bg-blue-900"}),i&&s.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-2",children:"Uploading..."}),l.length>0&&s.jsx("div",{className:"mt-3 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2",children:l.map((e,t)=>(0,s.jsxs)("div",{className:"relative",children:[s.jsx("img",{src:e,alt:`preview-${t}`,className:"h-24 w-full object-cover rounded-md border dark:border-gray-600"}),s.jsx("button",{type:"button",onClick:()=>c(e),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 text-xs leading-none",children:"✕"})]},t))})]})}function e$({onSuccess:e,onCancel:t}){let[a,l]=(0,r.useState)(""),[d,i]=(0,r.useState)(""),[n,o]=(0,r.useState)(""),[c,u]=(0,r.useState)(""),[m,x]=(0,r.useState)("0"),[g,h]=(0,r.useState)(!0),[y,p]=(0,r.useState)("HYBRID"),[b,f]=(0,r.useState)(!1),[j,k]=(0,r.useState)(""),[N,v]=(0,r.useState)([]),w=async t=>{t.preventDefault(),k(""),f(!0);try{let t=await fetch("/api/products",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a,price:d,description:n,category:c,inStock:g,stockQuantity:m,images:N,workflow:y})});if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(e.error||"Failed to add product")}await t.json(),e()}catch(e){console.error("AddProductForm error:",e),k(e.message||"Something went wrong")}finally{f(!1)}};return(0,s.jsxs)("form",{onSubmit:w,className:"bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg p-4 shadow-md",children:[s.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100",children:"Add New Product"}),j&&s.jsx("p",{className:"text-red-600 text-sm mb-3",children:j}),(0,s.jsxs)("div",{className:"mb-3",children:[(0,s.jsxs)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:["Product Usage / Workflow",s.jsx("span",{className:"text-red-500",children:"*"})]}),(0,s.jsxs)("select",{required:!0,value:y,onChange:e=>p(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[s.jsx("option",{value:"QUOTATION_FOCUSED",children:"Quotation Specific"}),s.jsx("option",{value:"ORDER_FOCUSED",children:"Order Specific"}),s.jsx("option",{value:"HYBRID",children:"Hybrid (for both)"})]})]}),(0,s.jsxs)("div",{className:"mb-3",children:[(0,s.jsxs)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:["Name",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx("input",{type:"text",required:!0,value:a,onChange:e=>l(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-3",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:["Price (₹)",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx("input",{type:"number",required:!0,value:d,onChange:e=>i(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Stock Quantity"}),s.jsx("input",{type:"number",value:m,onChange:e=>x(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),(0,s.jsxs)("div",{className:"mb-3",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description"}),s.jsx("textarea",{value:n,onChange:e=>o(e.target.value),rows:3,className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),s.jsx("div",{className:"mb-3",children:s.jsx(ez,{onChange:v})}),(0,s.jsxs)("div",{className:"mb-3",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Category"}),s.jsx("input",{type:"text",value:c,onChange:e=>u(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,s.jsxs)("div",{className:"mb-4 flex items-center",children:[s.jsx("input",{type:"checkbox",checked:g,onChange:e=>h(e.target.checked),className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),s.jsx("label",{className:"ml-2 block text-sm text-gray-700 dark:text-gray-300",children:"In Stock"})]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-2",children:[s.jsx("button",{type:"button",onClick:t,className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:b,className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50",children:b?"Adding...":"Add Product"})]})]})}function eL({product:e,onSuccess:t,onCancel:a}){let[l,d]=(0,r.useState)(e.name),[i,n]=(0,r.useState)(e.price.toString()),[o,c]=(0,r.useState)(e.description||""),[u,m]=(0,r.useState)(e.category||""),[x,g]=(0,r.useState)((e.stockQuantity||0).toString()),[h,y]=(0,r.useState)(e.inStock??!0),[p,b]=(0,r.useState)(e.workflow||"HYBRID"),[f,j]=(0,r.useState)(!1),[k,N]=(0,r.useState)(""),[v,w]=(0,r.useState)(e.images||[]),[D,C]=(0,r.useState)([]),[E,S]=(0,r.useState)([]),A=e=>{w(t=>t.filter(t=>t.id!==e)),C(t=>[...t,e])},P=async a=>{a.preventDefault(),N(""),j(!0);try{let a=await fetch(`/api/products/${e.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:l,price:i,description:o,category:u,inStock:h,stockQuantity:x,workflow:p,imagesToAdd:E,imagesToDelete:D})});if(!a.ok){let e=await a.json().catch(()=>({}));throw Error(e.error||"Failed to update product")}await a.json(),t()}catch(e){console.error("EditProductForm error:",e),N(e.message||"Something went wrong")}finally{j(!1)}};return(0,s.jsxs)("form",{onSubmit:P,className:"bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg p-4 shadow-md",children:[s.jsx("h3",{className:"text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100",children:"Edit Product"}),k&&s.jsx("p",{className:"text-red-600 text-sm mb-3",children:k}),(0,s.jsxs)("div",{className:"mb-3",children:[(0,s.jsxs)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:["Product Usage / Workflow",s.jsx("span",{className:"text-red-500",children:"*"})]}),(0,s.jsxs)("select",{required:!0,value:p,onChange:e=>b(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[s.jsx("option",{value:"QUOTATION_FOCUSED",children:"Quotation Specific"}),s.jsx("option",{value:"ORDER_FOCUSED",children:"Order Specific"}),s.jsx("option",{value:"HYBRID",children:"Hybrid (for both)"})]})]}),(0,s.jsxs)("div",{className:"mb-3",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Name"}),s.jsx("input",{type:"text",required:!0,value:l,onChange:e=>d(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-3",children:[(0,s.jsxs)("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Price (₹)"}),s.jsx("input",{type:"number",required:!0,value:i,onChange:e=>n(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,s.jsxs)("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Stock Quantity"}),s.jsx("input",{type:"number",value:x,onChange:e=>g(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),(0,s.jsxs)("div",{className:"mb-3",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Description"}),s.jsx("textarea",{value:o,onChange:e=>c(e.target.value),rows:3,className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),v.length>0&&(0,s.jsxs)("div",{className:"mb-3",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Existing Images"}),s.jsx("div",{className:"mt-2 grid grid-cols-3 gap-2",children:v.map(e=>(0,s.jsxs)("div",{className:"relative",children:[s.jsx("img",{src:e.url,alt:"product",className:"h-24 w-full object-cover rounded-md border dark:border-gray-600"}),s.jsx("button",{type:"button",onClick:()=>A(e.id),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 text-xs",children:"✕"})]},e.id))})]}),s.jsx(ez,{label:"Add New Images",initialImages:E,onChange:S}),(0,s.jsxs)("div",{className:"mb-3",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Category"}),s.jsx("input",{type:"text",value:u,onChange:e=>m(e.target.value),className:"mt-1 w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),(0,s.jsxs)("div",{className:"mb-4 flex items-center",children:[s.jsx("input",{type:"checkbox",checked:h,onChange:e=>y(e.target.checked),className:"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),s.jsx("label",{className:"ml-2 block text-sm text-gray-700 dark:text-gray-300",children:"In Stock"})]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-2",children:[s.jsx("button",{type:"button",onClick:a,className:"px-4 py-2 text-sm border dark:border-gray-600 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:f,className:"px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50",children:f?"Saving...":"Save Changes"})]})]})}let eU=({quotation:e,onClose:t,onSend:a,isSending:r,error:l})=>e?s.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col",children:[(0,s.jsxs)("header",{className:"p-4 border-b dark:border-gray-700 flex justify-between items-center",children:[s.jsx("h2",{className:"font-bold text-lg text-gray-800 dark:text-gray-100",children:"Quotation Preview"}),s.jsx("button",{onClick:t,children:s.jsx(p.Z,{})})]}),(0,s.jsxs)("main",{className:"p-6 overflow-y-auto",children:[(0,s.jsxs)("div",{className:"flex justify-between mb-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("p",{children:[s.jsx("strong",{children:"To:"})," ",e.customerName]}),(0,s.jsxs)("p",{children:[s.jsx("strong",{children:"Phone:"})," ",e.contactNumber]})]}),s.jsx("div",{children:(0,s.jsxs)("p",{children:[s.jsx("strong",{children:"Date:"})," ",new Date(e.createdAt).toLocaleDateString()]})})]}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-4 text-sm",children:[(0,s.jsxs)("div",{children:[s.jsx("h4",{className:"font-semibold text-gray-500 dark:text-gray-400",children:"Billing Address"}),s.jsx("p",{className:"whitespace-pre-wrap text-gray-700 dark:text-gray-300",children:e.billingAddress})]}),(0,s.jsxs)("div",{children:[s.jsx("h4",{className:"font-semibold text-gray-500 dark:text-gray-400",children:"Shipping Address"}),s.jsx("p",{className:"whitespace-pre-wrap text-gray-700 dark:text-gray-300",children:e.shippingAddress})]})]}),(0,s.jsxs)("table",{className:"w-full text-sm text-left",children:[s.jsx("thead",{className:"bg-gray-100 dark:bg-gray-700",children:(0,s.jsxs)("tr",{children:[s.jsx("th",{className:"p-2",children:"Product"}),s.jsx("th",{className:"p-2 text-center",children:"Qty"}),s.jsx("th",{className:"p-2 text-right",children:"Price"}),s.jsx("th",{className:"p-2 text-right",children:"Subtotal"})]})}),s.jsx("tbody",{children:e.items.map(e=>(0,s.jsxs)("tr",{className:"border-b dark:border-gray-600",children:[s.jsx("td",{className:"p-2",children:e.product?.name}),s.jsx("td",{className:"p-2 text-center",children:e.quantity}),(0,s.jsxs)("td",{className:"p-2 text-right",children:["₹",e.price.toFixed(2)]}),(0,s.jsxs)("td",{className:"p-2 text-right",children:["₹",(e.price*e.quantity).toFixed(2)]})]},e.id))})]}),(0,s.jsxs)("div",{className:"mt-4 text-right",children:[(0,s.jsxs)("p",{children:[s.jsx("strong",{children:"Subtotal:"})," ₹",e.subtotal.toFixed(2)]}),(0,s.jsxs)("p",{className:"font-bold text-xl",children:[s.jsx("strong",{children:"Total:"})," ₹",e.total.toFixed(2)]})]})]}),(0,s.jsxs)("footer",{className:"p-4 border-t dark:border-gray-700 flex flex-col",children:[l&&(0,s.jsxs)("div",{className:"p-2 mb-2 bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-300 rounded-md text-sm flex items-center",children:[s.jsx(eS.Z,{size:16,className:"mr-2"}),l]}),(0,s.jsxs)("div",{className:"flex justify-end gap-2",children:[s.jsx("button",{onClick:t,className:"border dark:border-gray-600 rounded-md px-4 py-2 text-sm",children:"Cancel"}),s.jsx("button",{onClick:()=>a(e.id),className:"bg-green-600 text-white rounded-md px-4 py-2 text-sm flex items-center justify-center w-40",disabled:r,children:r?s.jsx(h.Z,{size:18,className:"animate-spin"}):(0,s.jsxs)(s.Fragment,{children:[s.jsx(v.Z,{size:16,className:"mr-2"}),"Send to Customer"]})})]})]})]})}):null;var eR=a(77109);let eB=({activeContact:e,messages:t,onShareProduct:a,initialViewId:l="main_menu",socket:d,newAddressForOrder:i,onClosePanel:n})=>{let{data:o}=(0,eR.useSession)(),[c,u]=(0,r.useState)(l),[g,y]=(0,r.useState)([]),[b,f]=(0,r.useState)(null),[j,k]=(0,r.useState)(null),[N,v]=(0,r.useState)(null),[w,D]=(0,r.useState)(null),[C,E]=(0,r.useState)(null),[S,A]=(0,r.useState)(!1),[P,T]=(0,r.useState)(null),[_,Z]=(0,r.useState)(0),[F,M]=(0,r.useState)(!1),[q,O]=(0,r.useState)(null),[z,$]=(0,r.useState)(null),[L,U]=(0,r.useState)(null),[R,B]=(0,r.useState)([]),[Q,H]=(0,r.useState)(!1),J=async()=>{try{U(null);let e=await fetch("/api/products");if(!e.ok)throw Error("Failed to fetch products");let t=(await e.json()).map(e=>({...e,imageUrl:e.images?.[0]?.url||"https://i.imgur.com/vJkrA4g.png"}));return y(t),t}catch(e){return console.error("Failed to fetch products:",e),U(e.message),[]}},V=async()=>{if(t&&0!==t.length){H(!0),B([]),U(null),u("products");try{let e=g.length>0?g:await J(),a=t.slice(-10).map(e=>`${"business"===e.from?"Business":"Customer"}: ${e.text||"[attachment]"}`).join("\n"),s=await fetch("/api/ai/suggest-products",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({history:a})});if(!s.ok){let e="Failed to get AI suggestions.";try{e=(await s.json()).error||e}catch(t){console.error("Server returned a non-JSON error response for AI suggestions."),e="An unexpected error occurred on the server. Please try again later."}throw Error(e)}let{query:r}=await s.json();if(r){let t=r.toLowerCase(),a=e.filter(e=>e.name.toLowerCase().includes(t)||e.description?.toLowerCase().includes(t)||e.category?.toLowerCase().includes(t));B(a),0===a.length&&U(`AI suggested searching for "${r}", but no products matched.`)}else U("AI couldn't determine a product suggestion from the chat.")}catch(e){U(e.message||"An error occurred while getting suggestions.")}finally{H(!1)}}};(0,r.useEffect)(()=>{l&&u(l)},[l]),(0,r.useEffect)(()=>{"products"!==c||0!==g.length||Q||J()},[c,Q,g.length]);let W=async()=>{if(z){U(null);try{let e=await fetch(`/api/products/${z.id}`,{method:"DELETE"});if(!e.ok){let t=await e.json();throw Error(t.error||"Failed to delete product.")}J(),$(null)}catch(e){U(e.message)}}},ea=()=>{U(null),B([]),"order_billing"===c||"new_order"===c||"order_summary"===c?u("order_history"):"billing"===c||"new_quotation"===c||"new_reminder"===c?u("quotations"):u("main_menu"),D(null)},es=()=>{u("main_menu")},er=e=>{u("quotations"),E(e),Z(e=>e+1)},ed=e=>{D(e),u("order_summary")},ei=async e=>{A(!0),T(null);try{let t=await fetch(`/api/quotations/${e}/send-as-image`,{method:"POST"});if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to send quotation image.")}E(null),Z(e=>e+1)}catch(e){T(e.message)}finally{A(!1)}};return(0,s.jsxs)("aside",{className:"w-full md:w-[30%] md:min-w-[350px] md:max-w-[450px] bg-white dark:bg-[var(--header-background)] border-l border-gray-200 dark:border-[var(--card-border)] flex flex-col flex-shrink-0",children:[(()=>{let e={main_menu:"Contact Actions",products:"Products",quotations:"Quotations",new_quotation:"New Quotation",new_reminder:"Set Follow-up Reminder",billing:`Bill for #${b?.id.substring(0,6)}`,master_customer_details:"Customer Details",order_history:"Orders",new_order:"New Order",order_summary:"Order Summary",order_billing:`Bill for #${N?.id.substring(0,6)}`};return(0,s.jsxs)("div",{className:"p-4 border-b border-gray-200 dark:border-[var(--card-border)] flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center",children:["main_menu"!==c&&s.jsx("button",{onClick:ea,className:"mr-3 p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700",children:s.jsx(G.Z,{size:20})}),s.jsx("h2",{className:"text-xl font-bold",children:e[c]})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:["products"===c&&(0,s.jsxs)("button",{onClick:()=>M(!0),className:"bg-blue-600 text-white px-3 py-1.5 rounded-md flex items-center text-sm font-semibold hover:bg-blue-700",children:[s.jsx(Y.Z,{size:16,className:"mr-1"})," Add New"]}),n&&s.jsx("button",{onClick:n,className:"p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 md:hidden",children:s.jsx(p.Z,{size:20})})]})]})})(),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[L&&s.jsx("div",{className:"p-4 m-2 bg-red-50 text-red-700 rounded-md text-sm",children:L}),(()=>{let t;if(!e)return s.jsx("p",{className:"p-4 text-center text-gray-500 dark:text-gray-400",children:"Please select a contact."});switch(c){case"products":t=(0,s.jsxs)("div",{children:[Q&&(0,s.jsxs)("div",{className:"p-4 text-center text-gray-500 dark:text-gray-400",children:[s.jsx(h.Z,{className:"animate-spin inline-block mr-2"}),"Analyzing chat for suggestions..."]}),R.length>0&&(0,s.jsxs)("div",{className:"p-2 border-b-2 border-dashed dark:border-gray-700",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-2 px-2",children:[s.jsx("h4",{className:"font-bold text-blue-600 dark:text-blue-400",children:"AI Suggestions"}),s.jsx("button",{onClick:()=>B([]),className:"text-xs text-gray-500 hover:underline",children:"Clear"})]}),s.jsx(el,{products:R,onShareProduct:a,onEditProduct:e=>O(e),onDeleteProduct:e=>$(e)})]}),s.jsx(el,{products:g,onShareProduct:a,onEditProduct:e=>O(e),onDeleteProduct:e=>$(e)})]});break;case"quotations":t=s.jsx(em,{contactId:e.id,onNewQuote:()=>u("new_quotation"),onBillQuote:e=>{f(e),u("billing")},onSendDraft:e=>E(e),onSetFollowUp:e=>{k(e),u("new_reminder")}},_);break;case"new_quotation":t=s.jsx(eb,{contact:e,onCancel:()=>u("quotations"),onQuotationCreated:er});break;case"new_reminder":if(!j)return null;t=s.jsx(ek,{quotation:j,onCancel:()=>u("quotations"),onSuccess:()=>u("quotations")});break;case"order_history":t=s.jsx(eE,{contactId:e.id,onNewOrder:()=>u("new_order"),onManagePayments:e=>{v(e),u("order_billing")}});break;case"new_order":t=s.jsx(ev,{contact:e,onCancel:()=>u("order_history"),onOrderCreated:ed,suggestedAddress:i});break;case"order_summary":if(!w)return null;t=s.jsx(eP,{order:w,onDone:ea});break;case"billing":if(!b)return null;t=s.jsx(ey,{quotation:b,onBack:()=>u("quotations"),onFinalized:()=>{},socket:d});break;case"order_billing":if(!N)return null;t=s.jsx(eT,{order:N,onBack:()=>u("order_history"),onFinalized:()=>{},socket:d});break;case"master_customer_details":t=s.jsx(eO,{contact:e,onPromoted:es});break;default:let r=o?.user?.primaryWorkflow,l="QUOTATION_FOCUSED"===r,n="ORDER_FOCUSED"===r,y=[{id:"orders",label:"Manage Orders",icon:s.jsx(K.Z,{className:`mr-3 ${l?"text-gray-400 dark:text-gray-500":"text-blue-600 dark:text-blue-400"}`}),action:()=>u("order_history"),disabled:l},{id:"quotations",label:"Manage Quotations",icon:s.jsx(X.Z,{className:`mr-3 ${n?"text-gray-400 dark:text-gray-500":"text-green-600 dark:text-green-400"}`}),action:()=>u("quotations"),disabled:n}];"QUOTATION_FOCUSED"===r&&y.reverse(),t=(0,s.jsxs)(m.E.div,{className:"p-4 space-y-3",children:[y.map(e=>(0,s.jsxs)(m.E.button,{onClick:e.action,disabled:e.disabled,className:`w-full flex items-center p-3 text-left rounded-lg transition-colors ${e.disabled?"bg-gray-100 dark:bg-gray-800/50 text-gray-400 dark:text-gray-500 cursor-not-allowed":"bg-gray-50 hover:bg-gray-100 dark:bg-[var(--input-background)] dark:hover:bg-gray-700"}`,title:e.disabled?`${e.label} (Disabled in this workspace)`:e.label,children:[e.icon," ",e.label]},e.id)),(0,s.jsxs)(m.E.button,{onClick:V,className:"w-full flex items-center p-3 text-left bg-gray-50 hover:bg-gray-100 dark:bg-[var(--input-background)] dark:hover:bg-gray-700 rounded-lg",children:[s.jsx(ee,{className:"mr-3 text-yellow-500 dark:text-yellow-400"})," Suggest Products"]}),(0,s.jsxs)(m.E.button,{onClick:()=>u("products"),className:"w-full flex items-center p-3 text-left bg-gray-50 hover:bg-gray-100 dark:bg-[var(--input-background)] dark:hover:bg-gray-700 rounded-lg",children:[s.jsx(K.Z,{className:"mr-3 text-orange-600 dark:text-orange-400"})," Share Product"]}),(0,s.jsxs)(m.E.button,{onClick:()=>u("master_customer_details"),className:"w-full flex items-center p-3 text-left bg-gray-50 hover:bg-gray-100 dark:bg-[var(--input-background)] dark:hover:bg-gray-700 rounded-lg",children:[s.jsx(et,{className:"mr-3 text-purple-600 dark:text-purple-400"})," Customer Details"]})]})}return s.jsx(x.M,{mode:"wait",children:s.jsx(m.E.div,{children:t},c)})})()]}),s.jsx(I.Z,{isOpen:F,onClose:()=>M(!1),title:"Add New Product",children:s.jsx(e$,{onSuccess:()=>{M(!1),J()},onCancel:()=>M(!1)})}),q&&s.jsx(I.Z,{isOpen:!!q,onClose:()=>O(null),title:"Edit Product",children:s.jsx(eL,{product:q,onSuccess:()=>{O(null),J()},onCancel:()=>O(null)})}),z&&(0,s.jsxs)(I.Z,{isOpen:!!z,onClose:()=>$(null),title:"Confirm Deletion",children:[(0,s.jsxs)("p",{children:["Are you sure you want to delete the product: ",s.jsx("strong",{children:z.name}),"?"]}),(0,s.jsxs)("div",{className:"flex justify-end space-x-2 mt-4",children:[s.jsx("button",{onClick:()=>$(null),className:"px-4 py-2 border rounded-md",children:"Cancel"}),s.jsx("button",{onClick:W,className:"px-4 py-2 bg-red-600 text-white rounded-md",children:"Delete"})]})]}),C&&s.jsx(eU,{quotation:C,onClose:()=>{E(null),T(null)},onSend:ei,isSending:S,error:P})]})};a(49296);let eQ=()=>(0,s.jsxs)("div",{className:"w-full flex flex-col h-full",children:[(0,s.jsxs)("div",{className:"p-4 border-b dark:border-[var(--card-border)] flex items-center",children:[s.jsx(n.Z,{className:"w-10 h-10 rounded-full mr-3"}),(0,s.jsxs)("div",{className:"flex-1",children:[s.jsx(n.Z,{className:"h-5 w-1/3 mb-1"}),s.jsx(n.Z,{className:"h-3 w-1/4"})]})]}),(0,s.jsxs)("div",{className:"flex-1 p-4 space-y-4",children:[(0,s.jsxs)("div",{className:"flex justify-start",children:[" ",s.jsx(n.Z,{className:"h-10 w-2/5 rounded-lg"})," "]}),(0,s.jsxs)("div",{className:"flex justify-end",children:[" ",s.jsx(n.Z,{className:"h-16 w-3/5 rounded-lg"})," "]}),(0,s.jsxs)("div",{className:"flex justify-start",children:[" ",s.jsx(n.Z,{className:"h-8 w-1/3 rounded-lg"})," "]}),(0,s.jsxs)("div",{className:"flex justify-end",children:[" ",s.jsx(n.Z,{className:"h-12 w-1/2 rounded-lg"})," "]})]}),s.jsx("div",{className:"p-4 border-t dark:border-[var(--card-border)]",children:s.jsx(n.Z,{className:"h-12 w-full rounded-full"})})]}),eH=()=>(0,s.jsxs)("div",{className:"flex h-screen overflow-hidden",children:[(0,s.jsxs)("div",{className:"w-80 border-r dark:border-[var(--card-border)] flex flex-col",children:[(0,s.jsxs)("div",{className:"p-4 border-b dark:border-[var(--card-border)]",children:[s.jsx(n.Z,{className:"h-6 w-1/3 mb-4"}),s.jsx(n.Z,{className:"h-9 w-full rounded-md"})]}),s.jsx(c,{})]}),s.jsx("div",{className:"flex-1 flex flex-col",children:s.jsx(eQ,{})})]});function eJ(){let e=(0,l.useSearchParams)();e.get("contactId"),e.get("message");let[t,a]=(0,r.useState)([]),[d,i]=(0,r.useState)(null),[n,o]=(0,r.useState)(null),[c,u]=(0,r.useState)([]),[m,x]=(0,r.useState)(null),[g,h]=(0,r.useState)(null),[y,p]=(0,r.useState)(0),[b,f]=(0,r.useState)("main_menu"),[j,k]=(0,r.useState)(!1),[N,v]=(0,r.useState)(!1),[w,D]=(0,r.useState)(null),C=async e=>{d&&(u(t=>[...t,{id:`temp-${Date.now()}`,from:"business",to:d.phone,type:"product",text:`Sharing ${e.name}...`,createdAt:new Date().toISOString(),contactId:d.id,status:"pending",product:e}]),await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contactId:d.id,type:"product",productId:e.id})}))},E=async()=>{if(!d)return;D(null),f("new_order"),p(e=>e+1),k(!0);let e="";e=d.lastShippingAddress?`Hi ${d.name}, we're creating a new order for you. Should we use your last known address for delivery?

${d.lastShippingAddress}

Please reply with 'Yes' to confirm, or provide a new address.`:`Hi ${d.name}, we're creating a new order for you. What is the delivery address?`,v(!0),await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contactId:d.id,text:e})})};return(0,s.jsxs)("div",{className:"flex h-screen overflow-hidden",children:[s.jsx("div",{className:`flex-1 ${j?"hidden":"flex"} md:flex flex-col`,children:s.jsx(W,{socket:n,contacts:t,setContacts:a,activeContact:d,onSelectContact:e=>{d?.id!==e?.id&&(i(e),f("main_menu"),p(e=>e+1),x(null))},onPromoteCustomer:()=>{f("master_customer_details"),p(e=>e+1),k(!0)},messages:c,setMessages:u,initialMessage:m,initialCursor:g,onCreateOrder:E,onShowPanel:()=>k(!0)})}),d&&s.jsx("div",{className:`${j?"flex":"hidden"} md:flex w-full md:w-auto flex-col h-full`,children:s.jsx(eB,{activeContact:d,messages:c,onShareProduct:C,initialViewId:b,socket:n,newAddressForOrder:w,onClosePanel:()=>k(!1)},y)})]})}function eV(){return s.jsx(r.Suspense,{fallback:s.jsx(eH,{}),children:s.jsx(eJ,{})})}},24422:(e,t,a)=>{"use strict";a.d(t,{Z:()=>l});var s=a(10326);a(17577);let r={PENDING:{label:"Pending",className:"bg-yellow-100 text-yellow-800"},CONFIRMED:{label:"Confirmed",className:"bg-blue-100 text-blue-700"},SHIPPED:{label:"Shipped",className:"bg-indigo-100 text-indigo-700"},DELIVERED:{label:"Delivered",className:"bg-green-100 text-green-700"},CANCELLED:{label:"Cancelled",className:"bg-red-100 text-red-700"}},l=({status:e})=>{let t=r[e]||{label:"Unknown",className:"bg-gray-100 text-gray-700"};return s.jsx("span",{className:`px-2.5 py-1 text-xs font-semibold rounded-full inline-block ${t.className}`,children:t.label})}},28676:(e,t,a)=>{"use strict";a.d(t,{Z:()=>r});var s=a(10326);a(17577);let r=({isOpen:e,onClose:t,title:a,children:r})=>e?s.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50",onClick:t,children:(0,s.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md m-4",onClick:e=>e.stopPropagation(),children:[(0,s.jsxs)("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center",children:[s.jsx("h2",{className:"text-lg font-semibold text-gray-800 dark:text-gray-100",children:a}),s.jsx("button",{onClick:t,className:"text-gray-500 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100",children:"\xd7"})]}),s.jsx("div",{className:"p-4",children:r})]})}):null},17334:(e,t,a)=>{"use strict";a.d(t,{Z:()=>r});var s=a(10326);a(17577);let r=({className:e,...t})=>s.jsx("div",{className:function(...e){return e.filter(Boolean).join(" ")}("animate-pulse rounded-md bg-gray-200 dark:bg-gray-700",e),...t})},49296:(e,t,a)=>{"use strict";a(87432)},34356:(e,t,a)=>{"use strict";a.r(t),a.d(t,{$$typeof:()=>d,__esModule:()=>l,default:()=>i});var s=a(68570);let r=(0,s.createProxy)(String.raw`C:\vyaparconnect-crm\src\app\chat\page.tsx`),{__esModule:l,$$typeof:d}=r;r.default;let i=(0,s.createProxy)(String.raw`C:\vyaparconnect-crm\src\app\chat\page.tsx#default`)},92977:(e,t,a)=>{"use strict";a.d(t,{E:()=>l});var s=a(71271),r=a(99276);function l(e,t){let a=(0,s.Q)(e);return isNaN(t)?(0,r.L)(e,NaN):(t&&a.setDate(a.getDate()+t),a)}}};var t=require("../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[8948,737,7344,5804,3686,7432,9393],()=>a(27269));module.exports=s})();